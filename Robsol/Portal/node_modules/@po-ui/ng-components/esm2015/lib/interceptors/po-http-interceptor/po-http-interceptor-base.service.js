import { HttpResponse } from '@angular/common/http';
import { tap } from 'rxjs/operators';
import { PoHttpInterceptorDetailComponent } from './po-http-interceptor-detail/po-http-interceptor-detail.component';
import { poHttpInterceptorLiterals } from './po-http-interceptor-literals';
const NO_ERROR_HEADER_PARAM = 'X-PO-No-Error';
const NO_MESSAGE_HEADER_PARAM = 'X-PO-No-Message';
/**
 * @description
 *
 * O *interceptor* tem a finalidade de exibir notificações com mensagens na tela, baseado nas respostas das requisições HTTP.
 *
 * Pode ser utilizado para dar feedback das ações do usuário como, por exemplo: erro de autorização, mensagens de regras de negócio,
 * atualizações de registros, erro quando o servidor estiver indisponível e entre outros.
 *
 * ## Configuração
 *
 * Para o correto funcionamento do interceptor `po-http-interceptor`, deve ser importado o `BrowserAnimationsModule` no
 * módulo principal da sua aplicação.
 *
 * Módulo da aplicação:
 * ```
 * import { BrowserAnimationsModule } from '@angular/platform-browser/animations';
 * import { PoModule } from '@po-ui/ng-components';
 * ...
 *
 * @NgModule({
 *   imports: [
 *     BrowserModule,
 *     BrowserAnimationsModule,
 *     ...
 *     PoModule
 *   ],
 *   declarations: [
 *     AppComponent,
 *     ...
 *   ],
 *   providers: [],
 *   bootstrap: [AppComponent]
 * })
 * export class AppModule { }
 * ```
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 * Ao realizar requisições utilize o `HttpClient`, conforme exemplo abaixo:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class UserService {
 *
 *   constructor(private http: HttpClient) { }
 *
 *   getUsers() {
 *     return this.http.get('/api/users');
 *   }
 *
 *   ...
 *
 * }
 * ```
 *
 * ## Como usar
 *
 * Para exibir as noticações é necessário informar a mensagem no retorno da requisição. A estrutura da mensagem
 * é feita com base no status da resposta, conforme será apresentado nos próximos tópicos.
 *
 * ### Estrutura das mensagens
 *
 * #### Mensagens de sucesso `2xx`
 *
 * Para exibir mensagens ao retornar uma lista ou um item, deve-se incluir a propriedade `_messages` no objeto de retorno.
 * Por exemplo:
 * ```
 * {
 *   "_messages": [
 *     {
 *       "type": "success" || "warning" || "error" || "information" (será exibido a `tag` apenas se esta propriedade possuir valor),
 *       "code": "título ou código da mensagem",
 *       "message": "texto da mensagem",
 *       "detailedMessage": "detalhamento da mensagem"
 *     }
 *   ]
 * }
 * ```
 *
 * #### Mensagens de erro `4xx` ou `5xx`
 *
 * Ao retornar erro, o objeto não necessita ter `_messages`, deve-se retornar o objeto diretamente:
 *
 * ```
 * {
 *    "code": "título ou código da mensagem",
 *    "message": "texto da mensagem",
 *    "detailedMessage": "detalhamento da mensagem"
 * }
 * ```
 *
 * Também é possível informar as seguintes propriedades:
 *
 * - `helpUrl`: link para a documentação do erro;
 *    - Caso for informado, será exibido uma ação de "Ajuda" na notificação, para isso não deverá ter a propriedade `detailedMessage`.
 * - `type`: É possível informar `error`, `warning` e `information`, sendo `error` o valor padrão.
 * - `details`: Uma lista de objetos de mensagem (recursiva) com mais detalhes sobre a mensagem principal.
 * - `detailTitle`: caso for informado, será apresentado como título dos detalhes substituindo o padrão `code - message`
 *
 * > Veja o [Guia de implementação de APIs](guides/api) para mais detalhes sobre a estrutura das mensagens.
 *
 * ### Cabeçalho
 *
 * É possível dispensar a notificação para o usuário utilizando no cabeçalho da requisição os parâmetros listados abaixo com o valor
 * igual a `true`:
 *
 * - `X-PO-No-Message`: Não exibe notificações de erro e/ou sucesso.
 *
 * - `X-PO-No-Error`: Não mostra notificações de erro com códigos `4xx` e `5xx`.
 *
 * ```
 * ...
 *  const headers = { 'X-PO-No-Message': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 *
 * > Após a validação no *interceptor*, os parâmetros serão removidos do cabeçalho da requisição.
 *
 */
export class PoHttpInterceptorBaseService {
    constructor(componentInjector, notification, languageService) {
        this.componentInjector = componentInjector;
        this.notification = notification;
        this.languageService = languageService;
        this.notificationTypes = ['success', 'warning', 'error', 'information'];
        this.literals = poHttpInterceptorLiterals[this.languageService.getShortLanguage()];
        this.httpInterceptorDetailComponent = undefined;
    }
    intercept(request, next) {
        const cloneRequest = request.clone();
        request = request && this.hasParameters(request) ? this.cloneRequestWithoutParameters(request) : request;
        return next.handle(request).pipe(tap((response) => {
            if (response instanceof HttpResponse) {
                this.processResponse(response, cloneRequest);
            }
        }, (error) => {
            this.processErrorResponse(error, cloneRequest);
        }));
    }
    processResponse(response, request) {
        const hasNoMessageParam = this.hasNoMessageParam(request);
        if (!hasNoMessageParam && response.body && response.body._messages) {
            const messages = response.body._messages;
            if (messages instanceof Array) {
                messages.forEach((message) => {
                    this.showNotification(message);
                });
            }
            else {
                this.showNotification(messages);
            }
        }
    }
    processErrorResponse(response, request) {
        const errorResponse = response.status !== 0
            ? response.error
            : { code: 0, message: this.literals.serverNotResponse, detailedMessage: response.message };
        const hasNoErrorParam = this.hasNoErrorParam(request);
        const hasNoMessageParam = this.hasNoMessageParam(request);
        const errorResponseValidTypes = this.notificationTypes.slice(1);
        if (errorResponse && errorResponse.message && !hasNoErrorParam && !hasNoMessageParam) {
            this.showNotification(Object.assign(Object.assign({}, errorResponse), { type: errorResponseValidTypes.includes(errorResponse.type) ? errorResponse.type : 'error' }));
        }
    }
    cloneRequestWithoutParameters(request) {
        const headers = request.headers.delete(NO_ERROR_HEADER_PARAM).delete(NO_MESSAGE_HEADER_PARAM);
        return request.clone({ headers });
    }
    createModal(responseMessage) {
        const details = responseMessage.details ? [responseMessage, ...responseMessage.details] : [responseMessage];
        this.httpInterceptorDetailComponent = this.componentInjector.createComponentInApplication(PoHttpInterceptorDetailComponent);
        this.httpInterceptorDetailComponent.instance.detail = details;
        this.httpInterceptorDetailComponent.instance.closed.subscribe(() => this.destroyModal());
        this.httpInterceptorDetailComponent.instance.open();
    }
    destroyModal() {
        if (this.httpInterceptorDetailComponent) {
            this.componentInjector.destroyComponentInApplication(this.httpInterceptorDetailComponent);
            this.httpInterceptorDetailComponent = undefined;
        }
    }
    hasMessage(responseMessage) {
        const hasMessageProperties = responseMessage.message;
        return responseMessage && hasMessageProperties;
    }
    hasNoErrorParam(request) {
        const noErrorParam = request && request.headers.get(NO_ERROR_HEADER_PARAM);
        return noErrorParam && noErrorParam.toString().toLocaleLowerCase() === 'true';
    }
    hasNoMessageParam(request) {
        const noMessageParam = request && request.headers.get(NO_MESSAGE_HEADER_PARAM);
        return noMessageParam && noMessageParam.toString().toLocaleLowerCase() === 'true';
    }
    hasParameters(request) {
        return request.headers.has(NO_ERROR_HEADER_PARAM) || request.headers.has(NO_MESSAGE_HEADER_PARAM);
    }
    showNotification(response) {
        if (!this.hasMessage(response)) {
            return;
        }
        const typeNotification = this.notificationTypes.includes(response.type) ? response.type : 'information';
        const notificationAction = this.generateNotificationAction(response);
        this.notification[typeNotification]({
            message: response.message,
            actionLabel: notificationAction.label,
            action: notificationAction.action
        });
    }
    generateDetailModal(responseMessage) {
        return () => {
            if (!this.httpInterceptorDetailComponent) {
                this.createModal(responseMessage);
            }
        };
    }
    generateNotificationAction(responseMessage) {
        let notificationAction;
        let notificationLabel;
        if (responseMessage.helpUrl && !(responseMessage.detailedMessage || responseMessage.details)) {
            notificationLabel = this.literals.help;
            notificationAction = this.generateUrlHelpFunction(responseMessage.helpUrl);
        }
        else if (responseMessage.detailedMessage || responseMessage.details) {
            notificationLabel = this.literals.details;
            notificationAction = this.generateDetailModal(responseMessage);
        }
        return { label: notificationLabel, action: notificationAction };
    }
    generateUrlHelpFunction(helpUrl) {
        return () => {
            window.open(helpUrl, '_blank');
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1pbnRlcmNlcHRvci1iYXNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2ludGVyY2VwdG9ycy9wby1odHRwLWludGVyY2VwdG9yL3BvLWh0dHAtaW50ZXJjZXB0b3ItYmFzZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFJTCxZQUFZLEVBR2IsTUFBTSxzQkFBc0IsQ0FBQztBQUc5QixPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJckMsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0sbUVBQW1FLENBQUM7QUFDckgsT0FBTyxFQUFFLHlCQUF5QixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFHM0UsTUFBTSxxQkFBcUIsR0FBRyxlQUFlLENBQUM7QUFDOUMsTUFBTSx1QkFBdUIsR0FBRyxpQkFBaUIsQ0FBQztBQUVsRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBOEhHO0FBQ0gsTUFBTSxPQUFnQiw0QkFBNEI7SUFPaEQsWUFDVSxpQkFBNkMsRUFDN0MsWUFBaUIsRUFDakIsZUFBa0M7UUFGbEMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUE0QjtRQUM3QyxpQkFBWSxHQUFaLFlBQVksQ0FBSztRQUNqQixvQkFBZSxHQUFmLGVBQWUsQ0FBbUI7UUFUNUMsc0JBQWlCLEdBQUcsQ0FBQyxTQUFTLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUMsQ0FBQztRQUVuRSxhQUFRLEdBQUcseUJBQXlCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7UUFFdEUsbUNBQThC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LGVBQWUsQ0FBQyxDQUFDO2FBQ25DO1FBQ0gsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVPLDBCQUEwQixDQUFDLGVBQW9CO1FBQ3JELElBQUksa0JBQWtCLENBQUM7UUFDdkIsSUFBSSxpQkFBaUIsQ0FBQztRQUV0QixJQUFJLGVBQWUsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLGVBQWUsQ0FBQyxlQUFlLElBQUksZUFBZSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1lBQzVGLGlCQUFpQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1lBQ3ZDLGtCQUFrQixHQUFHLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDNUU7YUFBTSxJQUFJLGVBQWUsQ0FBQyxlQUFlLElBQUksZUFBZSxDQUFDLE9BQU8sRUFBRTtZQUNyRSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQztZQUMxQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsZUFBZSxDQUFDLENBQUM7U0FDaEU7UUFDRCxPQUFPLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxDQUFDO0lBQ2xFLENBQUM7SUFFTyx1QkFBdUIsQ0FBQyxPQUFlO1FBQzdDLE9BQU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDakMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgSHR0cEludGVyY2VwdG9yLFxyXG4gIEh0dHBIYW5kbGVyLFxyXG4gIEh0dHBSZXF1ZXN0LFxyXG4gIEh0dHBSZXNwb25zZSxcclxuICBIdHRwRXZlbnQsXHJcbiAgSHR0cEVycm9yUmVzcG9uc2VcclxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcblxyXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IFBvQ29tcG9uZW50SW5qZWN0b3JTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcG8tY29tcG9uZW50LWluamVjdG9yL3BvLWNvbXBvbmVudC1pbmplY3Rvci5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWwgfSBmcm9tICcuL3BvLWh0dHAtaW50ZXJjZXB0b3ItZGV0YWlsL3BvLWh0dHAtaW50ZXJjZXB0b3ItZGV0YWlsLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50IH0gZnJvbSAnLi9wby1odHRwLWludGVyY2VwdG9yLWRldGFpbC9wby1odHRwLWludGVyY2VwdG9yLWRldGFpbC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBwb0h0dHBJbnRlcmNlcHRvckxpdGVyYWxzIH0gZnJvbSAnLi9wby1odHRwLWludGVyY2VwdG9yLWxpdGVyYWxzJztcclxuaW1wb3J0IHsgUG9MYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wby1sYW5ndWFnZS9wby1sYW5ndWFnZS5zZXJ2aWNlJztcclxuXHJcbmNvbnN0IE5PX0VSUk9SX0hFQURFUl9QQVJBTSA9ICdYLVBPLU5vLUVycm9yJztcclxuY29uc3QgTk9fTUVTU0FHRV9IRUFERVJfUEFSQU0gPSAnWC1QTy1Oby1NZXNzYWdlJztcclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICpcclxuICogTyAqaW50ZXJjZXB0b3IqIHRlbSBhIGZpbmFsaWRhZGUgZGUgZXhpYmlyIG5vdGlmaWNhw6fDtWVzIGNvbSBtZW5zYWdlbnMgbmEgdGVsYSwgYmFzZWFkbyBuYXMgcmVzcG9zdGFzIGRhcyByZXF1aXNpw6fDtWVzIEhUVFAuXHJcbiAqXHJcbiAqIFBvZGUgc2VyIHV0aWxpemFkbyBwYXJhIGRhciBmZWVkYmFjayBkYXMgYcOnw7VlcyBkbyB1c3XDoXJpbyBjb21vLCBwb3IgZXhlbXBsbzogZXJybyBkZSBhdXRvcml6YcOnw6NvLCBtZW5zYWdlbnMgZGUgcmVncmFzIGRlIG5lZ8OzY2lvLFxyXG4gKiBhdHVhbGl6YcOnw7VlcyBkZSByZWdpc3Ryb3MsIGVycm8gcXVhbmRvIG8gc2Vydmlkb3IgZXN0aXZlciBpbmRpc3BvbsOtdmVsIGUgZW50cmUgb3V0cm9zLlxyXG4gKlxyXG4gKiAjIyBDb25maWd1cmHDp8Ojb1xyXG4gKlxyXG4gKiBQYXJhIG8gY29ycmV0byBmdW5jaW9uYW1lbnRvIGRvIGludGVyY2VwdG9yIGBwby1odHRwLWludGVyY2VwdG9yYCwgZGV2ZSBzZXIgaW1wb3J0YWRvIG8gYEJyb3dzZXJBbmltYXRpb25zTW9kdWxlYCBub1xyXG4gKiBtw7NkdWxvIHByaW5jaXBhbCBkYSBzdWEgYXBsaWNhw6fDo28uXHJcbiAqXHJcbiAqIE3Ds2R1bG8gZGEgYXBsaWNhw6fDo286XHJcbiAqIGBgYFxyXG4gKiBpbXBvcnQgeyBCcm93c2VyQW5pbWF0aW9uc01vZHVsZSB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXIvYW5pbWF0aW9ucyc7XHJcbiAqIGltcG9ydCB7IFBvTW9kdWxlIH0gZnJvbSAnQHBvLXVpL25nLWNvbXBvbmVudHMnO1xyXG4gKiAuLi5cclxuICpcclxuICogQE5nTW9kdWxlKHtcclxuICogICBpbXBvcnRzOiBbXHJcbiAqICAgICBCcm93c2VyTW9kdWxlLFxyXG4gKiAgICAgQnJvd3NlckFuaW1hdGlvbnNNb2R1bGUsXHJcbiAqICAgICAuLi5cclxuICogICAgIFBvTW9kdWxlXHJcbiAqICAgXSxcclxuICogICBkZWNsYXJhdGlvbnM6IFtcclxuICogICAgIEFwcENvbXBvbmVudCxcclxuICogICAgIC4uLlxyXG4gKiAgIF0sXHJcbiAqICAgcHJvdmlkZXJzOiBbXSxcclxuICogICBib290c3RyYXA6IFtBcHBDb21wb25lbnRdXHJcbiAqIH0pXHJcbiAqIGV4cG9ydCBjbGFzcyBBcHBNb2R1bGUgeyB9XHJcbiAqIGBgYFxyXG4gKlxyXG4gKiBBbyBpbXBvcnRhciBvIG3Ds2R1bG8gYFBvTW9kdWxlYCBuYSBhcGxpY2HDp8OjbywgbyBgcG8taHR0cC1pbnRlcmNlcHRvcmAgw6kgYXV0b21hdGljYW1lbnRlIGNvbmZpZ3VyYWRvIHNlbSBhIG5lY2Vzc2lkYWRlXHJcbiAqIGRlIHF1YWxxdWVyIGNvbmZpZ3VyYcOnw6NvIGV4dHJhLlxyXG4gKlxyXG4gKiBBbyByZWFsaXphciByZXF1aXNpw6fDtWVzIHV0aWxpemUgbyBgSHR0cENsaWVudGAsIGNvbmZvcm1lIGV4ZW1wbG8gYWJhaXhvOlxyXG4gKlxyXG4gKiBgYGBcclxuICogaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuICpcclxuICogLi4uXHJcbiAqXHJcbiAqIEBJbmplY3RhYmxlKClcclxuICogZXhwb3J0IGNsYXNzIFVzZXJTZXJ2aWNlIHtcclxuICpcclxuICogICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQpIHsgfVxyXG4gKlxyXG4gKiAgIGdldFVzZXJzKCkge1xyXG4gKiAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoJy9hcGkvdXNlcnMnKTtcclxuICogICB9XHJcbiAqXHJcbiAqICAgLi4uXHJcbiAqXHJcbiAqIH1cclxuICogYGBgXHJcbiAqXHJcbiAqICMjIENvbW8gdXNhclxyXG4gKlxyXG4gKiBQYXJhIGV4aWJpciBhcyBub3RpY2HDp8O1ZXMgw6kgbmVjZXNzw6FyaW8gaW5mb3JtYXIgYSBtZW5zYWdlbSBubyByZXRvcm5vIGRhIHJlcXVpc2nDp8Ojby4gQSBlc3RydXR1cmEgZGEgbWVuc2FnZW1cclxuICogw6kgZmVpdGEgY29tIGJhc2Ugbm8gc3RhdHVzIGRhIHJlc3Bvc3RhLCBjb25mb3JtZSBzZXLDoSBhcHJlc2VudGFkbyBub3MgcHLDs3hpbW9zIHTDs3BpY29zLlxyXG4gKlxyXG4gKiAjIyMgRXN0cnV0dXJhIGRhcyBtZW5zYWdlbnNcclxuICpcclxuICogIyMjIyBNZW5zYWdlbnMgZGUgc3VjZXNzbyBgMnh4YFxyXG4gKlxyXG4gKiBQYXJhIGV4aWJpciBtZW5zYWdlbnMgYW8gcmV0b3JuYXIgdW1hIGxpc3RhIG91IHVtIGl0ZW0sIGRldmUtc2UgaW5jbHVpciBhIHByb3ByaWVkYWRlIGBfbWVzc2FnZXNgIG5vIG9iamV0byBkZSByZXRvcm5vLlxyXG4gKiBQb3IgZXhlbXBsbzpcclxuICogYGBgXHJcbiAqIHtcclxuICogICBcIl9tZXNzYWdlc1wiOiBbXHJcbiAqICAgICB7XHJcbiAqICAgICAgIFwidHlwZVwiOiBcInN1Y2Nlc3NcIiB8fCBcIndhcm5pbmdcIiB8fCBcImVycm9yXCIgfHwgXCJpbmZvcm1hdGlvblwiIChzZXLDoSBleGliaWRvIGEgYHRhZ2AgYXBlbmFzIHNlIGVzdGEgcHJvcHJpZWRhZGUgcG9zc3VpciB2YWxvciksXHJcbiAqICAgICAgIFwiY29kZVwiOiBcInTDrXR1bG8gb3UgY8OzZGlnbyBkYSBtZW5zYWdlbVwiLFxyXG4gKiAgICAgICBcIm1lc3NhZ2VcIjogXCJ0ZXh0byBkYSBtZW5zYWdlbVwiLFxyXG4gKiAgICAgICBcImRldGFpbGVkTWVzc2FnZVwiOiBcImRldGFsaGFtZW50byBkYSBtZW5zYWdlbVwiXHJcbiAqICAgICB9XHJcbiAqICAgXVxyXG4gKiB9XHJcbiAqIGBgYFxyXG4gKlxyXG4gKiAjIyMjIE1lbnNhZ2VucyBkZSBlcnJvIGA0eHhgIG91IGA1eHhgXHJcbiAqXHJcbiAqIEFvIHJldG9ybmFyIGVycm8sIG8gb2JqZXRvIG7Do28gbmVjZXNzaXRhIHRlciBgX21lc3NhZ2VzYCwgZGV2ZS1zZSByZXRvcm5hciBvIG9iamV0byBkaXJldGFtZW50ZTpcclxuICpcclxuICogYGBgXHJcbiAqIHtcclxuICogICAgXCJjb2RlXCI6IFwidMOtdHVsbyBvdSBjw7NkaWdvIGRhIG1lbnNhZ2VtXCIsXHJcbiAqICAgIFwibWVzc2FnZVwiOiBcInRleHRvIGRhIG1lbnNhZ2VtXCIsXHJcbiAqICAgIFwiZGV0YWlsZWRNZXNzYWdlXCI6IFwiZGV0YWxoYW1lbnRvIGRhIG1lbnNhZ2VtXCJcclxuICogfVxyXG4gKiBgYGBcclxuICpcclxuICogVGFtYsOpbSDDqSBwb3Nzw612ZWwgaW5mb3JtYXIgYXMgc2VndWludGVzIHByb3ByaWVkYWRlczpcclxuICpcclxuICogLSBgaGVscFVybGA6IGxpbmsgcGFyYSBhIGRvY3VtZW50YcOnw6NvIGRvIGVycm87XHJcbiAqICAgIC0gQ2FzbyBmb3IgaW5mb3JtYWRvLCBzZXLDoSBleGliaWRvIHVtYSBhw6fDo28gZGUgXCJBanVkYVwiIG5hIG5vdGlmaWNhw6fDo28sIHBhcmEgaXNzbyBuw6NvIGRldmVyw6EgdGVyIGEgcHJvcHJpZWRhZGUgYGRldGFpbGVkTWVzc2FnZWAuXHJcbiAqIC0gYHR5cGVgOiDDiSBwb3Nzw612ZWwgaW5mb3JtYXIgYGVycm9yYCwgYHdhcm5pbmdgIGUgYGluZm9ybWF0aW9uYCwgc2VuZG8gYGVycm9yYCBvIHZhbG9yIHBhZHLDo28uXHJcbiAqIC0gYGRldGFpbHNgOiBVbWEgbGlzdGEgZGUgb2JqZXRvcyBkZSBtZW5zYWdlbSAocmVjdXJzaXZhKSBjb20gbWFpcyBkZXRhbGhlcyBzb2JyZSBhIG1lbnNhZ2VtIHByaW5jaXBhbC5cclxuICogLSBgZGV0YWlsVGl0bGVgOiBjYXNvIGZvciBpbmZvcm1hZG8sIHNlcsOhIGFwcmVzZW50YWRvIGNvbW8gdMOtdHVsbyBkb3MgZGV0YWxoZXMgc3Vic3RpdHVpbmRvIG8gcGFkcsOjbyBgY29kZSAtIG1lc3NhZ2VgXHJcbiAqXHJcbiAqID4gVmVqYSBvIFtHdWlhIGRlIGltcGxlbWVudGHDp8OjbyBkZSBBUElzXShndWlkZXMvYXBpKSBwYXJhIG1haXMgZGV0YWxoZXMgc29icmUgYSBlc3RydXR1cmEgZGFzIG1lbnNhZ2Vucy5cclxuICpcclxuICogIyMjIENhYmXDp2FsaG9cclxuICpcclxuICogw4kgcG9zc8OtdmVsIGRpc3BlbnNhciBhIG5vdGlmaWNhw6fDo28gcGFyYSBvIHVzdcOhcmlvIHV0aWxpemFuZG8gbm8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28gb3MgcGFyw6JtZXRyb3MgbGlzdGFkb3MgYWJhaXhvIGNvbSBvIHZhbG9yXHJcbiAqIGlndWFsIGEgYHRydWVgOlxyXG4gKlxyXG4gKiAtIGBYLVBPLU5vLU1lc3NhZ2VgOiBOw6NvIGV4aWJlIG5vdGlmaWNhw6fDtWVzIGRlIGVycm8gZS9vdSBzdWNlc3NvLlxyXG4gKlxyXG4gKiAtIGBYLVBPLU5vLUVycm9yYDogTsOjbyBtb3N0cmEgbm90aWZpY2HDp8O1ZXMgZGUgZXJybyBjb20gY8OzZGlnb3MgYDR4eGAgZSBgNXh4YC5cclxuICpcclxuICogYGBgXHJcbiAqIC4uLlxyXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUE8tTm8tTWVzc2FnZSc6ICd0cnVlJyB9O1xyXG4gKlxyXG4gKiAgdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xyXG4gKiAuLi5cclxuICpcclxuICogYGBgXHJcbiAqXHJcbiAqID4gQXDDs3MgYSB2YWxpZGHDp8OjbyBubyAqaW50ZXJjZXB0b3IqLCBvcyBwYXLDom1ldHJvcyBzZXLDo28gcmVtb3ZpZG9zIGRvIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvLlxyXG4gKlxyXG4gKi9cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFBvSHR0cEludGVyY2VwdG9yQmFzZVNlcnZpY2UgaW1wbGVtZW50cyBIdHRwSW50ZXJjZXB0b3Ige1xyXG4gIG5vdGlmaWNhdGlvblR5cGVzID0gWydzdWNjZXNzJywgJ3dhcm5pbmcnLCAnZXJyb3InLCAnaW5mb3JtYXRpb24nXTtcclxuXHJcbiAgbGl0ZXJhbHMgPSBwb0h0dHBJbnRlcmNlcHRvckxpdGVyYWxzW3RoaXMubGFuZ3VhZ2VTZXJ2aWNlLmdldFNob3J0TGFuZ3VhZ2UoKV07XHJcblxyXG4gIHByaXZhdGUgaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50OiBDb21wb25lbnRSZWY8UG9IdHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQ+ID0gdW5kZWZpbmVkO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByaXZhdGUgY29tcG9uZW50SW5qZWN0b3I6IFBvQ29tcG9uZW50SW5qZWN0b3JTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBub3RpZmljYXRpb246IGFueSxcclxuICAgIHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBQb0xhbmd1YWdlU2VydmljZVxyXG4gICkge31cclxuXHJcbiAgaW50ZXJjZXB0KHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4sIG5leHQ6IEh0dHBIYW5kbGVyKTogT2JzZXJ2YWJsZTxIdHRwRXZlbnQ8YW55Pj4ge1xyXG4gICAgY29uc3QgY2xvbmVSZXF1ZXN0ID0gcmVxdWVzdC5jbG9uZSgpO1xyXG5cclxuICAgIHJlcXVlc3QgPSByZXF1ZXN0ICYmIHRoaXMuaGFzUGFyYW1ldGVycyhyZXF1ZXN0KSA/IHRoaXMuY2xvbmVSZXF1ZXN0V2l0aG91dFBhcmFtZXRlcnMocmVxdWVzdCkgOiByZXF1ZXN0O1xyXG5cclxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxyXG4gICAgICB0YXAoXHJcbiAgICAgICAgKHJlc3BvbnNlOiBIdHRwRXZlbnQ8YW55PikgPT4ge1xyXG4gICAgICAgICAgaWYgKHJlc3BvbnNlIGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XHJcbiAgICAgICAgICAgIHRoaXMucHJvY2Vzc1Jlc3BvbnNlKHJlc3BvbnNlLCBjbG9uZVJlcXVlc3QpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT4ge1xyXG4gICAgICAgICAgdGhpcy5wcm9jZXNzRXJyb3JSZXNwb25zZShlcnJvciwgY2xvbmVSZXF1ZXN0KTtcclxuICAgICAgICB9XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcm9jZXNzUmVzcG9uc2UocmVzcG9uc2U6IEh0dHBSZXNwb25zZTxhbnk+LCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XHJcbiAgICBjb25zdCBoYXNOb01lc3NhZ2VQYXJhbSA9IHRoaXMuaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdCk7XHJcblxyXG4gICAgaWYgKCFoYXNOb01lc3NhZ2VQYXJhbSAmJiByZXNwb25zZS5ib2R5ICYmIHJlc3BvbnNlLmJvZHkuX21lc3NhZ2VzKSB7XHJcbiAgICAgIGNvbnN0IG1lc3NhZ2VzID0gcmVzcG9uc2UuYm9keS5fbWVzc2FnZXM7XHJcblxyXG4gICAgICBpZiAobWVzc2FnZXMgaW5zdGFuY2VvZiBBcnJheSkge1xyXG4gICAgICAgIG1lc3NhZ2VzLmZvckVhY2goKG1lc3NhZ2U6IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24obWVzc2FnZSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKG1lc3NhZ2VzKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJvY2Vzc0Vycm9yUmVzcG9uc2UocmVzcG9uc2U6IEh0dHBFcnJvclJlc3BvbnNlLCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XHJcbiAgICBjb25zdCBlcnJvclJlc3BvbnNlID1cclxuICAgICAgcmVzcG9uc2Uuc3RhdHVzICE9PSAwXHJcbiAgICAgICAgPyByZXNwb25zZS5lcnJvclxyXG4gICAgICAgIDogeyBjb2RlOiAwLCBtZXNzYWdlOiB0aGlzLmxpdGVyYWxzLnNlcnZlck5vdFJlc3BvbnNlLCBkZXRhaWxlZE1lc3NhZ2U6IHJlc3BvbnNlLm1lc3NhZ2UgfTtcclxuXHJcbiAgICBjb25zdCBoYXNOb0Vycm9yUGFyYW0gPSB0aGlzLmhhc05vRXJyb3JQYXJhbShyZXF1ZXN0KTtcclxuICAgIGNvbnN0IGhhc05vTWVzc2FnZVBhcmFtID0gdGhpcy5oYXNOb01lc3NhZ2VQYXJhbShyZXF1ZXN0KTtcclxuICAgIGNvbnN0IGVycm9yUmVzcG9uc2VWYWxpZFR5cGVzID0gdGhpcy5ub3RpZmljYXRpb25UeXBlcy5zbGljZSgxKTtcclxuXHJcbiAgICBpZiAoZXJyb3JSZXNwb25zZSAmJiBlcnJvclJlc3BvbnNlLm1lc3NhZ2UgJiYgIWhhc05vRXJyb3JQYXJhbSAmJiAhaGFzTm9NZXNzYWdlUGFyYW0pIHtcclxuICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKHtcclxuICAgICAgICAuLi5lcnJvclJlc3BvbnNlLFxyXG4gICAgICAgIHR5cGU6IGVycm9yUmVzcG9uc2VWYWxpZFR5cGVzLmluY2x1ZGVzKGVycm9yUmVzcG9uc2UudHlwZSkgPyBlcnJvclJlc3BvbnNlLnR5cGUgOiAnZXJyb3InXHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjbG9uZVJlcXVlc3RXaXRob3V0UGFyYW1ldGVycyhyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogSHR0cFJlcXVlc3Q8YW55PiB7XHJcbiAgICBjb25zdCBoZWFkZXJzID0gcmVxdWVzdC5oZWFkZXJzLmRlbGV0ZShOT19FUlJPUl9IRUFERVJfUEFSQU0pLmRlbGV0ZShOT19NRVNTQUdFX0hFQURFUl9QQVJBTSk7XHJcblxyXG4gICAgcmV0dXJuIHJlcXVlc3QuY2xvbmUoeyBoZWFkZXJzIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjcmVhdGVNb2RhbChyZXNwb25zZU1lc3NhZ2U6IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsKSB7XHJcbiAgICBjb25zdCBkZXRhaWxzID0gcmVzcG9uc2VNZXNzYWdlLmRldGFpbHMgPyBbcmVzcG9uc2VNZXNzYWdlLCAuLi5yZXNwb25zZU1lc3NhZ2UuZGV0YWlsc10gOiBbcmVzcG9uc2VNZXNzYWdlXTtcclxuXHJcbiAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50SW5qZWN0b3IuY3JlYXRlQ29tcG9uZW50SW5BcHBsaWNhdGlvbihcclxuICAgICAgUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnRcclxuICAgICk7XHJcbiAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudC5pbnN0YW5jZS5kZXRhaWwgPSBkZXRhaWxzO1xyXG4gICAgdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQuaW5zdGFuY2UuY2xvc2VkLnN1YnNjcmliZSgoKSA9PiB0aGlzLmRlc3Ryb3lNb2RhbCgpKTtcclxuICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50Lmluc3RhbmNlLm9wZW4oKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZGVzdHJveU1vZGFsKCkge1xyXG4gICAgaWYgKHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50KSB7XHJcbiAgICAgIHRoaXMuY29tcG9uZW50SW5qZWN0b3IuZGVzdHJveUNvbXBvbmVudEluQXBwbGljYXRpb24odGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQpO1xyXG4gICAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCA9IHVuZGVmaW5lZDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFzTWVzc2FnZShyZXNwb25zZU1lc3NhZ2U6IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsKSB7XHJcbiAgICBjb25zdCBoYXNNZXNzYWdlUHJvcGVydGllcyA9IHJlc3BvbnNlTWVzc2FnZS5tZXNzYWdlO1xyXG5cclxuICAgIHJldHVybiByZXNwb25zZU1lc3NhZ2UgJiYgaGFzTWVzc2FnZVByb3BlcnRpZXM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhc05vRXJyb3JQYXJhbShyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCBub0Vycm9yUGFyYW0gPSByZXF1ZXN0ICYmIHJlcXVlc3QuaGVhZGVycy5nZXQoTk9fRVJST1JfSEVBREVSX1BBUkFNKTtcclxuXHJcbiAgICByZXR1cm4gbm9FcnJvclBhcmFtICYmIG5vRXJyb3JQYXJhbS50b1N0cmluZygpLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IGJvb2xlYW4ge1xyXG4gICAgY29uc3Qgbm9NZXNzYWdlUGFyYW0gPSByZXF1ZXN0ICYmIHJlcXVlc3QuaGVhZGVycy5nZXQoTk9fTUVTU0FHRV9IRUFERVJfUEFSQU0pO1xyXG5cclxuICAgIHJldHVybiBub01lc3NhZ2VQYXJhbSAmJiBub01lc3NhZ2VQYXJhbS50b1N0cmluZygpLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFzUGFyYW1ldGVycyhyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XHJcbiAgICByZXR1cm4gcmVxdWVzdC5oZWFkZXJzLmhhcyhOT19FUlJPUl9IRUFERVJfUEFSQU0pIHx8IHJlcXVlc3QuaGVhZGVycy5oYXMoTk9fTUVTU0FHRV9IRUFERVJfUEFSQU0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzaG93Tm90aWZpY2F0aW9uKHJlc3BvbnNlOiBhbnkpIHtcclxuICAgIGlmICghdGhpcy5oYXNNZXNzYWdlKHJlc3BvbnNlKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgdHlwZU5vdGlmaWNhdGlvbiA9IHRoaXMubm90aWZpY2F0aW9uVHlwZXMuaW5jbHVkZXMocmVzcG9uc2UudHlwZSkgPyByZXNwb25zZS50eXBlIDogJ2luZm9ybWF0aW9uJztcclxuXHJcbiAgICBjb25zdCBub3RpZmljYXRpb25BY3Rpb24gPSB0aGlzLmdlbmVyYXRlTm90aWZpY2F0aW9uQWN0aW9uKHJlc3BvbnNlKTtcclxuXHJcbiAgICB0aGlzLm5vdGlmaWNhdGlvblt0eXBlTm90aWZpY2F0aW9uXSh7XHJcbiAgICAgIG1lc3NhZ2U6IHJlc3BvbnNlLm1lc3NhZ2UsXHJcbiAgICAgIGFjdGlvbkxhYmVsOiBub3RpZmljYXRpb25BY3Rpb24ubGFiZWwsXHJcbiAgICAgIGFjdGlvbjogbm90aWZpY2F0aW9uQWN0aW9uLmFjdGlvblxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdlbmVyYXRlRGV0YWlsTW9kYWwocmVzcG9uc2VNZXNzYWdlOiBhbnkpIHtcclxuICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgIGlmICghdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQpIHtcclxuICAgICAgICB0aGlzLmNyZWF0ZU1vZGFsKHJlc3BvbnNlTWVzc2FnZSk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdlbmVyYXRlTm90aWZpY2F0aW9uQWN0aW9uKHJlc3BvbnNlTWVzc2FnZTogYW55KSB7XHJcbiAgICBsZXQgbm90aWZpY2F0aW9uQWN0aW9uO1xyXG4gICAgbGV0IG5vdGlmaWNhdGlvbkxhYmVsO1xyXG5cclxuICAgIGlmIChyZXNwb25zZU1lc3NhZ2UuaGVscFVybCAmJiAhKHJlc3BvbnNlTWVzc2FnZS5kZXRhaWxlZE1lc3NhZ2UgfHwgcmVzcG9uc2VNZXNzYWdlLmRldGFpbHMpKSB7XHJcbiAgICAgIG5vdGlmaWNhdGlvbkxhYmVsID0gdGhpcy5saXRlcmFscy5oZWxwO1xyXG4gICAgICBub3RpZmljYXRpb25BY3Rpb24gPSB0aGlzLmdlbmVyYXRlVXJsSGVscEZ1bmN0aW9uKHJlc3BvbnNlTWVzc2FnZS5oZWxwVXJsKTtcclxuICAgIH0gZWxzZSBpZiAocmVzcG9uc2VNZXNzYWdlLmRldGFpbGVkTWVzc2FnZSB8fCByZXNwb25zZU1lc3NhZ2UuZGV0YWlscykge1xyXG4gICAgICBub3RpZmljYXRpb25MYWJlbCA9IHRoaXMubGl0ZXJhbHMuZGV0YWlscztcclxuICAgICAgbm90aWZpY2F0aW9uQWN0aW9uID0gdGhpcy5nZW5lcmF0ZURldGFpbE1vZGFsKHJlc3BvbnNlTWVzc2FnZSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4geyBsYWJlbDogbm90aWZpY2F0aW9uTGFiZWwsIGFjdGlvbjogbm90aWZpY2F0aW9uQWN0aW9uIH07XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdlbmVyYXRlVXJsSGVscEZ1bmN0aW9uKGhlbHBVcmw6IHN0cmluZykge1xyXG4gICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgd2luZG93Lm9wZW4oaGVscFVybCwgJ19ibGFuaycpO1xyXG4gICAgfTtcclxuICB9XHJcbn1cclxuIl19
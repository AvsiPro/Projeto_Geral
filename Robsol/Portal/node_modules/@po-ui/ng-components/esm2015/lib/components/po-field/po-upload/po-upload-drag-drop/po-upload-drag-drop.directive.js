import { __awaiter } from "tslib";
import { Directive, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { PoI18nPipe } from '../../../../services/po-i18n/po-i18n.pipe';
import { PoNotificationService } from '../../../../services/po-notification/po-notification.service';
export class PoUploadDragDropDirective {
    constructor(i18nPipe, notification) {
        this.i18nPipe = i18nPipe;
        this.notification = notification;
        this.dragLeave = new EventEmitter();
        this.dragOver = new EventEmitter();
        this.fileChange = new EventEmitter();
    }
    onDragLeave(event) {
        event.preventDefault();
        event.stopPropagation();
        this.timeout = setTimeout(() => this.dragLeave.emit(), 30);
    }
    onDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        clearTimeout(this.timeout);
        if (!this.disabled) {
            this.dragOver.emit();
        }
    }
    onDrop(event) {
        event.preventDefault();
        event.stopPropagation();
        this.getFilesFromDataTransferItems(event);
        this.dragLeave.emit();
    }
    getFilesFromDataTransferItems(event) {
        if (!this.disabled) {
            this.invalidFileType = 0;
            if (this.directoryCompatible) {
                this.getOnlyDirectories(event.dataTransfer.items).then(() => {
                    this.sendFiles(event, this.files);
                });
            }
            else {
                const files = this.getOnlyFiles(event.dataTransfer);
                this.sendFiles(event, files);
            }
        }
    }
    // analisa as entradas recursivamente
    getFilesFromEntry(entry) {
        return __awaiter(this, void 0, void 0, function* () {
            if (entry.isFile) {
                const file = yield this.readFile(entry);
                return [file];
            }
            else if (entry.isDirectory) {
                return yield this.readDirectory(entry);
            }
        });
    }
    getOnlyDirectories(dataTransferItems) {
        return __awaiter(this, void 0, void 0, function* () {
            const entries = [];
            // lista todas as entradas antes de analisá-las
            for (const item of dataTransferItems) {
                entries.push(item.webkitGetAsEntry());
            }
            this.files = [];
            for (const entry of entries) {
                if (entry.isFile) {
                    this.invalidFileType++;
                }
                else {
                    const newFiles = yield this.getFilesFromEntry(entry);
                    this.files = this.files.concat(newFiles);
                }
            }
        });
    }
    // return only files. If it is a directory, invalidFileType counts.
    getOnlyFiles(dataTransfer) {
        const fileList = Array.from(dataTransfer.files);
        const entriesFiles = Array.from(dataTransfer.items).map(item => item.webkitGetAsEntry());
        return fileList.reduce((newFiles, file) => {
            const entryFile = entriesFiles.find(entry => entry.name === file.name);
            if (entryFile.isFile) {
                return newFiles.concat(file);
            }
            else {
                this.invalidFileType++;
            }
            return newFiles;
        }, []);
    }
    readFile(entry) {
        return new Promise(resolve => {
            entry.file(file => {
                resolve(file);
            });
        });
    }
    readDirectory(entry) {
        return __awaiter(this, void 0, void 0, function* () {
            const dirReader = entry.createReader();
            let files = [];
            const newFiles = yield this.readDirectoryEntries(dirReader);
            files = files.concat(newFiles);
            return files;
        });
    }
    readDirectoryEntries(dirReader) {
        return new Promise(resolve => {
            dirReader.readEntries((entries) => __awaiter(this, void 0, void 0, function* () {
                let files = [];
                for (const entry of entries) {
                    const itemFiles = yield this.getFilesFromEntry(entry);
                    files = files.concat(itemFiles);
                }
                resolve(files);
            }));
        });
    }
    sendFeedback(invalidFiles) {
        if (invalidFiles) {
            this.setPipeArguments('invalidFileType', invalidFiles);
        }
    }
    sendFiles(event, files) {
        if (this.areaElement.contains(event.target)) {
            if (files.length > 0) {
                this.fileChange.emit(files);
            }
            this.sendFeedback(this.invalidFileType);
        }
        else {
            const invalidDropAreaArg = this.directoryCompatible ? this.literals.folders : this.literals.files;
            this.setPipeArguments('invalidDropArea', invalidDropAreaArg);
        }
    }
    // método responsável por setar os argumentos do i18nPipe.
    setPipeArguments(literalAttributes, args) {
        const pipeArguments = this.i18nPipe.transform(this.literals[literalAttributes], args);
        this.notification.information(pipeArguments);
    }
}
PoUploadDragDropDirective.decorators = [
    { type: Directive, args: [{
                selector: '[p-upload-drag-drop]',
                providers: [PoI18nPipe]
            },] }
];
PoUploadDragDropDirective.ctorParameters = () => [
    { type: PoI18nPipe },
    { type: PoNotificationService }
];
PoUploadDragDropDirective.propDecorators = {
    areaElement: [{ type: Input, args: ['p-area-element',] }],
    directoryCompatible: [{ type: Input, args: ['p-directory-compatible',] }],
    disabled: [{ type: Input, args: ['p-disabled',] }],
    literals: [{ type: Input, args: ['p-literals',] }],
    dragLeave: [{ type: Output, args: ['p-drag-leave',] }],
    dragOver: [{ type: Output, args: ['p-drag-over',] }],
    fileChange: [{ type: Output, args: ['p-file-change',] }],
    onDragLeave: [{ type: HostListener, args: ['document:dragleave', ['$event'],] }],
    onDragOver: [{ type: HostListener, args: ['document:dragover', ['$event'],] }],
    onDrop: [{ type: HostListener, args: ['document:drop', ['$event'],] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdXBsb2FkLWRyYWctZHJvcC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2NvbXBvbmVudHMvcG8tZmllbGQvcG8tdXBsb2FkL3BvLXVwbG9hZC1kcmFnLWRyb3AvcG8tdXBsb2FkLWRyYWctZHJvcC5kaXJlY3RpdmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLFlBQVksRUFBRSxLQUFLLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRXJGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUN2RSxPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSw4REFBOEQsQ0FBQztBQU9yRyxNQUFNLE9BQU8seUJBQXlCO0lBb0JwQyxZQUFvQixRQUFvQixFQUFVLFlBQW1DO1FBQWpFLGFBQVEsR0FBUixRQUFRLENBQVk7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBdUI7UUFYN0QsY0FBUyxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBRXhELGFBQVEsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUVwRCxlQUFVLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7SUFPTyxDQUFDO0lBRXpDLFdBQVcsQ0FBQyxLQUFLO1FBQy9ELEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2QixLQUFLLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFeEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxVQUFVLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRThDLFVBQVUsQ0FBQyxLQUFLO1FBQzdELEtBQUssQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2QixLQUFLLENBQUMsZUFBZSxF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LENBQUMsaUJBQWlCLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztRQUN0RixJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUMvQyxDQUFDOzs7WUFyS0YsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxzQkFBc0I7Z0JBQ2hDLFNBQVMsRUFBRSxDQUFDLFVBQVUsQ0FBQzthQUN4Qjs7O1lBUFEsVUFBVTtZQUNWLHFCQUFxQjs7OzBCQVEzQixLQUFLLFNBQUMsZ0JBQWdCO2tDQUV0QixLQUFLLFNBQUMsd0JBQXdCO3VCQUU5QixLQUFLLFNBQUMsWUFBWTt1QkFFbEIsS0FBSyxTQUFDLFlBQVk7d0JBRWxCLE1BQU0sU0FBQyxjQUFjO3VCQUVyQixNQUFNLFNBQUMsYUFBYTt5QkFFcEIsTUFBTSxTQUFDLGVBQWU7MEJBU3RCLFlBQVksU0FBQyxvQkFBb0IsRUFBRSxDQUFDLFFBQVEsQ0FBQzt5QkFPN0MsWUFBWSxTQUFDLG1CQUFtQixFQUFFLENBQUMsUUFBUSxDQUFDO3FCQVc1QyxZQUFZLFNBQUMsZUFBZSxFQUFFLENBQUMsUUFBUSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFdmVudEVtaXR0ZXIsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgUG9JMThuUGlwZSB9IGZyb20gJy4uLy4uLy4uLy4uL3NlcnZpY2VzL3BvLWkxOG4vcG8taTE4bi5waXBlJztcclxuaW1wb3J0IHsgUG9Ob3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2VydmljZXMvcG8tbm90aWZpY2F0aW9uL3BvLW5vdGlmaWNhdGlvbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUG9VcGxvYWRMaXRlcmFscyB9IGZyb20gJy4uL2ludGVyZmFjZXMvcG8tdXBsb2FkLWxpdGVyYWxzLmludGVyZmFjZSc7XHJcblxyXG5ARGlyZWN0aXZlKHtcclxuICBzZWxlY3RvcjogJ1twLXVwbG9hZC1kcmFnLWRyb3BdJyxcclxuICBwcm92aWRlcnM6IFtQb0kxOG5QaXBlXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgUG9VcGxvYWREcmFnRHJvcERpcmVjdGl2ZSB7XHJcbiAgQElucHV0KCdwLWFyZWEtZWxlbWVudCcpIGFyZWFFbGVtZW50OiBIVE1MRWxlbWVudDtcclxuXHJcbiAgQElucHV0KCdwLWRpcmVjdG9yeS1jb21wYXRpYmxlJykgZGlyZWN0b3J5Q29tcGF0aWJsZTogYm9vbGVhbjtcclxuXHJcbiAgQElucHV0KCdwLWRpc2FibGVkJykgZGlzYWJsZWQ6IGJvb2xlYW47XHJcblxyXG4gIEBJbnB1dCgncC1saXRlcmFscycpIGxpdGVyYWxzOiBQb1VwbG9hZExpdGVyYWxzO1xyXG5cclxuICBAT3V0cHV0KCdwLWRyYWctbGVhdmUnKSBkcmFnTGVhdmU6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIEBPdXRwdXQoJ3AtZHJhZy1vdmVyJykgZHJhZ092ZXI6IEV2ZW50RW1pdHRlcjxhbnk+ID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIEBPdXRwdXQoJ3AtZmlsZS1jaGFuZ2UnKSBmaWxlQ2hhbmdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICB0aW1lb3V0OiBhbnk7XHJcblxyXG4gIHByaXZhdGUgZmlsZXM6IEFycmF5PEZpbGU+O1xyXG4gIHByaXZhdGUgaW52YWxpZEZpbGVUeXBlOiBudW1iZXI7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaTE4blBpcGU6IFBvSTE4blBpcGUsIHByaXZhdGUgbm90aWZpY2F0aW9uOiBQb05vdGlmaWNhdGlvblNlcnZpY2UpIHt9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmRyYWdsZWF2ZScsIFsnJGV2ZW50J10pIG9uRHJhZ0xlYXZlKGV2ZW50KSB7XHJcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XHJcblxyXG4gICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLmRyYWdMZWF2ZS5lbWl0KCksIDMwKTtcclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmRyYWdvdmVyJywgWyckZXZlbnQnXSkgb25EcmFnT3ZlcihldmVudCkge1xyXG4gICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xyXG5cclxuICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXQpO1xyXG5cclxuICAgIGlmICghdGhpcy5kaXNhYmxlZCkge1xyXG4gICAgICB0aGlzLmRyYWdPdmVyLmVtaXQoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmRyb3AnLCBbJyRldmVudCddKSBvbkRyb3AoZXZlbnQpIHtcclxuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTtcclxuXHJcbiAgICB0aGlzLmdldEZpbGVzRnJvbURhdGFUcmFuc2Zlckl0ZW1zKGV2ZW50KTtcclxuICAgIHRoaXMuZHJhZ0xlYXZlLmVtaXQoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0RmlsZXNGcm9tRGF0YVRyYW5zZmVySXRlbXMoZXZlbnQ6IERyYWdFdmVudCkge1xyXG4gICAgaWYgKCF0aGlzLmRpc2FibGVkKSB7XHJcbiAgICAgIHRoaXMuaW52YWxpZEZpbGVUeXBlID0gMDtcclxuICAgICAgaWYgKHRoaXMuZGlyZWN0b3J5Q29tcGF0aWJsZSkge1xyXG4gICAgICAgIHRoaXMuZ2V0T25seURpcmVjdG9yaWVzKGV2ZW50LmRhdGFUcmFuc2Zlci5pdGVtcykudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICB0aGlzLnNlbmRGaWxlcyhldmVudCwgdGhpcy5maWxlcyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmdldE9ubHlGaWxlcyhldmVudC5kYXRhVHJhbnNmZXIpO1xyXG4gICAgICAgIHRoaXMuc2VuZEZpbGVzKGV2ZW50LCBmaWxlcyk7XHJcbiAgICAgIH1cclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vIGFuYWxpc2EgYXMgZW50cmFkYXMgcmVjdXJzaXZhbWVudGVcclxuICBwcml2YXRlIGFzeW5jIGdldEZpbGVzRnJvbUVudHJ5KGVudHJ5KSB7XHJcbiAgICBpZiAoZW50cnkuaXNGaWxlKSB7XHJcbiAgICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLnJlYWRGaWxlKGVudHJ5KTtcclxuICAgICAgcmV0dXJuIFtmaWxlXTtcclxuICAgIH0gZWxzZSBpZiAoZW50cnkuaXNEaXJlY3RvcnkpIHtcclxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVhZERpcmVjdG9yeShlbnRyeSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIGdldE9ubHlEaXJlY3RvcmllcyhkYXRhVHJhbnNmZXJJdGVtcykge1xyXG4gICAgY29uc3QgZW50cmllcyA9IFtdO1xyXG5cclxuICAgIC8vIGxpc3RhIHRvZGFzIGFzIGVudHJhZGFzIGFudGVzIGRlIGFuYWxpc8OhLWxhc1xyXG4gICAgZm9yIChjb25zdCBpdGVtIG9mIGRhdGFUcmFuc2Zlckl0ZW1zKSB7XHJcbiAgICAgIGVudHJpZXMucHVzaChpdGVtLndlYmtpdEdldEFzRW50cnkoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5maWxlcyA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7XHJcbiAgICAgIGlmIChlbnRyeS5pc0ZpbGUpIHtcclxuICAgICAgICB0aGlzLmludmFsaWRGaWxlVHlwZSsrO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGNvbnN0IG5ld0ZpbGVzID0gYXdhaXQgdGhpcy5nZXRGaWxlc0Zyb21FbnRyeShlbnRyeSk7XHJcbiAgICAgICAgdGhpcy5maWxlcyA9IHRoaXMuZmlsZXMuY29uY2F0KG5ld0ZpbGVzKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gcmV0dXJuIG9ubHkgZmlsZXMuIElmIGl0IGlzIGEgZGlyZWN0b3J5LCBpbnZhbGlkRmlsZVR5cGUgY291bnRzLlxyXG4gIHByaXZhdGUgZ2V0T25seUZpbGVzKGRhdGFUcmFuc2ZlcjogRGF0YVRyYW5zZmVyKTogQXJyYXk8RmlsZT4ge1xyXG4gICAgY29uc3QgZmlsZUxpc3Q6IEFycmF5PEZpbGU+ID0gQXJyYXkuZnJvbShkYXRhVHJhbnNmZXIuZmlsZXMpO1xyXG4gICAgY29uc3QgZW50cmllc0ZpbGVzOiBBcnJheTxhbnk+ID0gQXJyYXkuZnJvbShkYXRhVHJhbnNmZXIuaXRlbXMpLm1hcChpdGVtID0+IGl0ZW0ud2Via2l0R2V0QXNFbnRyeSgpKTtcclxuXHJcbiAgICByZXR1cm4gZmlsZUxpc3QucmVkdWNlKChuZXdGaWxlcywgZmlsZSkgPT4ge1xyXG4gICAgICBjb25zdCBlbnRyeUZpbGUgPSBlbnRyaWVzRmlsZXMuZmluZChlbnRyeSA9PiBlbnRyeS5uYW1lID09PSBmaWxlLm5hbWUpO1xyXG5cclxuICAgICAgaWYgKGVudHJ5RmlsZS5pc0ZpbGUpIHtcclxuICAgICAgICByZXR1cm4gbmV3RmlsZXMuY29uY2F0KGZpbGUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuaW52YWxpZEZpbGVUeXBlKys7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIG5ld0ZpbGVzO1xyXG4gICAgfSwgW10pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZWFkRmlsZShlbnRyeSkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xyXG4gICAgICBlbnRyeS5maWxlKGZpbGUgPT4ge1xyXG4gICAgICAgIHJlc29sdmUoZmlsZSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFzeW5jIHJlYWREaXJlY3RvcnkoZW50cnkpIHtcclxuICAgIGNvbnN0IGRpclJlYWRlciA9IGVudHJ5LmNyZWF0ZVJlYWRlcigpO1xyXG4gICAgbGV0IGZpbGVzID0gW107XHJcblxyXG4gICAgY29uc3QgbmV3RmlsZXMgPSBhd2FpdCB0aGlzLnJlYWREaXJlY3RvcnlFbnRyaWVzKGRpclJlYWRlcik7XHJcbiAgICBmaWxlcyA9IGZpbGVzLmNvbmNhdChuZXdGaWxlcyk7XHJcbiAgICByZXR1cm4gZmlsZXM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlYWREaXJlY3RvcnlFbnRyaWVzKGRpclJlYWRlcikge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xyXG4gICAgICBkaXJSZWFkZXIucmVhZEVudHJpZXMoYXN5bmMgZW50cmllcyA9PiB7XHJcbiAgICAgICAgbGV0IGZpbGVzID0gW107XHJcbiAgICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7XHJcbiAgICAgICAgICBjb25zdCBpdGVtRmlsZXMgPSBhd2FpdCB0aGlzLmdldEZpbGVzRnJvbUVudHJ5KGVudHJ5KTtcclxuICAgICAgICAgIGZpbGVzID0gZmlsZXMuY29uY2F0KGl0ZW1GaWxlcyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJlc29sdmUoZmlsZXMpO1xyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZW5kRmVlZGJhY2soaW52YWxpZEZpbGVzOiBudW1iZXIpIHtcclxuICAgIGlmIChpbnZhbGlkRmlsZXMpIHtcclxuICAgICAgdGhpcy5zZXRQaXBlQXJndW1lbnRzKCdpbnZhbGlkRmlsZVR5cGUnLCBpbnZhbGlkRmlsZXMpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZW5kRmlsZXMoZXZlbnQsIGZpbGVzKSB7XHJcbiAgICBpZiAodGhpcy5hcmVhRWxlbWVudC5jb250YWlucyhldmVudC50YXJnZXQpKSB7XHJcbiAgICAgIGlmIChmaWxlcy5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgdGhpcy5maWxlQ2hhbmdlLmVtaXQoZmlsZXMpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLnNlbmRGZWVkYmFjayh0aGlzLmludmFsaWRGaWxlVHlwZSk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBpbnZhbGlkRHJvcEFyZWFBcmcgPSB0aGlzLmRpcmVjdG9yeUNvbXBhdGlibGUgPyB0aGlzLmxpdGVyYWxzLmZvbGRlcnMgOiB0aGlzLmxpdGVyYWxzLmZpbGVzO1xyXG4gICAgICB0aGlzLnNldFBpcGVBcmd1bWVudHMoJ2ludmFsaWREcm9wQXJlYScsIGludmFsaWREcm9wQXJlYUFyZyk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyBtw6l0b2RvIHJlc3BvbnPDoXZlbCBwb3Igc2V0YXIgb3MgYXJndW1lbnRvcyBkbyBpMThuUGlwZS5cclxuICBwcml2YXRlIHNldFBpcGVBcmd1bWVudHMobGl0ZXJhbEF0dHJpYnV0ZXM6IHN0cmluZywgYXJncz8pIHtcclxuICAgIGNvbnN0IHBpcGVBcmd1bWVudHMgPSB0aGlzLmkxOG5QaXBlLnRyYW5zZm9ybSh0aGlzLmxpdGVyYWxzW2xpdGVyYWxBdHRyaWJ1dGVzXSwgYXJncyk7XHJcbiAgICB0aGlzLm5vdGlmaWNhdGlvbi5pbmZvcm1hdGlvbihwaXBlQXJndW1lbnRzKTtcclxuICB9XHJcbn1cclxuIl19
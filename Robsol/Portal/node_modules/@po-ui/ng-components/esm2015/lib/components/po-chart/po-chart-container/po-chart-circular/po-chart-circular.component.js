import { ChangeDetectorRef, Directive, EventEmitter, Input, NgZone, Output, ViewChildren } from '@angular/core';
import { PoChartStartAngle, PoChartCompleteCircle, PoChartAngleStepInterval } from '../../helpers/po-chart-default-values.constant';
export class PoChartCircularComponent {
    constructor(ngZone, changeDetector) {
        this.ngZone = ngZone;
        this.changeDetector = changeDetector;
        this.circularClick = new EventEmitter();
        this.circularHover = new EventEmitter();
        this.canDisplayLabels = false;
        this.seriesLabels = [];
        this.showLabels = false;
    }
    set options(value) {
        if (!isNaN(value === null || value === void 0 ? void 0 : value.innerRadius)) {
            this._options = value;
            this.innerRadius = Math.min(Math.max(this._options.innerRadius, 0), 100);
        }
    }
    get options() {
        return this._options;
    }
    set series(value) {
        this._series = value;
        this.animate = true;
    }
    get series() {
        return this._series;
    }
    onSerieClick(selectedItem) {
        this.circularClick.emit(selectedItem);
    }
    onSerieHover(selectedItem) {
        this.circularHover.emit(selectedItem);
    }
    calculateAngle(data, totalValue) {
        return (data / totalValue) * (Math.PI * 2);
    }
    drawSeries(series = [], height) {
        this.seriesList = [];
        this.showLabels = false;
        this.totalValue = this.calculateTotalValue(series);
        if (this.totalValue && this.totalValue > 0) {
            this.seriesList = this.validateSeries(series);
            this.changeDetector.detectChanges();
            if (this.seriesList.length && this.svgPaths) {
                this.initDrawPaths(this.seriesList, this.totalValue, height);
            }
        }
    }
    calculateTotalValue(series) {
        return series.reduce((previousValue, serie) => {
            const data = serie.data ? serie.data : serie.value;
            return previousValue + (data > 0 ? data : 0);
        }, 0);
    }
    calculateSerieCoordinates(series, totalValue, height) {
        let startRadianAngle;
        let endRadianAngle = PoChartStartAngle;
        series.forEach((serie, index) => {
            startRadianAngle = endRadianAngle;
            endRadianAngle = startRadianAngle + this.calculateAngle(serie.data, totalValue) - PoChartCompleteCircle;
            const coordinates = this.calculateCoordinates(height, startRadianAngle, endRadianAngle);
            this.svgPaths.toArray()[index].applyCoordinates(coordinates);
            this.showLabels = this.canDisplayLabels;
        });
    }
    calculateCoordinatesWithAnimation(series, totalValue, height, startRadianAngle, endRadianAngle, currentRadianAngle = 0, seriesIndex = 0) {
        const finishedCurrentSerie = currentRadianAngle > endRadianAngle;
        const finishedAllSeries = seriesIndex === series.length;
        if (finishedAllSeries) {
            this.animate = false;
            return;
        }
        if (finishedCurrentSerie) {
            this.setSerieLabelCoordinates(seriesIndex);
            currentRadianAngle = 0;
            seriesIndex++;
            startRadianAngle = startRadianAngle + endRadianAngle;
            endRadianAngle =
                seriesIndex < series.length ? this.calculateAngle(series[seriesIndex].data, totalValue) : undefined;
        }
        else {
            currentRadianAngle += PoChartAngleStepInterval;
            const currentEndRadianAngle = this.calculateCurrentEndAngle(currentRadianAngle, startRadianAngle, endRadianAngle);
            const coordinates = this.calculateCoordinates(height, startRadianAngle, currentEndRadianAngle);
            this.svgPaths.toArray()[seriesIndex].applyCoordinates(coordinates);
        }
        window.requestAnimationFrame(this.calculateCoordinatesWithAnimation.bind(this, series, totalValue, height, startRadianAngle, endRadianAngle, currentRadianAngle, seriesIndex));
    }
    calculateCurrentEndAngle(currentRadianAngle, startRadianAngle, endRadianAngle) {
        const isSerieDrawCompleted = startRadianAngle + currentRadianAngle > startRadianAngle + endRadianAngle;
        return isSerieDrawCompleted
            ? startRadianAngle + endRadianAngle - PoChartCompleteCircle
            : startRadianAngle + currentRadianAngle;
    }
    initDrawPaths(seriesList, totalValue, height) {
        if (!this.animate) {
            this.calculateSerieCoordinates(seriesList, totalValue, height);
        }
        else {
            const startRadianAngle = PoChartStartAngle;
            const endRadianAngle = this.calculateAngle(seriesList[0].data, totalValue);
            this.ngZone.runOutsideAngular(() => this.calculateCoordinatesWithAnimation(seriesList, totalValue, height, startRadianAngle, endRadianAngle));
        }
    }
    setSerieLabelCoordinates(index) {
        if (this.svgLabels.toArray().length) {
            this.svgLabels.toArray()[index].applyCoordinates(this.seriesLabels[index]);
        }
    }
    validateSeries(series) {
        return series.reduce((seriesList, serie) => {
            var _a;
            const data = (_a = serie.data) !== null && _a !== void 0 ? _a : serie.value;
            if (data && data > 0) {
                const color = serie.color;
                const label = serie.label;
                const tooltip = serie.tooltip;
                const tooltipLabel = this.getTooltipLabel(data, label, tooltip);
                seriesList = [...seriesList, { data, color, label, tooltipLabel }];
            }
            return seriesList;
        }, []);
    }
}
PoChartCircularComponent.decorators = [
    { type: Directive }
];
PoChartCircularComponent.ctorParameters = () => [
    { type: NgZone },
    { type: ChangeDetectorRef }
];
PoChartCircularComponent.propDecorators = {
    containerSize: [{ type: Input, args: ['p-container-size',] }],
    circularClick: [{ type: Output, args: ['p-circular-click',] }],
    circularHover: [{ type: Output, args: ['p-circular-hover',] }],
    svgPaths: [{ type: ViewChildren, args: ['svgPaths',] }],
    svgLabels: [{ type: ViewChildren, args: ['svgLabels',] }],
    options: [{ type: Input, args: ['p-options',] }],
    series: [{ type: Input, args: ['p-series',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tY2hhcnQtY2lyY3VsYXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLWNoYXJ0L3BvLWNoYXJ0LWNvbnRhaW5lci9wby1jaGFydC1jaXJjdWxhci9wby1jaGFydC1jaXJjdWxhci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNMLGlCQUFpQixFQUNqQixTQUFTLEVBQ1QsWUFBWSxFQUNaLEtBQUssRUFDTCxNQUFNLEVBQ04sTUFBTSxFQUVOLFlBQVksRUFDYixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQ0wsaUJBQWlCLEVBQ2pCLHFCQUFxQixFQUNyQix3QkFBd0IsRUFDekIsTUFBTSxnREFBZ0QsQ0FBQztBQVd4RCxNQUFNLE9BQWdCLHdCQUF3QjtJQTZDNUMsWUFBb0IsTUFBYyxFQUFVLGNBQWlDO1FBQXpELFdBQU0sR0FBTixNQUFNLENBQVE7UUFBVSxtQkFBYyxHQUFkLGNBQWMsQ0FBbUI7UUExQ2pELGtCQUFhLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUV4QyxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFNcEUscUJBQWdCLEdBQVksS0FBSyxDQUFDO1FBQ2xDLGlCQUFZLEdBQW1DLEVBQUUsQ0FBQztRQUVsRCxlQUFVLEdBQVksS0FBSyxDQUFDO0lBK0JvRCxDQUFDO0lBckJqRixJQUF3QixPQUFPLENBQUMsS0FBcUI7UUFDbkQsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsV0FBVyxDQUFDLEVBQUU7WUFDOUIsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7WUFDdEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFD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LFVBQVU7d0JBRXZCLFlBQVksU0FBQyxXQUFXO3NCQWV4QixLQUFLLFNBQUMsV0FBVztxQkFXakIsS0FBSyxTQUFDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIENoYW5nZURldGVjdG9yUmVmLFxyXG4gIERpcmVjdGl2ZSxcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgSW5wdXQsXHJcbiAgTmdab25lLFxyXG4gIE91dHB1dCxcclxuICBRdWVyeUxpc3QsXHJcbiAgVmlld0NoaWxkcmVuXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcblxyXG5pbXBvcnQge1xyXG4gIFBvQ2hhcnRTdGFydEFuZ2xlLFxyXG4gIFBvQ2hhcnRDb21wbGV0ZUNpcmNsZSxcclxuICBQb0NoYXJ0QW5nbGVTdGVwSW50ZXJ2YWxcclxufSBmcm9tICcuLi8uLi9oZWxwZXJzL3BvLWNoYXJ0LWRlZmF1bHQtdmFsdWVzLmNvbnN0YW50JztcclxuXHJcbmltcG9ydCB7IFBvQ2hhcnRDaXJjdWxhckxhYmVsQ29tcG9uZW50IH0gZnJvbSAnLi9wby1jaGFydC1jaXJjdWxhci1sYWJlbC9wby1jaGFydC1jaXJjdWxhci1sYWJlbC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBQb0NoYXJ0Q2lyY3VsYXJQYXRoQ29tcG9uZW50IH0gZnJvbSAnLi9wby1jaGFydC1jaXJjdWxhci1wYXRoL3BvLWNoYXJ0LWNpcmN1bGFyLXBhdGguY29tcG9uZW50JztcclxuaW1wb3J0IHsgUG9DaGFydENvbnRhaW5lclNpemUgfSBmcm9tICcuLi8uLi9pbnRlcmZhY2VzL3BvLWNoYXJ0LWNvbnRhaW5lci1zaXplLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvQ2hhcnRMYWJlbENvb3JkaW5hdGVzIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9wby1jaGFydC1sYWJlbC1jb29yZGluYXRlcy5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBQb0NoYXJ0T3B0aW9ucyB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvcG8tY2hhcnQtb3B0aW9ucy5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBQb0NoYXJ0UGF0aENvb3JkaW5hdGVzIH0gZnJvbSAnLi4vLi4vaW50ZXJmYWNlcy9wby1jaGFydC1wYXRoLWNvb3JkaW5hdGVzLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvQ2hhcnRTZXJpZSB9IGZyb20gJy4uLy4uL2ludGVyZmFjZXMvcG8tY2hhcnQtc2VyaWUuaW50ZXJmYWNlJztcclxuXHJcbkBEaXJlY3RpdmUoKVxyXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUG9DaGFydENpcmN1bGFyQ29tcG9uZW50IHtcclxuICBASW5wdXQoJ3AtY29udGFpbmVyLXNpemUnKSBjb250YWluZXJTaXplOiBQb0NoYXJ0Q29udGFpbmVyU2l6ZTtcclxuXHJcbiAgQE91dHB1dCgncC1jaXJjdWxhci1jbGljaycpIGNpcmN1bGFyQ2xpY2sgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgQE91dHB1dCgncC1jaXJjdWxhci1ob3ZlcicpIGNpcmN1bGFySG92ZXIgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgQFZpZXdDaGlsZHJlbignc3ZnUGF0aHMnKSBwcml2YXRlIHN2Z1BhdGhzOiBRdWVyeUxpc3Q8UG9DaGFydENpcmN1bGFyUGF0aENvbXBvbmVudD47XHJcblxyXG4gIEBWaWV3Q2hpbGRyZW4oJ3N2Z0xhYmVscycpIHByaXZhdGUgc3ZnTGFiZWxzOiBRdWVyeUxpc3Q8UG9DaGFydENpcmN1bGFyTGFiZWxDb21wb25lbnQ+O1xyXG5cclxuICBjYW5EaXNwbGF5TGFiZWxzOiBib29sZWFuID0gZmFsc2U7XHJcbiAgc2VyaWVzTGFiZWxzOiBBcnJheTxQb0NoYXJ0TGFiZWxDb29yZGluYXRlcz4gPSBbXTtcclxuICBzZXJpZXNMaXN0OiBBcnJheTxQb0NoYXJ0UGF0aENvb3JkaW5hdGVzPjtcclxuICBzaG93TGFiZWxzOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gIHByb3RlY3RlZCBpbm5lclJhZGl1czogbnVtYmVyO1xyXG4gIHByb3RlY3RlZCB0b3RhbFZhbHVlOiBudW1iZXI7XHJcblxyXG4gIHByaXZhdGUgX29wdGlvbnM6IFBvQ2hhcnRPcHRpb25zO1xyXG4gIHByaXZhdGUgX3NlcmllczogQXJyYXk8UG9DaGFydFNlcmllPjtcclxuXHJcbiAgcHJpdmF0ZSBhbmltYXRlOiBib29sZWFuO1xyXG5cclxuICBASW5wdXQoJ3Atb3B0aW9ucycpIHNldCBvcHRpb25zKHZhbHVlOiBQb0NoYXJ0T3B0aW9ucykge1xyXG4gICAgaWYgKCFpc05hTih2YWx1ZT8uaW5uZXJSYWRpdXMpKSB7XHJcbiAgICAgIHRoaXMuX29wdGlvbnMgPSB2YWx1ZTtcclxuICAgICAgdGhpcy5pbm5lclJhZGl1cyA9IE1hdGgubWluKE1hdGgubWF4KHRoaXMuX29wdGlvbnMuaW5uZXJSYWRpdXMsIDApLCAxMDApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgZ2V0IG9wdGlvbnMoKSB7XHJcbiAgICByZXR1cm4gdGhpcy5fb3B0aW9ucztcclxuICB9XHJcblxyXG4gIEBJbnB1dCgncC1zZXJpZXMnKSBzZXQgc2VyaWVzKHZhbHVlOiBBcnJheTxQb0NoYXJ0U2VyaWU+KSB7XHJcbiAgICB0aGlzLl9zZXJpZXMgPSB2YWx1ZTtcclxuXHJcbiAgICB0aGlzLmFuaW1hdGUgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgZ2V0IHNlcmllcygpIHtcclxuICAgIHJldHVybiB0aGlzLl9zZXJpZXM7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5nWm9uZTogTmdab25lLCBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZikge31cclxuXHJcbiAgb25TZXJpZUNsaWNrKHNlbGVjdGVkSXRlbTogYW55KSB7XHJcbiAgICB0aGlzLmNpcmN1bGFyQ2xpY2suZW1pdChzZWxlY3RlZEl0ZW0pO1xyXG4gIH1cclxuXHJcbiAgb25TZXJpZUhvdmVyKHNlbGVjdGVkSXRlbTogYW55KSB7XHJcbiAgICB0aGlzLmNpcmN1bGFySG92ZXIuZW1pdChzZWxlY3RlZEl0ZW0pO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGNhbGN1bGF0ZUFuZ2xlKGRhdGE6IG51bWJlciwgdG90YWxWYWx1ZTogbnVtYmVyKSB7XHJcbiAgICByZXR1cm4gKGRhdGEgLyB0b3RhbFZhbHVlKSAqIChNYXRoLlBJICogMik7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgZHJhd1NlcmllcyhzZXJpZXM6IEFycmF5PFBvQ2hhcnRTZXJpZT4gPSBbXSwgaGVpZ2h0OiBudW1iZXIpIHtcclxuICAgIHRoaXMuc2VyaWVzTGlzdCA9IFtdO1xyXG4gICAgdGhpcy5zaG93TGFiZWxzID0gZmFsc2U7XHJcbiAgICB0aGlzLnRvdGFsVmFsdWUgPSB0aGlzLmNhbGN1bGF0ZVRvdGFsVmFsdWUoc2VyaWVzKTtcclxuICAgIGlmICh0aGlzLnRvdGFsVmFsdWUgJiYgdGhpcy50b3RhbFZhbHVlID4gMCkge1xyXG4gICAgICB0aGlzLnNlcmllc0xpc3QgPSB0aGlzLnZhbGlkYXRlU2VyaWVzKHNlcmllcyk7XHJcbiAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG5cclxuICAgICAgaWYgKHRoaXMuc2VyaWVzTGlzdC5sZW5ndGggJiYgdGhpcy5zdmdQYXRocykge1xyXG4gICAgICAgIHRoaXMuaW5pdERyYXdQYXRocyh0aGlzLnNlcmllc0xpc3QsIHRoaXMudG90YWxWYWx1ZSwgaGVpZ2h0KTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjYWxjdWxhdGVUb3RhbFZhbHVlKHNlcmllczogQXJyYXk8UG9DaGFydFNlcmllPikge1xyXG4gICAgcmV0dXJuIHNlcmllcy5yZWR1Y2UoKHByZXZpb3VzVmFsdWUsIHNlcmllOiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgZGF0YSA9IHNlcmllLmRhdGEgPyBzZXJpZS5kYXRhIDogc2VyaWUudmFsdWU7XHJcblxyXG4gICAgICByZXR1cm4gcHJldmlvdXNWYWx1ZSArIChkYXRhID4gMCA/IGRhdGEgOiAwKTtcclxuICAgIH0sIDApO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjYWxjdWxhdGVTZXJpZUNvb3JkaW5hdGVzKHNlcmllczogQXJyYXk8UG9DaGFydFBhdGhDb29yZGluYXRlcz4sIHRvdGFsVmFsdWU6IG51bWJlciwgaGVpZ2h0OiBudW1iZXIpIHtcclxuICAgIGxldCBzdGFydFJhZGlhbkFuZ2xlO1xyXG4gICAgbGV0IGVuZFJhZGlhbkFuZ2xlID0gUG9DaGFydFN0YXJ0QW5nbGU7XHJcblxyXG4gICAgc2VyaWVzLmZvckVhY2goKHNlcmllOiBhbnksIGluZGV4KSA9PiB7XHJcbiAgICAgIHN0YXJ0UmFkaWFuQW5nbGUgPSBlbmRSYWRpYW5BbmdsZTtcclxuICAgICAgZW5kUmFkaWFuQW5nbGUgPSBzdGFydFJhZGlhbkFuZ2xlICsgdGhpcy5jYWxjdWxhdGVBbmdsZShzZXJpZS5kYXRhLCB0b3RhbFZhbHVlKSAtIFBvQ2hhcnRDb21wbGV0ZUNpcmNsZTtcclxuXHJcbiAgICAgIGNvbnN0IGNvb3JkaW5hdGVzID0gdGhpcy5jYWxjdWxhdGVDb29yZGluYXRlcyhoZWlnaHQsIHN0YXJ0UmFkaWFuQW5nbGUsIGVuZFJhZGlhbkFuZ2xlKTtcclxuXHJcbiAgICAgIHRoaXMuc3ZnUGF0aHMudG9BcnJheSgpW2luZGV4XS5hcHBseUNvb3JkaW5hdGVzKGNvb3JkaW5hdGVzKTtcclxuICAgICAgdGhpcy5zaG93TGFiZWxzID0gdGhpcy5jYW5EaXNwbGF5TGFiZWxzO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNhbGN1bGF0ZUNvb3JkaW5hdGVzV2l0aEFuaW1hdGlvbihcclxuICAgIHNlcmllczogQXJyYXk8UG9DaGFydFBhdGhDb29yZGluYXRlcz4sXHJcbiAgICB0b3RhbFZhbHVlOiBudW1iZXIsXHJcbiAgICBoZWlnaHQ6IG51bWJlcixcclxuICAgIHN0YXJ0UmFkaWFuQW5nbGU6IG51bWJlcixcclxuICAgIGVuZFJhZGlhbkFuZ2xlOiBudW1iZXIsXHJcbiAgICBjdXJyZW50UmFkaWFuQW5nbGU6IG51bWJlciA9IDAsXHJcbiAgICBzZXJpZXNJbmRleDogbnVtYmVyID0gMFxyXG4gICkge1xyXG4gICAgY29uc3QgZmluaXNoZWRDdXJyZW50U2VyaWUgPSBjdXJyZW50UmFkaWFuQW5nbGUgPiBlbmRSYWRpYW5BbmdsZTtcclxuICAgIGNvbnN0IGZpbmlzaGVkQWxsU2VyaWVzID0gc2VyaWVzSW5kZXggPT09IHNlcmllcy5sZW5ndGg7XHJcblxyXG4gICAgaWYgKGZpbmlzaGVkQWxsU2VyaWVzKSB7XHJcbiAgICAgIHRoaXMuYW5pbWF0ZSA9IGZhbHNlO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGZpbmlzaGVkQ3VycmVudFNlcmllKSB7XHJcbiAgICAgIHRoaXMuc2V0U2VyaWVMYWJlbENvb3JkaW5hdGVzKHNlcmllc0luZGV4KTtcclxuICAgICAgY3VycmVudFJhZGlhbkFuZ2xlID0gMDtcclxuICAgICAgc2VyaWVzSW5kZXgrKztcclxuICAgICAgc3RhcnRSYWRpYW5BbmdsZSA9IHN0YXJ0UmFkaWFuQW5nbGUgKyBlbmRSYWRpYW5BbmdsZTtcclxuICAgICAgZW5kUmFkaWFuQW5nbGUgPVxyXG4gICAgICAgIHNlcmllc0luZGV4IDwgc2VyaWVzLmxlbmd0aCA/IHRoaXMuY2FsY3VsYXRlQW5nbGUoc2VyaWVzW3Nlcmllc0luZGV4XS5kYXRhLCB0b3RhbFZhbHVlKSA6IHVuZGVmaW5lZDtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGN1cnJlbnRSYWRpYW5BbmdsZSArPSBQb0NoYXJ0QW5nbGVTdGVwSW50ZXJ2YWw7XHJcblxyXG4gICAgICBjb25zdCBjdXJyZW50RW5kUmFkaWFuQW5nbGUgPSB0aGlzLmNhbGN1bGF0ZUN1cnJlbnRFbmRBbmdsZShjdXJyZW50UmFkaWFuQW5nbGUsIHN0YXJ0UmFkaWFuQW5nbGUsIGVuZFJhZGlhbkFuZ2xlKTtcclxuICAgICAgY29uc3QgY29vcmRpbmF0ZXMgPSB0aGlzLmNhbGN1bGF0ZUNvb3JkaW5hdGVzKGhlaWdodCwgc3RhcnRSYWRpYW5BbmdsZSwgY3VycmVudEVuZFJhZGlhbkFuZ2xlKTtcclxuXHJcbiAgICAgIHRoaXMuc3ZnUGF0aHMudG9BcnJheSgpW3Nlcmllc0luZGV4XS5hcHBseUNvb3JkaW5hdGVzKGNvb3JkaW5hdGVzKTtcclxuICAgIH1cclxuXHJcbiAgICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKFxyXG4gICAgICB0aGlzLmNhbGN1bGF0ZUNvb3JkaW5hdGVzV2l0aEFuaW1hdGlvbi5iaW5kKFxyXG4gICAgICAgIHRoaXMsXHJcbiAgICAgICAgc2VyaWVzLFxyXG4gICAgICAgIHRvdGFsVmFsdWUsXHJcbiAgICAgICAgaGVpZ2h0LFxyXG4gICAgICAgIHN0YXJ0UmFkaWFuQW5nbGUsXHJcbiAgICAgICAgZW5kUmFkaWFuQW5nbGUsXHJcbiAgICAgICAgY3VycmVudFJhZGlhbkFuZ2xlLFxyXG4gICAgICAgIHNlcmllc0luZGV4XHJcbiAgICAgIClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNhbGN1bGF0ZUN1cnJlbnRFbmRBbmdsZShjdXJyZW50UmFkaWFuQW5nbGU6IG51bWJlciwgc3RhcnRSYWRpYW5BbmdsZTogbnVtYmVyLCBlbmRSYWRpYW5BbmdsZTogbnVtYmVyKSB7XHJcbiAgICBjb25zdCBpc1NlcmllRHJhd0NvbXBsZXRlZCA9IHN0YXJ0UmFkaWFuQW5nbGUgKyBjdXJyZW50UmFkaWFuQW5nbGUgPiBzdGFydFJhZGlhbkFuZ2xlICsgZW5kUmFkaWFuQW5nbGU7XHJcblxyXG4gICAgcmV0dXJuIGlzU2VyaWVEcmF3Q29tcGxldGVkXHJcbiAgICAgID8gc3RhcnRSYWRpYW5BbmdsZSArIGVuZFJhZGlhbkFuZ2xlIC0gUG9DaGFydENvbXBsZXRlQ2lyY2xlXHJcbiAgICAgIDogc3RhcnRSYWRpYW5BbmdsZSArIGN1cnJlbnRSYWRpYW5BbmdsZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaW5pdERyYXdQYXRocyhzZXJpZXNMaXN0OiBBcnJheTxQb0NoYXJ0UGF0aENvb3JkaW5hdGVzPiwgdG90YWxWYWx1ZTogbnVtYmVyLCBoZWlnaHQ6IG51bWJlcikge1xyXG4gICAgaWYgKCF0aGlzLmFuaW1hdGUpIHtcclxuICAgICAgdGhpcy5jYWxjdWxhdGVTZXJpZUNvb3JkaW5hdGVzKHNlcmllc0xpc3QsIHRvdGFsVmFsdWUsIGhlaWdodCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCBzdGFydFJhZGlhbkFuZ2xlID0gUG9DaGFydFN0YXJ0QW5nbGU7XHJcbiAgICAgIGNvbnN0IGVuZFJhZGlhbkFuZ2xlID0gdGhpcy5jYWxjdWxhdGVBbmdsZShzZXJpZXNMaXN0WzBdLmRhdGEsIHRvdGFsVmFsdWUpO1xyXG5cclxuICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT5cclxuICAgICAgICB0aGlzLmNhbGN1bGF0ZUNvb3JkaW5hdGVzV2l0aEFuaW1hdGlvbihzZXJpZXNMaXN0LCB0b3RhbFZhbHVlLCBoZWlnaHQsIHN0YXJ0UmFkaWFuQW5nbGUsIGVuZFJhZGlhbkFuZ2xlKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRTZXJpZUxhYmVsQ29vcmRpbmF0ZXMoaW5kZXg6IG51bWJlcikge1xyXG4gICAgaWYgKHRoaXMuc3ZnTGFiZWxzLnRvQXJyYXkoKS5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5zdmdMYWJlbHMudG9BcnJheSgpW2luZGV4XS5hcHBseUNvb3JkaW5hdGVzKHRoaXMuc2VyaWVzTGFiZWxzW2luZGV4XSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHZhbGlkYXRlU2VyaWVzKHNlcmllczogQXJyYXk8UG9DaGFydFNlcmllPikge1xyXG4gICAgcmV0dXJuIHNlcmllcy5yZWR1Y2UoKHNlcmllc0xpc3QsIHNlcmllOiBhbnkpID0+IHtcclxuICAgICAgY29uc3QgZGF0YSA9IHNlcmllLmRhdGEgPz8gc2VyaWUudmFsdWU7XHJcbiAgICAgIGlmIChkYXRhICYmIGRhdGEgPiAwKSB7XHJcbiAgICAgICAgY29uc3QgY29sb3IgPSBzZXJpZS5jb2xvcjtcclxuICAgICAgICBjb25zdCBsYWJlbCA9IHNlcmllLmxhYmVsO1xyXG4gICAgICAgIGNvbnN0IHRvb2x0aXAgPSBzZXJpZS50b29sdGlwO1xyXG4gICAgICAgIGNvbnN0IHRvb2x0aXBMYWJlbCA9IHRoaXMuZ2V0VG9vbHRpcExhYmVsKGRhdGEsIGxhYmVsLCB0b29sdGlwKTtcclxuXHJcbiAgICAgICAgc2VyaWVzTGlzdCA9IFsuLi5zZXJpZXNMaXN0LCB7IGRhdGEsIGNvbG9yLCBsYWJlbCwgdG9vbHRpcExhYmVsIH1dO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4gc2VyaWVzTGlzdDtcclxuICAgIH0sIFtdKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBjYWxjdWxhdGVDb29yZGluYXRlcyhoZWlnaHQsIHN0YXJ0UmFkaWFuQW5nbGUsIGN1cnJlbnRFbmRSYWRpYW5BbmdsZSk7XHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldFRvb2x0aXBMYWJlbChkYXRhLCBsYWJlbCwgdG9vbHRpcCk7XHJcbn1cclxuIl19
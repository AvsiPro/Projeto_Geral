import { Component, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { isFirefox, isIE, isIEOrEdge, openExternalLink } from './../../../../utils/util';
import { PoKeyCodeEnum } from './../../../../enums/po-key-code.enum';
import { PoRichTextService } from '../po-rich-text.service';
const poRichTextBodyCommands = [
    'bold',
    'italic',
    'underline',
    'justifyleft',
    'justifycenter',
    'justifyright',
    'justifyfull',
    'insertUnorderedList',
    'Createlink'
];
export class PoRichTextBodyComponent {
    constructor(richTextService) {
        this.richTextService = richTextService;
        this.change = new EventEmitter();
        this.commands = new EventEmitter();
        this.selectedLink = new EventEmitter();
        this.shortcutCommand = new EventEmitter();
        this.value = new EventEmitter();
        this.blur = new EventEmitter();
        this.onAnchorClick = event => {
            const { target, ctrlKey, metaKey } = event;
            let url;
            let elementLink;
            if (ctrlKey || metaKey) {
                if (event.path) {
                    event.path.forEach(element => {
                        if (element.nodeName === 'A') {
                            url = element.href;
                            elementLink = element;
                        }
                    });
                }
                else {
                    url = target.attributes.href.value;
                    elementLink = target;
                }
                openExternalLink(url);
                elementLink.classList.remove('po-clickable');
            }
        };
    }
    ngOnInit() {
        this.bodyElement.nativeElement.designMode = 'on';
        this.modelSubscription = this.richTextService.getModel().subscribe(modelValue => {
            this.modelValue = modelValue;
            this.bodyElement.nativeElement.innerHTML = '';
            this.updateValueWithModelValue();
            this.addClickListenerOnAnchorElements();
        });
    }
    ngOnDestroy() {
        var _a;
        (_a = this.modelSubscription) === null || _a === void 0 ? void 0 : _a.unsubscribe();
    }
    executeCommand(command) {
        this.bodyElement.nativeElement.focus();
        if (typeof command === 'object') {
            if (command.command === 'InsertHTML') {
                const { command: linkCommand, value: { urlLink }, value: { urlLinkText } } = command;
                this.handleCommandLink(linkCommand, urlLink, urlLinkText);
            }
            else {
                document.execCommand(command.command, false, command.value);
            }
        }
        else {
            document.execCommand(command, false, null);
        }
        this.updateModel();
        this.value.emit(this.modelValue);
    }
    linkEditing(event) {
        this.isLinkEditing = !!event;
    }
    onBlur() {
        this.blur.emit();
        if (this.modelValue !== this.valueBeforeChange) {
            clearTimeout(this.timeoutChange);
            this.timeoutChange = setTimeout(() => {
                this.change.emit(this.modelValue);
            }, 200);
        }
    }
    focus() {
        this.bodyElement.nativeElement.focus();
    }
    onClick() {
        this.emitSelectionCommands();
    }
    onFocus() {
        this.valueBeforeChange = this.modelValue;
    }
    onKeyDown(event) {
        const keyK = event.keyCode === PoKeyCodeEnum.keyK;
        const isLinkShortcut = (keyK && event.ctrlKey) || (keyK && event.metaKey);
        if (isLinkShortcut) {
            event.preventDefault();
            this.shortcutCommand.emit();
        }
        this.toggleCursorOnLink(event, 'add');
    }
    onKeyUp(event) {
        this.toggleCursorOnLink(event, 'remove');
        this.removeBrElement();
        this.updateModel();
        this.emitSelectionCommands();
    }
    onPaste() {
        this.update();
        setTimeout(() => this.addClickListenerOnAnchorElements());
    }
    update() {
        setTimeout(() => this.updateModel());
        setTimeout(() => {
            this.removeBrElement();
            this.updateModel();
            this.emitSelectionCommands();
        });
    }
    addClickListenerOnAnchorElements() {
        this.bodyElement.nativeElement.querySelectorAll('a').forEach(element => {
            element.addEventListener('click', this.onAnchorClick);
        });
    }
    emitSelectionCommands() {
        const commands = poRichTextBodyCommands.filter(command => document.queryCommandState(command));
        const rgbColor = document.queryCommandValue('ForeColor');
        let hexColor;
        if (!isIE()) {
            hexColor = this.rgbToHex(rgbColor);
        }
        if (this.isCursorPositionedInALink()) {
            commands.push('Createlink');
        }
        this.selectedLink.emit(this.linkElement); // importante ficar fora do if para emitir mesmo undefined.
        this.commands.emit({ commands, hexColor });
    }
    getTextSelection() {
        const textSelection = document.getSelection();
        if (!textSelection) {
            return;
        }
        const focusNode = textSelection.focusNode ? textSelection.focusNode.parentElement : undefined;
        const anchorNode = textSelection.anchorNode ? textSelection.anchorNode.parentNode : undefined;
        const node = focusNode || anchorNode;
        let tagName;
        if (node) {
            tagName = node['tagName'] || node['nodeName'];
            return {
                node,
                tagName
            };
        }
    }
    handleCommandLink(linkCommand, urlLink, urlLinkText) {
        if (isIE()) {
            this.insertHtmlLinkElement(urlLink, urlLinkText);
        }
        else {
            // '&nbsp;' necessário para o cursor não ficar preso dentro do link no Firefox.
            const linkValue = isFirefox() && !this.isLinkEditing
                ? `&nbsp;${this.makeLinkTag(urlLink, urlLinkText)}&nbsp;`
                : this.makeLinkTag(urlLink, urlLinkText);
            document.execCommand(linkCommand, false, linkValue);
        }
        this.addClickListenerOnAnchorElements();
    }
    // tratamento específico para IE pois não suporta o comando 'insertHTML'.
    insertHtmlLinkElement(urlLink, urlLinkText) {
        const selection = document.getSelection();
        const selectionRange = selection.getRangeAt(0);
        const elementLink = document.createElement('a');
        const elementlinkText = document.createTextNode(urlLinkText);
        elementLink.appendChild(elementlinkText);
        elementLink.href = urlLink;
        elementLink.setAttribute('target', '_blank');
        elementLink.classList.add('po-rich-text-link');
        selectionRange.deleteContents();
        selectionRange.insertNode(elementLink);
    }
    isCursorPositionedInALink() {
        const textSelection = this.getTextSelection();
        this.linkElement = undefined;
        let isLink = false;
        if (textSelection && textSelection.node && textSelection.tagName === 'A') {
            this.linkElement = textSelection.node;
            isLink = true;
        }
        else if ((isFirefox() || isIEOrEdge()) && this.verifyCursorPositionInFirefoxIEEdge()) {
            isLink = true;
        }
        else {
            isLink = textSelection ? this.isParentNodeAnchor(textSelection) : false;
        }
        return isLink;
    }
    isParentNodeAnchor(textSelection) {
        let element = textSelection.node;
        let isLink = false;
        while (element && (element.tagName !== null || element.nodeName !== null)) {
            if (element.tagName === 'A' || element.nodeName === 'A') {
                this.linkElement = element;
                isLink = true;
                return isLink;
            }
            element = element.parentElement || element.parentNode;
        }
        this.linkElement = undefined;
        return isLink;
    }
    makeLinkTag(urlLink, urlLinkText) {
        return `<a class="po-rich-text-link" href="${urlLink}" target="_blank">${urlLinkText || urlLink}</a>`;
    }
    // Tratamento necessário para eliminar a tag <br> criada no firefox quando o body for limpo.
    removeBrElement() {
        const bodyElement = this.bodyElement.nativeElement;
        if (!bodyElement.innerText.trim() && bodyElement.childNodes.length === 1 && bodyElement.querySelector('br')) {
            bodyElement.querySelector('br').remove();
        }
    }
    rgbToHex(rgb) {
        // Tratamento necessário para converter o código rgb para hexadecimal.
        const sep = rgb.indexOf(',') > -1 ? ',' : ' ';
        rgb = rgb.substr(4).split(')')[0].split(sep);
        let r = (+rgb[0]).toString(16);
        let g = (+rgb[1]).toString(16);
        let b = (+rgb[2]).toString(16);
        if (r.length === 1) {
            r = '0' + r;
        }
        if (g.length === 1) {
            g = '0' + g;
        }
        if (b.length === 1) {
            b = '0' + b;
        }
        return '#' + r + g + b;
    }
    toggleCursorOnLink(event, action) {
        const selection = document.getSelection();
        const element = selection.focusNode ? selection.focusNode.parentNode : undefined;
        const isCtrl = event.key === 'Control';
        const isCommand = event.key === 'Meta';
        const isOnCtrlLink = this.isCursorPositionedInALink() && (isCtrl || isCommand);
        if (element) {
            if (isOnCtrlLink) {
                element['classList'][action]('po-clickable');
            }
            else {
                const isClickable = element['classList'] && element['classList'].contains('po-clickable');
                if (isClickable) {
                    element['classList'].remove('po-clickable');
                }
            }
            this.updateModel();
        }
    }
    updateModel() {
        this.modelValue = this.bodyElement.nativeElement.innerHTML;
        this.value.emit(this.modelValue);
    }
    updateValueWithModelValue() {
        if (this.modelValue) {
            this.bodyElement.nativeElement.insertAdjacentHTML('afterbegin', this.modelValue);
        }
    }
    verifyCursorPositionInFirefoxIEEdge() {
        const textSelection = document.getSelection();
        const nodeLink = textSelection.focusNode;
        let isLink = false;
        if (nodeLink && nodeLink.nodeName === 'A') {
            this.linkElement = nodeLink;
            isLink = true;
        }
        else {
            const range = textSelection.getRangeAt(0);
            const fragmentDocument = range.cloneContents();
            const element = fragmentDocument.childNodes[0] || fragmentDocument.firstElementChild;
            this.linkElement = element && element.nodeName === 'A' ? element : undefined;
            isLink = !!this.linkElement;
        }
        return isLink;
    }
}
PoRichTextBodyComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-rich-text-body',
                template: "<div\r\n  #bodyElement\r\n  class=\"po-rich-text-body\"\r\n  tabindex=\"0\"\r\n  [attr.contenteditable]=\"!readonly\"\r\n  [attr.data-placeholder]=\"placeholder\"\r\n  [style.height.px]=\"height\"\r\n  (blur)=\"onBlur()\"\r\n  (click)=\"onClick()\"\r\n  (cut)=\"update()\"\r\n  (focus)=\"onFocus()\"\r\n  (keydown)=\"onKeyDown($event)\"\r\n  (keyup)=\"onKeyUp($event)\"\r\n  (paste)=\"onPaste()\"\r\n></div>\r\n"
            },] }
];
PoRichTextBodyComponent.ctorParameters = () => [
    { type: PoRichTextService }
];
PoRichTextBodyComponent.propDecorators = {
    bodyElement: [{ type: ViewChild, args: ['bodyElement', { static: true },] }],
    height: [{ type: Input, args: ['p-height',] }],
    modelValue: [{ type: Input, args: ['p-model-value',] }],
    placeholder: [{ type: Input, args: ['p-placeholder',] }],
    readonly: [{ type: Input, args: ['p-readonly',] }],
    change: [{ type: Output, args: ['p-change',] }],
    commands: [{ type: Output, args: ['p-commands',] }],
    selectedLink: [{ type: Output, args: ['p-selected-link',] }],
    shortcutCommand: [{ type: Output, args: ['p-shortcut-command',] }],
    value: [{ type: Output, args: ['p-value',] }],
    blur: [{ type: Output, args: ['p-blur',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LWJvZHkuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLWZpZWxkL3BvLXJpY2gtdGV4dC9wby1yaWNoLXRleHQtYm9keS9wby1yaWNoLXRleHQtYm9keS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBYyxZQUFZLEVBQUUsS0FBSyxFQUFVLE1BQU0sRUFBRSxTQUFTLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFJakgsT0FBTyxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsVUFBVSxFQUFFLGdCQUFnQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFDekYsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHNDQUFzQyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRTVELE1BQU0sc0JBQXNCLEdBQUc7SUFDN0IsTUFBTTtJQUNOLFFBQVE7SUFDUixXQUFXO0lBQ1gsYUFBYTtJQUNiLGVBQWU7SUFDZixjQUFjO0lBQ2QsYUFBYTtJQUNiLHFCQUFxQjtJQUNyQixZQUFZO0NBQ2IsQ0FBQztBQU1GLE1BQU0sT0FBTyx1QkFBdUI7SUE2QmxDLFlBQW9CLGVBQWtDO1FBQWxDLG9CQUFlLEdBQWYsZUFBZSxDQUFtQjtRQWxCbEMsV0FBTSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFFL0IsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFFOUIsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBRXBDLG9CQUFlLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUVyRCxVQUFLLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUVqQyxTQUFJLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQTZOekMsa0JB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QU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7OztZQTlWRixTQUFTLFNBQUM7Z0JBQ1QsUUFBUSxFQUFFLG1CQUFtQjtnQkFDN0IsdWFBQWlEO2FBQ2xEOzs7WUFqQlEsaUJBQWlCOzs7MEJBbUJ2QixTQUFTLFNBQUMsYUFBYSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTtxQkFFekMsS0FBSyxTQUFDLFVBQVU7eUJBRWhCLEtBQUssU0FBQyxlQUFlOzBCQUVyQixLQUFLLFNBQUMsZUFBZTt1QkFFckIsS0FBSyxTQUFDLFlBQVk7cUJBRWxCLE1BQU0sU0FBQyxVQUFVO3VCQUVqQixNQUFNLFNBQUMsWUFBWTsyQkFFbkIsTUFBTSxTQUFDLGlCQUFpQjs4QkFFeEIsTUFBTSxTQUFDLG9CQUFvQjtvQkFFM0IsTUFBTSxTQUFDLFNBQVM7bUJBRWhCLE1BQU0sU0FBQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkluaXQsIE91dHB1dCwgVmlld0NoaWxkLCBPbkRlc3Ryb3kgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgaXNGaXJlZm94LCBpc0lFLCBpc0lFT3JFZGdlLCBvcGVuRXh0ZXJuYWxMaW5rIH0gZnJvbSAnLi8uLi8uLi8uLi8uLi91dGlscy91dGlsJztcclxuaW1wb3J0IHsgUG9LZXlDb2RlRW51bSB9IGZyb20gJy4vLi4vLi4vLi4vLi4vZW51bXMvcG8ta2V5LWNvZGUuZW51bSc7XHJcbmltcG9ydCB7IFBvUmljaFRleHRTZXJ2aWNlIH0gZnJvbSAnLi4vcG8tcmljaC10ZXh0LnNlcnZpY2UnO1xyXG5cclxuY29uc3QgcG9SaWNoVGV4dEJvZHlDb21tYW5kcyA9IFtcclxuICAnYm9sZCcsXHJcbiAgJ2l0YWxpYycsXHJcbiAgJ3VuZGVybGluZScsXHJcbiAgJ2p1c3RpZnlsZWZ0JyxcclxuICAnanVzdGlmeWNlbnRlcicsXHJcbiAgJ2p1c3RpZnlyaWdodCcsXHJcbiAgJ2p1c3RpZnlmdWxsJyxcclxuICAnaW5zZXJ0VW5vcmRlcmVkTGlzdCcsXHJcbiAgJ0NyZWF0ZWxpbmsnXHJcbl07XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3BvLXJpY2gtdGV4dC1ib2R5JyxcclxuICB0ZW1wbGF0ZVVybDogJy4vcG8tcmljaC10ZXh0LWJvZHkuY29tcG9uZW50Lmh0bWwnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQb1JpY2hUZXh0Qm9keUNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcclxuICBAVmlld0NoaWxkKCdib2R5RWxlbWVudCcsIHsgc3RhdGljOiB0cnVlIH0pIGJvZHlFbGVtZW50OiBFbGVtZW50UmVmO1xyXG5cclxuICBASW5wdXQoJ3AtaGVpZ2h0JykgaGVpZ2h0Pzogc3RyaW5nO1xyXG5cclxuICBASW5wdXQoJ3AtbW9kZWwtdmFsdWUnKSBtb2RlbFZhbHVlPzogc3RyaW5nO1xyXG5cclxuICBASW5wdXQoJ3AtcGxhY2Vob2xkZXInKSBwbGFjZWhvbGRlcj86IHN0cmluZztcclxuXHJcbiAgQElucHV0KCdwLXJlYWRvbmx5JykgcmVhZG9ubHk/OiBzdHJpbmc7XHJcblxyXG4gIEBPdXRwdXQoJ3AtY2hhbmdlJykgY2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIEBPdXRwdXQoJ3AtY29tbWFuZHMnKSBjb21tYW5kcyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICBAT3V0cHV0KCdwLXNlbGVjdGVkLWxpbmsnKSBzZWxlY3RlZExpbmsgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgQE91dHB1dCgncC1zaG9ydGN1dC1jb21tYW5kJykgc2hvcnRjdXRDb21tYW5kID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIEBPdXRwdXQoJ3AtdmFsdWUnKSB2YWx1ZSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xyXG5cclxuICBAT3V0cHV0KCdwLWJsdXInKSBibHVyID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIHByaXZhdGUgaXNMaW5rRWRpdGluZzogYm9vbGVhbjtcclxuICBwcml2YXRlIGxpbmtFbGVtZW50OiBhbnk7XHJcbiAgcHJpdmF0ZSB0aW1lb3V0Q2hhbmdlOiBhbnk7XHJcbiAgcHJpdmF0ZSB2YWx1ZUJlZm9yZUNoYW5nZTogYW55O1xyXG4gIHByaXZhdGUgbW9kZWxTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSByaWNoVGV4dFNlcnZpY2U6IFBvUmljaFRleHRTZXJ2aWNlKSB7fVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5kZXNpZ25Nb2RlID0gJ29uJztcclxuXHJcbiAgICB0aGlzLm1vZGVsU3Vic2NyaXB0aW9uID0gdGhpcy5yaWNoVGV4dFNlcnZpY2UuZ2V0TW9kZWwoKS5zdWJzY3JpYmUobW9kZWxWYWx1ZSA9PiB7XHJcbiAgICAgIHRoaXMubW9kZWxWYWx1ZSA9IG1vZGVsVmFsdWU7XHJcbiAgICAgIHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5pbm5lckhUTUwgPSAnJztcclxuICAgICAgdGhpcy51cGRhdGVWYWx1ZVdpdGhNb2RlbFZhbHVlKCk7XHJcbiAgICAgIHRoaXMuYWRkQ2xpY2tMaXN0ZW5lck9uQW5jaG9yRWxlbWVudHMoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLm1vZGVsU3Vic2NyaXB0aW9uPy51bnN1YnNjcmliZSgpO1xyXG4gIH1cclxuXHJcbiAgZXhlY3V0ZUNvbW1hbmQoY29tbWFuZDogc3RyaW5nIHwgeyBjb21tYW5kOiBhbnk7IHZhbHVlOiBzdHJpbmcgfCBhbnkgfSkge1xyXG4gICAgdGhpcy5ib2R5RWxlbWVudC5uYXRpdmVFbGVtZW50LmZvY3VzKCk7XHJcblxyXG4gICAgaWYgKHR5cGVvZiBjb21tYW5kID09PSAnb2JqZWN0Jykge1xyXG4gICAgICBpZiAoY29tbWFuZC5jb21tYW5kID09PSAnSW5zZXJ0SFRNTCcpIHtcclxuICAgICAgICBjb25zdCB7XHJcbiAgICAgICAgICBjb21tYW5kOiBsaW5rQ29tbWFuZCxcclxuICAgICAgICAgIHZhbHVlOiB7IHVybExpbmsgfSxcclxuICAgICAgICAgIHZhbHVlOiB7IHVybExpbmtUZXh0IH1cclxuICAgICAgICB9ID0gY29tbWFuZDtcclxuXHJcbiAgICAgICAgdGhpcy5oYW5kbGVDb21tYW5kTGluayhsaW5rQ29tbWFuZCwgdXJsTGluaywgdXJsTGlua1RleHQpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKGNvbW1hbmQuY29tbWFuZCwgZmFsc2UsIGNvbW1hbmQudmFsdWUpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBkb2N1bWVudC5leGVjQ29tbWFuZChjb21tYW5kLCBmYWxzZSwgbnVsbCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy51cGRhdGVNb2RlbCgpO1xyXG4gICAgdGhpcy52YWx1ZS5lbWl0KHRoaXMubW9kZWxWYWx1ZSk7XHJcbiAgfVxyXG5cclxuICBsaW5rRWRpdGluZyhldmVudCkge1xyXG4gICAgdGhpcy5pc0xpbmtFZGl0aW5nID0gISFldmVudDtcclxuICB9XHJcblxyXG4gIG9uQmx1cigpIHtcclxuICAgIHRoaXMuYmx1ci5lbWl0KCk7XHJcbiAgICBpZiAodGhpcy5tb2RlbFZhbHVlICE9PSB0aGlzLnZhbHVlQmVmb3JlQ2hhbmdlKSB7XHJcbiAgICAgIGNsZWFyVGltZW91dCh0aGlzLnRpbWVvdXRDaGFuZ2UpO1xyXG4gICAgICB0aGlzLnRpbWVvdXRDaGFuZ2UgPSBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICB0aGlzLmNoYW5nZS5lbWl0KHRoaXMubW9kZWxWYWx1ZSk7XHJcbiAgICAgIH0sIDIwMCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBmb2N1cygpOiB2b2lkIHtcclxuICAgIHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5mb2N1cygpO1xyXG4gIH1cclxuXHJcbiAgb25DbGljaygpIHtcclxuICAgIHRoaXMuZW1pdFNlbGVjdGlvbkNvbW1hbmRzKCk7XHJcbiAgfVxyXG5cclxuICBvbkZvY3VzKCkge1xyXG4gICAgdGhpcy52YWx1ZUJlZm9yZUNoYW5nZSA9IHRoaXMubW9kZWxWYWx1ZTtcclxuICB9XHJcblxyXG4gIG9uS2V5RG93bihldmVudCkge1xyXG4gICAgY29uc3Qga2V5SyA9IGV2ZW50LmtleUNvZGUgPT09IFBvS2V5Q29kZUVudW0ua2V5SztcclxuICAgIGNvbnN0IGlzTGlua1Nob3J0Y3V0ID0gKGtleUsgJiYgZXZlbnQuY3RybEtleSkgfHwgKGtleUsgJiYgZXZlbnQubWV0YUtleSk7XHJcblxyXG4gICAgaWYgKGlzTGlua1Nob3J0Y3V0KSB7XHJcbiAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIHRoaXMuc2hvcnRjdXRDb21tYW5kLmVtaXQoKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnRvZ2dsZUN1cnNvck9uTGluayhldmVudCwgJ2FkZCcpO1xyXG4gIH1cclxuXHJcbiAgb25LZXlVcChldmVudDogYW55KSB7XHJcbiAgICB0aGlzLnRvZ2dsZUN1cnNvck9uTGluayhldmVudCwgJ3JlbW92ZScpO1xyXG5cclxuICAgIHRoaXMucmVtb3ZlQnJFbGVtZW50KCk7XHJcbiAgICB0aGlzLnVwZGF0ZU1vZGVsKCk7XHJcbiAgICB0aGlzLmVtaXRTZWxlY3Rpb25Db21tYW5kcygpO1xyXG4gIH1cclxuXHJcbiAgb25QYXN0ZSgpIHtcclxuICAgIHRoaXMudXBkYXRlKCk7XHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuYWRkQ2xpY2tMaXN0ZW5lck9uQW5jaG9yRWxlbWVudHMoKSk7XHJcbiAgfVxyXG5cclxuICB1cGRhdGUoKSB7XHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMudXBkYXRlTW9kZWwoKSk7XHJcblxyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIHRoaXMucmVtb3ZlQnJFbGVtZW50KCk7XHJcbiAgICAgIHRoaXMudXBkYXRlTW9kZWwoKTtcclxuICAgICAgdGhpcy5lbWl0U2VsZWN0aW9uQ29tbWFuZHMoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhZGRDbGlja0xpc3RlbmVyT25BbmNob3JFbGVtZW50cygpIHtcclxuICAgIHRoaXMuYm9keUVsZW1lbnQubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCdhJykuZm9yRWFjaChlbGVtZW50ID0+IHtcclxuICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMub25BbmNob3JDbGljayk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZW1pdFNlbGVjdGlvbkNvbW1hbmRzKCkge1xyXG4gICAgY29uc3QgY29tbWFuZHMgPSBwb1JpY2hUZXh0Qm9keUNvbW1hbmRzLmZpbHRlcihjb21tYW5kID0+IGRvY3VtZW50LnF1ZXJ5Q29tbWFuZFN0YXRlKGNvbW1hbmQpKTtcclxuICAgIGNvbnN0IHJnYkNvbG9yID0gZG9jdW1lbnQucXVlcnlDb21tYW5kVmFsdWUoJ0ZvcmVDb2xvcicpO1xyXG5cclxuICAgIGxldCBoZXhDb2xvcjtcclxuICAgIGlmICghaXNJRSgpKSB7XHJcbiAgICAgIGhleENvbG9yID0gdGhpcy5yZ2JUb0hleChyZ2JDb2xvcik7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHRoaXMuaXNDdXJzb3JQb3NpdGlvbmVkSW5BTGluaygpKSB7XHJcbiAgICAgIGNvbW1hbmRzLnB1c2goJ0NyZWF0ZWxpbmsnKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnNlbGVjdGVkTGluay5lbWl0KHRoaXMubGlua0VsZW1lbnQpOyAvLyBpbXBvcnRhbnRlIGZpY2FyIGZvcmEgZG8gaWYgcGFyYSBlbWl0aXIgbWVzbW8gdW5kZWZpbmVkLlxyXG4gICAgdGhpcy5jb21tYW5kcy5lbWl0KHsgY29tbWFuZHMsIGhleENvbG9yIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRUZXh0U2VsZWN0aW9uKCkge1xyXG4gICAgY29uc3QgdGV4dFNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpO1xyXG4gICAgaWYgKCF0ZXh0U2VsZWN0aW9uKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICAgIGNvbnN0IGZvY3VzTm9kZSA9IHRleHRTZWxlY3Rpb24uZm9jdXNOb2RlID8gdGV4dFNlbGVjdGlvbi5mb2N1c05vZGUucGFyZW50RWxlbWVudCA6IHVuZGVmaW5lZDtcclxuICAgIGNvbnN0IGFuY2hvck5vZGUgPSB0ZXh0U2VsZWN0aW9uLmFuY2hvck5vZGUgPyB0ZXh0U2VsZWN0aW9uLmFuY2hvck5vZGUucGFyZW50Tm9kZSA6IHVuZGVmaW5lZDtcclxuICAgIGNvbnN0IG5vZGUgPSBmb2N1c05vZGUgfHwgYW5jaG9yTm9kZTtcclxuICAgIGxldCB0YWdOYW1lO1xyXG5cclxuICAgIGlmIChub2RlKSB7XHJcbiAgICAgIHRhZ05hbWUgPSBub2RlWyd0YWdOYW1lJ10gfHwgbm9kZVsnbm9kZU5hbWUnXTtcclxuICAgICAgcmV0dXJuIHtcclxuICAgICAgICBub2RlLFxyXG4gICAgICAgIHRhZ05hbWVcclxuICAgICAgfTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFuZGxlQ29tbWFuZExpbmsobGlua0NvbW1hbmQ6IHN0cmluZywgdXJsTGluazogc3RyaW5nLCB1cmxMaW5rVGV4dDogc3RyaW5nKSB7XHJcbiAgICBpZiAoaXNJRSgpKSB7XHJcbiAgICAgIHRoaXMuaW5zZXJ0SHRtbExpbmtFbGVtZW50KHVybExpbmssIHVybExpbmtUZXh0KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIC8vICcmbmJzcDsnIG5lY2Vzc8OhcmlvIHBhcmEgbyBjdXJzb3IgbsOjbyBmaWNhciBwcmVzbyBkZW50cm8gZG8gbGluayBubyBGaXJlZm94LlxyXG4gICAgICBjb25zdCBsaW5rVmFsdWUgPVxyXG4gICAgICAgIGlzRmlyZWZveCgpICYmICF0aGlzLmlzTGlua0VkaXRpbmdcclxuICAgICAgICAgID8gYCZuYnNwOyR7dGhpcy5tYWtlTGlua1RhZyh1cmxMaW5rLCB1cmxMaW5rVGV4dCl9Jm5ic3A7YFxyXG4gICAgICAgICAgOiB0aGlzLm1ha2VMaW5rVGFnKHVybExpbmssIHVybExpbmtUZXh0KTtcclxuXHJcbiAgICAgIGRvY3VtZW50LmV4ZWNDb21tYW5kKGxpbmtDb21tYW5kLCBmYWxzZSwgbGlua1ZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLmFkZENsaWNrTGlzdGVuZXJPbkFuY2hvckVsZW1lbnRzKCk7XHJcbiAgfVxyXG5cclxuICAvLyB0cmF0YW1lbnRvIGVzcGVjw61maWNvIHBhcmEgSUUgcG9pcyBuw6NvIHN1cG9ydGEgbyBjb21hbmRvICdpbnNlcnRIVE1MJy5cclxuICBwcml2YXRlIGluc2VydEh0bWxMaW5rRWxlbWVudCh1cmxMaW5rOiBzdHJpbmcsIHVybExpbmtUZXh0OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpO1xyXG4gICAgY29uc3Qgc2VsZWN0aW9uUmFuZ2UgPSBzZWxlY3Rpb24uZ2V0UmFuZ2VBdCgwKTtcclxuICAgIGNvbnN0IGVsZW1lbnRMaW5rID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpO1xyXG4gICAgY29uc3QgZWxlbWVudGxpbmtUZXh0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodXJsTGlua1RleHQpO1xyXG5cclxuICAgIGVsZW1lbnRMaW5rLmFwcGVuZENoaWxkKGVsZW1lbnRsaW5rVGV4dCk7XHJcbiAgICBlbGVtZW50TGluay5ocmVmID0gdXJsTGluaztcclxuICAgIGVsZW1lbnRMaW5rLnNldEF0dHJpYnV0ZSgndGFyZ2V0JywgJ19ibGFuaycpO1xyXG4gICAgZWxlbWVudExpbmsuY2xhc3NMaXN0LmFkZCgncG8tcmljaC10ZXh0LWxpbmsnKTtcclxuXHJcbiAgICBzZWxlY3Rpb25SYW5nZS5kZWxldGVDb250ZW50cygpO1xyXG4gICAgc2VsZWN0aW9uUmFuZ2UuaW5zZXJ0Tm9kZShlbGVtZW50TGluayk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzQ3Vyc29yUG9zaXRpb25lZEluQUxpbmsoKTogYm9vbGVhbiB7XHJcbiAgICBjb25zdCB0ZXh0U2VsZWN0aW9uID0gdGhpcy5nZXRUZXh0U2VsZWN0aW9uKCk7XHJcbiAgICB0aGlzLmxpbmtFbGVtZW50ID0gdW5kZWZpbmVkO1xyXG5cclxuICAgIGxldCBpc0xpbmsgPSBmYWxzZTtcclxuXHJcbiAgICBpZiAodGV4dFNlbGVjdGlvbiAmJiB0ZXh0U2VsZWN0aW9uLm5vZGUgJiYgdGV4dFNlbGVjdGlvbi50YWdOYW1lID09PSAnQScpIHtcclxuICAgICAgdGhpcy5saW5rRWxlbWVudCA9IHRleHRTZWxlY3Rpb24ubm9kZTtcclxuICAgICAgaXNMaW5rID0gdHJ1ZTtcclxuICAgIH0gZWxzZSBpZiAoKGlzRmlyZWZveCgpIHx8IGlzSUVPckVkZ2UoKSkgJiYgdGhpcy52ZXJpZnlDdXJzb3JQb3NpdGlvbkluRmlyZWZveElFRWRnZSgpKSB7XHJcbiAgICAgIGlzTGluayA9IHRydWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBpc0xpbmsgPSB0ZXh0U2VsZWN0aW9uID8gdGhpcy5pc1BhcmVudE5vZGVBbmNob3IodGV4dFNlbGVjdGlvbikgOiBmYWxzZTtcclxuICAgIH1cclxuICAgIHJldHVybiBpc0xpbms7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGlzUGFyZW50Tm9kZUFuY2hvcih0ZXh0U2VsZWN0aW9uKTogYm9vbGVhbiB7XHJcbiAgICBsZXQgZWxlbWVudCA9IHRleHRTZWxlY3Rpb24ubm9kZTtcclxuICAgIGxldCBpc0xpbmsgPSBmYWxzZTtcclxuXHJcbiAgICB3aGlsZSAoZWxlbWVudCAmJiAoZWxlbWVudC50YWdOYW1lICE9PSBudWxsIHx8IGVsZW1lbnQubm9kZU5hbWUgIT09IG51bGwpKSB7XHJcbiAgICAgIGlmIChlbGVtZW50LnRhZ05hbWUgPT09ICdBJyB8fCBlbGVtZW50Lm5vZGVOYW1lID09PSAnQScpIHtcclxuICAgICAgICB0aGlzLmxpbmtFbGVtZW50ID0gZWxlbWVudDtcclxuICAgICAgICBpc0xpbmsgPSB0cnVlO1xyXG4gICAgICAgIHJldHVybiBpc0xpbms7XHJcbiAgICAgIH1cclxuICAgICAgZWxlbWVudCA9IGVsZW1lbnQucGFyZW50RWxlbWVudCB8fCBlbGVtZW50LnBhcmVudE5vZGU7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5saW5rRWxlbWVudCA9IHVuZGVmaW5lZDtcclxuICAgIHJldHVybiBpc0xpbms7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG1ha2VMaW5rVGFnKHVybExpbms6IHN0cmluZywgdXJsTGlua1RleHQ6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGA8YSBjbGFzcz1cInBvLXJpY2gtdGV4dC1saW5rXCIgaHJlZj1cIiR7dXJsTGlua31cIiB0YXJnZXQ9XCJfYmxhbmtcIj4ke3VybExpbmtUZXh0IHx8IHVybExpbmt9PC9hPmA7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG9uQW5jaG9yQ2xpY2sgPSBldmVudCA9PiB7XHJcbiAgICBjb25zdCB7IHRhcmdldCwgY3RybEtleSwgbWV0YUtleSB9ID0gZXZlbnQ7XHJcbiAgICBsZXQgdXJsO1xyXG4gICAgbGV0IGVsZW1lbnRMaW5rO1xyXG5cclxuICAgIGlmIChjdHJsS2V5IHx8IG1ldGFLZXkpIHtcclxuICAgICAgaWYgKGV2ZW50LnBhdGgpIHtcclxuICAgICAgICBldmVudC5wYXRoLmZvckVhY2goZWxlbWVudCA9PiB7XHJcbiAgICAgICAgICBpZiAoZWxlbWVudC5ub2RlTmFtZSA9PT0gJ0EnKSB7XHJcbiAgICAgICAgICAgIHVybCA9IGVsZW1lbnQuaHJlZjtcclxuICAgICAgICAgICAgZWxlbWVudExpbmsgPSBlbGVtZW50O1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHVybCA9IHRhcmdldC5hdHRyaWJ1dGVzLmhyZWYudmFsdWU7XHJcbiAgICAgICAgZWxlbWVudExpbmsgPSB0YXJnZXQ7XHJcbiAgICAgIH1cclxuICAgICAgb3BlbkV4dGVybmFsTGluayh1cmwpO1xyXG4gICAgICBlbGVtZW50TGluay5jbGFzc0xpc3QucmVtb3ZlKCdwby1jbGlja2FibGUnKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICAvLyBUcmF0YW1lbnRvIG5lY2Vzc8OhcmlvIHBhcmEgZWxpbWluYXIgYSB0YWcgPGJyPiBjcmlhZGEgbm8gZmlyZWZveCBxdWFuZG8gbyBib2R5IGZvciBsaW1wby5cclxuICBwcml2YXRlIHJlbW92ZUJyRWxlbWVudCgpIHtcclxuICAgIGNvbnN0IGJvZHlFbGVtZW50ID0gdGhpcy5ib2R5RWxlbWVudC5uYXRpdmVFbGVtZW50O1xyXG5cclxuICAgIGlmICghYm9keUVsZW1lbnQuaW5uZXJUZXh0LnRyaW0oKSAmJiBib2R5RWxlbWVudC5jaGlsZE5vZGVzLmxlbmd0aCA9PT0gMSAmJiBib2R5RWxlbWVudC5xdWVyeVNlbGVjdG9yKCdicicpKSB7XHJcbiAgICAgIGJvZHlFbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJ2JyJykucmVtb3ZlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJnYlRvSGV4KHJnYikge1xyXG4gICAgLy8gVHJhdGFtZW50byBuZWNlc3PDoXJpbyBwYXJhIGNvbnZlcnRlciBvIGPDs2RpZ28gcmdiIHBhcmEgaGV4YWRlY2ltYWwuXHJcbiAgICBjb25zdCBzZXAgPSByZ2IuaW5kZXhPZignLCcpID4gLTEgPyAnLCcgOiAnICc7XHJcbiAgICByZ2IgPSByZ2Iuc3Vic3RyKDQpLnNwbGl0KCcpJylbMF0uc3BsaXQoc2VwKTtcclxuXHJcbiAgICBsZXQgciA9ICgrcmdiWzBdKS50b1N0cmluZygxNik7XHJcbiAgICBsZXQgZyA9ICgrcmdiWzFdKS50b1N0cmluZygxNik7XHJcbiAgICBsZXQgYiA9ICgrcmdiWzJdKS50b1N0cmluZygxNik7XHJcblxyXG4gICAgaWYgKHIubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgIHIgPSAnMCcgKyByO1xyXG4gICAgfVxyXG4gICAgaWYgKGcubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgIGcgPSAnMCcgKyBnO1xyXG4gICAgfVxyXG4gICAgaWYgKGIubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgIGIgPSAnMCcgKyBiO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiAnIycgKyByICsgZyArIGI7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRvZ2dsZUN1cnNvck9uTGluayhldmVudDogYW55LCBhY3Rpb246ICdhZGQnIHwgJ3JlbW92ZScpIHtcclxuICAgIGNvbnN0IHNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpO1xyXG4gICAgY29uc3QgZWxlbWVudCA9IHNlbGVjdGlvbi5mb2N1c05vZGUgPyBzZWxlY3Rpb24uZm9jdXNOb2RlLnBhcmVudE5vZGUgOiB1bmRlZmluZWQ7XHJcbiAgICBjb25zdCBpc0N0cmwgPSBldmVudC5rZXkgPT09ICdDb250cm9sJztcclxuICAgIGNvbnN0IGlzQ29tbWFuZCA9IGV2ZW50LmtleSA9PT0gJ01ldGEnO1xyXG4gICAgY29uc3QgaXNPbkN0cmxMaW5rID0gdGhpcy5pc0N1cnNvclBvc2l0aW9uZWRJbkFMaW5rKCkgJiYgKGlzQ3RybCB8fCBpc0NvbW1hbmQpO1xyXG5cclxuICAgIGlmIChlbGVtZW50KSB7XHJcbiAgICAgIGlmIChpc09uQ3RybExpbmspIHtcclxuICAgICAgICBlbGVtZW50WydjbGFzc0xpc3QnXVthY3Rpb25dKCdwby1jbGlja2FibGUnKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCBpc0NsaWNrYWJsZSA9IGVsZW1lbnRbJ2NsYXNzTGlzdCddICYmIGVsZW1lbnRbJ2NsYXNzTGlzdCddLmNvbnRhaW5zKCdwby1jbGlja2FibGUnKTtcclxuXHJcbiAgICAgICAgaWYgKGlzQ2xpY2thYmxlKSB7XHJcbiAgICAgICAgICBlbGVtZW50WydjbGFzc0xpc3QnXS5yZW1vdmUoJ3BvLWNsaWNrYWJsZScpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgICB0aGlzLnVwZGF0ZU1vZGVsKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZU1vZGVsKCkge1xyXG4gICAgdGhpcy5tb2RlbFZhbHVlID0gdGhpcy5ib2R5RWxlbWVudC5uYXRpdmVFbGVtZW50LmlubmVySFRNTDtcclxuXHJcbiAgICB0aGlzLnZhbHVlLmVtaXQodGhpcy5tb2RlbFZhbHVlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlVmFsdWVXaXRoTW9kZWxWYWx1ZSgpIHtcclxuICAgIGlmICh0aGlzLm1vZGVsVmFsdWUpIHtcclxuICAgICAgdGhpcy5ib2R5RWxlbWVudC5uYXRpdmVFbGVtZW50Lmluc2VydEFkamFjZW50SFRNTCgnYWZ0ZXJiZWdpbicsIHRoaXMubW9kZWxWYWx1ZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHZlcmlmeUN1cnNvclBvc2l0aW9uSW5GaXJlZm94SUVFZGdlKCk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgdGV4dFNlbGVjdGlvbiA9IGRvY3VtZW50LmdldFNlbGVjdGlvbigpO1xyXG4gICAgY29uc3Qgbm9kZUxpbmsgPSB0ZXh0U2VsZWN0aW9uLmZvY3VzTm9kZTtcclxuICAgIGxldCBpc0xpbmsgPSBmYWxzZTtcclxuXHJcbiAgICBpZiAobm9kZUxpbmsgJiYgbm9kZUxpbmsubm9kZU5hbWUgPT09ICdBJykge1xyXG4gICAgICB0aGlzLmxpbmtFbGVtZW50ID0gbm9kZUxpbms7XHJcbiAgICAgIGlzTGluayA9IHRydWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjb25zdCByYW5nZSA9IHRleHRTZWxlY3Rpb24uZ2V0UmFuZ2VBdCgwKTtcclxuICAgICAgY29uc3QgZnJhZ21lbnREb2N1bWVudCA9IHJhbmdlLmNsb25lQ29udGVudHMoKTtcclxuICAgICAgY29uc3QgZWxlbWVudCA9IGZyYWdtZW50RG9jdW1lbnQuY2hpbGROb2Rlc1swXSB8fCBmcmFnbWVudERvY3VtZW50LmZpcnN0RWxlbWVudENoaWxkO1xyXG5cclxuICAgICAgdGhpcy5saW5rRWxlbWVudCA9IGVsZW1lbnQgJiYgZWxlbWVudC5ub2RlTmFtZSA9PT0gJ0EnID8gZWxlbWVudCA6IHVuZGVmaW5lZDtcclxuICAgICAgaXNMaW5rID0gISF0aGlzLmxpbmtFbGVtZW50O1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBpc0xpbms7XHJcbiAgfVxyXG59XHJcbiJdfQ==
import { ChangeDetectorRef, Component, ElementRef, Renderer2, ViewChild, ViewContainerRef } from '@angular/core';
import { Router } from '@angular/router';
import { isExternalLink, isTypeof, openExternalLink } from '../../utils/util';
import { PoControlPositionService } from '../../services/po-control-position/po-control-position.service';
import { PoPopupBaseComponent } from './po-popup-base.component';
/**
 *
 * @docsExtends PoPopupBaseComponent
 *
 * @example
 *
 * <example name="po-popup-basic" title="PO Popup - Basic">
 *   <file name="sample-po-popup-basic/sample-po-popup-basic.component.html"> </file>
 *   <file name="sample-po-popup-basic/sample-po-popup-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-popup-labs" title="PO Popup - Labs">
 *   <file name="sample-po-popup-labs/sample-po-popup-labs.component.html"> </file>
 *   <file name="sample-po-popup-labs/sample-po-popup-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-popup-email" title="PO Popup Email">
 *   <file name="sample-po-popup-email/sample-po-popup-email.component.html"> </file>
 *   <file name="sample-po-popup-email/sample-po-popup-email.component.ts"> </file>
 * </example>
 *
 */
export class PoPopupComponent extends PoPopupBaseComponent {
    constructor(viewContainerRef, renderer, router, poControlPosition, changeDetector) {
        super();
        this.renderer = renderer;
        this.router = router;
        this.poControlPosition = poControlPosition;
        this.changeDetector = changeDetector;
        this.onScroll = ({ target }) => {
            if (this.showPopup && target.className !== 'po-popup-container') {
                this.close();
            }
        };
    }
    /**
     * Fecha o componente *popup*.
     *
     * > Por padrão, este comportamento é acionado somente ao clicar fora do componente ou em determinada ação / url.
     */
    close() {
        this.removeListeners();
        this.showPopup = false;
    }
    onActionClick(popupAction) {
        const actionNoDisabled = popupAction && !this.returnBooleanValue(popupAction, 'disabled');
        if (popupAction && popupAction.action && actionNoDisabled) {
            this.close();
            popupAction.action(this.param || popupAction);
        }
        if (popupAction && popupAction.url && actionNoDisabled) {
            this.close();
            return this.openUrl(popupAction.url);
        }
    }
    /**
     * Abre o componente *popup*.
     *
     * > É possível informar um parâmetro que será utilizado na execução da ação do item e na função de desabilitar.
     */
    open(param) {
        this.oldTarget = this.target;
        this.param = param;
        this.showPopup = true;
        this.changeDetector.detectChanges();
        this.validateInitialContent();
    }
    returnBooleanValue(popupAction, property) {
        return isTypeof(popupAction[property], 'function')
            ? popupAction[property](this.param || popupAction)
            : popupAction[property];
    }
    /**
     * Responsável por abrir e fechar o *popup*.
     *
     * Quando disparado abrirá o *popup* e caso o mesmo já estiver aberto e possuir o mesmo `target` irá fecha-lo.
     *
     * É possível informar um parâmetro que será utilizado na execução da ação do item e na função de desabilitar.
     */
    toggle(param) {
        this.showPopup && this.oldTarget === this.target ? this.close() : this.open(param);
    }
    clickedOutDisabledItem(event) {
        const containsItemDisabled = this.elementContains(event.target, 'po-popup-item-disabled') ||
            this.elementContains(event.target.parentElement, 'po-popup-item-disabled');
        return !containsItemDisabled;
    }
    clickedOutHeaderTemplate(event) {
        const popupHeaderTemplate = this.popupRef && this.popupRef.nativeElement.querySelector('[p-popup-header-template]');
        return !(popupHeaderTemplate && popupHeaderTemplate.contains(event.target));
    }
    clickedOutTarget(event) {
        return this.target && !this.target.contains(event.target);
    }
    closePopupOnClickout(event) {
        if (this.clickedOutTarget(event) && this.clickedOutDisabledItem(event) && this.clickedOutHeaderTemplate(event)) {
            this.close();
        }
    }
    elementContains(element, className) {
        return element && element.classList.contains(className);
    }
    hasContentToShow() {
        return !!(this.popupRef.nativeElement && this.popupRef.nativeElement.clientHeight);
    }
    initializeListeners() {
        this.resizeListener = this.renderer.listen('window', 'resize', () => {
            this.close();
        });
        this.clickoutListener = this.renderer.listen('document', 'click', (event) => {
            this.closePopupOnClickout(event);
        });
        window.addEventListener('scroll', this.onScroll, true);
    }
    openUrl(url) {
        if (isExternalLink(url)) {
            return openExternalLink(url);
        }
        if (url) {
            return this.router.navigate([url]);
        }
    }
    removeListeners() {
        if (this.clickoutListener) {
            this.clickoutListener();
        }
        if (this.resizeListener) {
            this.resizeListener();
        }
        window.removeEventListener('scroll', this.onScroll, true);
    }
    setPosition() {
        this.poControlPosition.setElements(this.popupRef.nativeElement, 8, this.target, this.customPositions, false, this.isCornerAlign);
        this.poControlPosition.adjustPosition(this.position);
        this.arrowDirection = this.poControlPosition.getArrowDirection();
    }
    validateInitialContent() {
        if (this.hasContentToShow()) {
            this.setPosition();
            this.initializeListeners();
        }
        else {
            this.close();
        }
    }
}
PoPopupComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-popup',
                template: "<div #popupRef class=\"po-popup\" *ngIf=\"showPopup\">\r\n  <div *ngIf=\"!hideArrow\" class=\"po-popup-arrow po-arrow-{{ arrowDirection }}\"></div>\r\n\r\n  <ng-content select=\"[p-popup-header-template]\"></ng-content>\r\n\r\n  <div class=\"po-popup-container\">\r\n    <ng-container *ngFor=\"let action of actions; let actionIndex = index\">\r\n      <div\r\n        *ngIf=\"action.visible !== false\"\r\n        [class.po-popup-item-default]=\"action.type !== 'danger'\"\r\n        [class.po-popup-item-danger]=\"action.type === 'danger'\"\r\n        [class.po-popup-item-disabled]=\"returnBooleanValue(action, 'disabled')\"\r\n        [class.po-popup-item-separator]=\"action.separator && actionIndex !== 0\"\r\n        [class.po-popup-item-selected]=\"action.selected\"\r\n        (click)=\"onActionClick(action)\"\r\n      >\r\n        <po-icon *ngIf=\"action.icon\" class=\"po-popup-icon-item po-icon\" [p-icon]=\"action.icon\"></po-icon>\r\n        {{ action.label }}\r\n      </div>\r\n    </ng-container>\r\n  </div>\r\n</div>\r\n",
                providers: [PoControlPositionService]
            },] }
];
PoPopupComponent.ctorParameters = () => [
    { type: ViewContainerRef },
    { type: Renderer2 },
    { type: Router },
    { type: PoControlPositionService },
    { type: ChangeDetectorRef }
];
PoPopupComponent.propDecorators = {
    popupRef: [{ type: ViewChild, args: ['popupRef', { read: ElementRef },] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcG9wdXAuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLXBvcHVwL3BvLXBvcHVwLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2pILE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUV6QyxPQUFPLEVBQWdCLGNBQWMsRUFBRSxRQUFRLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUM1RixPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxnRUFBZ0UsQ0FBQztBQUcxRyxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUVqRTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBcUJHO0FBTUgsTUFBTSxPQUFPLGdCQUFpQixTQUFRLG9CQUFvQjtJQUd4RCxZQUNFLGdCQUFrQyxFQUMxQixRQUFtQixFQUNuQixNQUFjLEVBQ2QsaUJBQTJDLEVBQzVDLGNBQWlDO1FBRXhDLEtBQUssRUFBRSxDQUFDO1FBTEEsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUNuQixXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQ2Qsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUEwQjtRQUM1QyxtQkFBYyxHQUFkLGNBQWMsQ0FBbUI7UUF1R2xDLGFBQVEsR0FBRyxDQUFDLEVBQUUsTUFBTSxFQUFFLEVBQVEsRUFBRTtZQUN0QyxJQUFJLElBQUksQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDLFNBQVMsS0FBSyxvQkFBb0IsRUFBRTtnQkFDL0QsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO2FBQ2Q7UUFDSCxDQUFDLENBQUM7SUF4R0Ys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QUFTLFNBQUMsVUFBVSxFQUFFLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIEVsZW1lbnRSZWYsIFJlbmRlcmVyMiwgVmlld0NoaWxkLCBWaWV3Q29udGFpbmVyUmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IFJvdXRlciB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcblxyXG5pbXBvcnQgeyBjYWxsRnVuY3Rpb24sIGlzRXh0ZXJuYWxMaW5rLCBpc1R5cGVvZiwgb3BlbkV4dGVybmFsTGluayB9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWwnO1xyXG5pbXBvcnQgeyBQb0NvbnRyb2xQb3NpdGlvblNlcnZpY2UgfSBmcm9tICcuLi8uLi9zZXJ2aWNlcy9wby1jb250cm9sLXBvc2l0aW9uL3BvLWNvbnRyb2wtcG9zaXRpb24uc2VydmljZSc7XHJcblxyXG5pbXBvcnQgeyBQb1BvcHVwQWN0aW9uIH0gZnJvbSAnLi9wby1wb3B1cC1hY3Rpb24uaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgUG9Qb3B1cEJhc2VDb21wb25lbnQgfSBmcm9tICcuL3BvLXBvcHVwLWJhc2UuY29tcG9uZW50JztcclxuXHJcbi8qKlxyXG4gKlxyXG4gKiBAZG9jc0V4dGVuZHMgUG9Qb3B1cEJhc2VDb21wb25lbnRcclxuICpcclxuICogQGV4YW1wbGVcclxuICpcclxuICogPGV4YW1wbGUgbmFtZT1cInBvLXBvcHVwLWJhc2ljXCIgdGl0bGU9XCJQTyBQb3B1cCAtIEJhc2ljXCI+XHJcbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1wb3B1cC1iYXNpYy9zYW1wbGUtcG8tcG9wdXAtYmFzaWMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxyXG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tcG9wdXAtYmFzaWMvc2FtcGxlLXBvLXBvcHVwLWJhc2ljLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XHJcbiAqIDwvZXhhbXBsZT5cclxuICpcclxuICogPGV4YW1wbGUgbmFtZT1cInBvLXBvcHVwLWxhYnNcIiB0aXRsZT1cIlBPIFBvcHVwIC0gTGFic1wiPlxyXG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tcG9wdXAtbGFicy9zYW1wbGUtcG8tcG9wdXAtbGFicy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XHJcbiAqICAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1wb3B1cC1sYWJzL3NhbXBsZS1wby1wb3B1cC1sYWJzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XHJcbiAqIDwvZXhhbXBsZT5cclxuICpcclxuICogPGV4YW1wbGUgbmFtZT1cInBvLXBvcHVwLWVtYWlsXCIgdGl0bGU9XCJQTyBQb3B1cCBFbWFpbFwiPlxyXG4gKiAgIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tcG9wdXAtZW1haWwvc2FtcGxlLXBvLXBvcHVwLWVtYWlsLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cclxuICogICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXBvcHVwLWVtYWlsL3NhbXBsZS1wby1wb3B1cC1lbWFpbC5jb21wb25lbnQudHNcIj4gPC9maWxlPlxyXG4gKiA8L2V4YW1wbGU+XHJcbiAqXHJcbiAqL1xyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3BvLXBvcHVwJyxcclxuICB0ZW1wbGF0ZVVybDogJy4vcG8tcG9wdXAuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHByb3ZpZGVyczogW1BvQ29udHJvbFBvc2l0aW9uU2VydmljZV1cclxufSlcclxuZXhwb3J0IGNsYXNzIFBvUG9wdXBDb21wb25lbnQgZXh0ZW5kcyBQb1BvcHVwQmFzZUNvbXBvbmVudCB7XHJcbiAgQFZpZXdDaGlsZCgncG9wdXBSZWYnLCB7IHJlYWQ6IEVsZW1lbnRSZWYgfSkgcG9wdXBSZWY6IEVsZW1lbnRSZWY7XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgdmlld0NvbnRhaW5lclJlZjogVmlld0NvbnRhaW5lclJlZixcclxuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMixcclxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsXHJcbiAgICBwcml2YXRlIHBvQ29udHJvbFBvc2l0aW9uOiBQb0NvbnRyb2xQb3NpdGlvblNlcnZpY2UsXHJcbiAgICBwdWJsaWMgY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmXHJcbiAgKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmVjaGEgbyBjb21wb25lbnRlICpwb3B1cCouXHJcbiAgICpcclxuICAgKiA+IFBvciBwYWRyw6NvLCBlc3RlIGNvbXBvcnRhbWVudG8gw6kgYWNpb25hZG8gc29tZW50ZSBhbyBjbGljYXIgZm9yYSBkbyBjb21wb25lbnRlIG91IGVtIGRldGVybWluYWRhIGHDp8OjbyAvIHVybC5cclxuICAgKi9cclxuICBjbG9zZSgpIHtcclxuICAgIHRoaXMucmVtb3ZlTGlzdGVuZXJzKCk7XHJcblxyXG4gICAgdGhpcy5zaG93UG9wdXAgPSBmYWxzZTtcclxuICB9XHJcblxyXG4gIG9uQWN0aW9uQ2xpY2socG9wdXBBY3Rpb246IFBvUG9wdXBBY3Rpb24pIHtcclxuICAgIGNvbnN0IGFjdGlvbk5vRGlzYWJsZWQgPSBwb3B1cEFjdGlvbiAmJiAhdGhpcy5yZXR1cm5Cb29sZWFuVmFsdWUocG9wdXBBY3Rpb24sICdkaXNhYmxlZCcpO1xyXG5cclxuICAgIGlmIChwb3B1cEFjdGlvbiAmJiBwb3B1cEFjdGlvbi5hY3Rpb24gJiYgYWN0aW9uTm9EaXNhYmxlZCkge1xyXG4gICAgICB0aGlzLmNsb3NlKCk7XHJcbiAgICAgIHBvcHVwQWN0aW9uLmFjdGlvbih0aGlzLnBhcmFtIHx8IHBvcHVwQWN0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAocG9wdXBBY3Rpb24gJiYgcG9wdXBBY3Rpb24udXJsICYmIGFjdGlvbk5vRGlzYWJsZWQpIHtcclxuICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgICByZXR1cm4gdGhpcy5vcGVuVXJsKHBvcHVwQWN0aW9uLnVybCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBYnJlIG8gY29tcG9uZW50ZSAqcG9wdXAqLlxyXG4gICAqXHJcbiAgICogPiDDiSBwb3Nzw612ZWwgaW5mb3JtYXIgdW0gcGFyw6JtZXRybyBxdWUgc2Vyw6EgdXRpbGl6YWRvIG5hIGV4ZWN1w6fDo28gZGEgYcOnw6NvIGRvIGl0ZW0gZSBuYSBmdW7Dp8OjbyBkZSBkZXNhYmlsaXRhci5cclxuICAgKi9cclxuICBvcGVuKHBhcmFtPykge1xyXG4gICAgdGhpcy5vbGRUYXJnZXQgPSB0aGlzLnRhcmdldDtcclxuICAgIHRoaXMucGFyYW0gPSBwYXJhbTtcclxuICAgIHRoaXMuc2hvd1BvcHVwID0gdHJ1ZTtcclxuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgdGhpcy52YWxpZGF0ZUluaXRpYWxDb250ZW50KCk7XHJcbiAgfVxyXG5cclxuICByZXR1cm5Cb29sZWFuVmFsdWUocG9wdXBBY3Rpb246IGFueSwgcHJvcGVydHk6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGlzVHlwZW9mKHBvcHVwQWN0aW9uW3Byb3BlcnR5XSwgJ2Z1bmN0aW9uJylcclxuICAgICAgPyBwb3B1cEFjdGlvbltwcm9wZXJ0eV0odGhpcy5wYXJhbSB8fCBwb3B1cEFjdGlvbilcclxuICAgICAgOiBwb3B1cEFjdGlvbltwcm9wZXJ0eV07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXNwb25zw6F2ZWwgcG9yIGFicmlyIGUgZmVjaGFyIG8gKnBvcHVwKi5cclxuICAgKlxyXG4gICAqIFF1YW5kbyBkaXNwYXJhZG8gYWJyaXLDoSBvICpwb3B1cCogZSBjYXNvIG8gbWVzbW8gasOhIGVzdGl2ZXIgYWJlcnRvIGUgcG9zc3VpciBvIG1lc21vIGB0YXJnZXRgIGlyw6EgZmVjaGEtbG8uXHJcbiAgICpcclxuICAgKiDDiSBwb3Nzw612ZWwgaW5mb3JtYXIgdW0gcGFyw6JtZXRybyBxdWUgc2Vyw6EgdXRpbGl6YWRvIG5hIGV4ZWN1w6fDo28gZGEgYcOnw6NvIGRvIGl0ZW0gZSBuYSBmdW7Dp8OjbyBkZSBkZXNhYmlsaXRhci5cclxuICAgKi9cclxuICB0b2dnbGUocGFyYW0/KSB7XHJcbiAgICB0aGlzLnNob3dQb3B1cCAmJiB0aGlzLm9sZFRhcmdldCA9PT0gdGhpcy50YXJnZXQgPyB0aGlzLmNsb3NlKCkgOiB0aGlzLm9wZW4ocGFyYW0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjbGlja2VkT3V0RGlzYWJsZWRJdGVtKGV2ZW50KSB7XHJcbiAgICBjb25zdCBjb250YWluc0l0ZW1EaXNhYmxlZCA9XHJcbiAgICAgIHRoaXMuZWxlbWVudENvbnRhaW5zKGV2ZW50LnRhcmdldCwgJ3BvLXBvcHVwLWl0ZW0tZGlzYWJsZWQnKSB8fFxyXG4gICAgICB0aGlzLmVsZW1lbnRDb250YWlucyhldmVudC50YXJnZXQucGFyZW50RWxlbWVudCwgJ3BvLXBvcHVwLWl0ZW0tZGlzYWJsZWQnKTtcclxuXHJcbiAgICByZXR1cm4gIWNvbnRhaW5zSXRlbURpc2FibGVkO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjbGlja2VkT3V0SGVhZGVyVGVtcGxhdGUoZXZlbnQpIHtcclxuICAgIGNvbnN0IHBvcHVwSGVhZGVyVGVtcGxhdGUgPSB0aGlzLnBvcHVwUmVmICYmIHRoaXMucG9wdXBSZWYubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yKCdbcC1wb3B1cC1oZWFkZXItdGVtcGxhdGVdJyk7XHJcbiAgICByZXR1cm4gIShwb3B1cEhlYWRlclRlbXBsYXRlICYmIHBvcHVwSGVhZGVyVGVtcGxhdGUuY29udGFpbnMoZXZlbnQudGFyZ2V0KSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNsaWNrZWRPdXRUYXJnZXQoZXZlbnQpIHtcclxuICAgIHJldHVybiB0aGlzLnRhcmdldCAmJiAhdGhpcy50YXJnZXQuY29udGFpbnMoZXZlbnQudGFyZ2V0KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2xvc2VQb3B1cE9uQ2xpY2tvdXQoZXZlbnQ6IE1vdXNlRXZlbnQpIHtcclxuICAgIGlmICh0aGlzLmNsaWNrZWRPdXRUYXJnZXQoZXZlbnQpICYmIHRoaXMuY2xpY2tlZE91dERpc2FibGVkSXRlbShldmVudCkgJiYgdGhpcy5jbGlja2VkT3V0SGVhZGVyVGVtcGxhdGUoZXZlbnQpKSB7XHJcbiAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZWxlbWVudENvbnRhaW5zKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBjbGFzc05hbWU6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIGVsZW1lbnQgJiYgZWxlbWVudC5jbGFzc0xpc3QuY29udGFpbnMoY2xhc3NOYW1lKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgaGFzQ29udGVudFRvU2hvdygpIHtcclxuICAgIHJldHVybiAhISh0aGlzLnBvcHVwUmVmLm5hdGl2ZUVsZW1lbnQgJiYgdGhpcy5wb3B1cFJlZi5uYXRpdmVFbGVtZW50LmNsaWVudEhlaWdodCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGluaXRpYWxpemVMaXN0ZW5lcnMoKSB7XHJcbiAgICB0aGlzLnJlc2l6ZUxpc3RlbmVyID0gdGhpcy5yZW5kZXJlci5saXN0ZW4oJ3dpbmRvdycsICdyZXNpemUnLCAoKSA9PiB7XHJcbiAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuY2xpY2tvdXRMaXN0ZW5lciA9IHRoaXMucmVuZGVyZXIubGlzdGVuKCdkb2N1bWVudCcsICdjbGljaycsIChldmVudDogTW91c2VFdmVudCkgPT4ge1xyXG4gICAgICB0aGlzLmNsb3NlUG9wdXBPbkNsaWNrb3V0KGV2ZW50KTtcclxuICAgIH0pO1xyXG5cclxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdzY3JvbGwnLCB0aGlzLm9uU2Nyb2xsLCB0cnVlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgb25TY3JvbGwgPSAoeyB0YXJnZXQgfSk6IHZvaWQgPT4ge1xyXG4gICAgaWYgKHRoaXMuc2hvd1BvcHVwICYmIHRhcmdldC5jbGFzc05hbWUgIT09ICdwby1wb3B1cC1jb250YWluZXInKSB7XHJcbiAgICAgIHRoaXMuY2xvc2UoKTtcclxuICAgIH1cclxuICB9O1xyXG5cclxuICBwcml2YXRlIG9wZW5VcmwodXJsOiBzdHJpbmcpIHtcclxuICAgIGlmIChpc0V4dGVybmFsTGluayh1cmwpKSB7XHJcbiAgICAgIHJldHVybiBvcGVuRXh0ZXJuYWxMaW5rKHVybCk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKHVybCkge1xyXG4gICAgICByZXR1cm4gdGhpcy5yb3V0ZXIubmF2aWdhdGUoW3VybF0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZW1vdmVMaXN0ZW5lcnMoKSB7XHJcbiAgICBpZiAodGhpcy5jbGlja291dExpc3RlbmVyKSB7XHJcbiAgICAgIHRoaXMuY2xpY2tvdXRMaXN0ZW5lcigpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnJlc2l6ZUxpc3RlbmVyKSB7XHJcbiAgICAgIHRoaXMucmVzaXplTGlzdGVuZXIoKTtcclxuICAgIH1cclxuXHJcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgdGhpcy5vblNjcm9sbCwgdHJ1ZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldFBvc2l0aW9uKCkge1xyXG4gICAgdGhpcy5wb0NvbnRyb2xQb3NpdGlvbi5zZXRFbGVtZW50cyhcclxuICAgICAgdGhpcy5wb3B1cFJlZi5uYXRpdmVFbGVtZW50LFxyXG4gICAgICA4LFxyXG4gICAgICB0aGlzLnRhcmdldCxcclxuICAgICAgdGhpcy5jdXN0b21Qb3NpdGlvbnMsXHJcbiAgICAgIGZhbHNlLFxyXG4gICAgICB0aGlzLmlzQ29ybmVyQWxpZ25cclxuICAgICk7XHJcbiAgICB0aGlzLnBvQ29udHJvbFBvc2l0aW9uLmFkanVzdFBvc2l0aW9uKHRoaXMucG9zaXRpb24pO1xyXG4gICAgdGhpcy5hcnJvd0RpcmVjdGlvbiA9IHRoaXMucG9Db250cm9sUG9zaXRpb24uZ2V0QXJyb3dEaXJlY3Rpb24oKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdmFsaWRhdGVJbml0aWFsQ29udGVudCgpIHtcclxuICAgIGlmICh0aGlzLmhhc0NvbnRlbnRUb1Nob3coKSkge1xyXG4gICAgICB0aGlzLnNldFBvc2l0aW9uKCk7XHJcbiAgICAgIHRoaXMuaW5pdGlhbGl6ZUxpc3RlbmVycygpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5jbG9zZSgpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=
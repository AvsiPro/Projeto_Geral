import { ChangeDetectorRef, Component, ElementRef, Renderer2, ViewChild } from '@angular/core';
import { animate, AnimationBuilder, keyframes, style } from '@angular/animations';
import { delay } from 'rxjs/operators';
import { uuid } from '../../utils/util';
import { PoLanguageService } from '../../services/po-language/po-language.service';
import { PoMenuGlobalService } from '../po-menu/services/po-menu-global.service';
import { PoMenuComponent } from '../po-menu/po-menu.component';
import { PoNavbarBaseComponent } from './po-navbar-base.component';
import { PoNavbarItemsComponent } from './po-navbar-items/po-navbar-items.component';
const poNavbarNavigationWidth = 88;
const poNavbarMenuMedia = 768;
const poNavbarMatchMedia = `(max-width: ${poNavbarMenuMedia}px)`;
const poNavbarTiming = '250ms ease';
/**
 * @docsExtends PoNavbarBaseComponent
 */
export class PoNavbarComponent extends PoNavbarBaseComponent {
    constructor(poLanguageService, renderer, builder, changeDetector, menuGlobalService) {
        super(poLanguageService);
        this.renderer = renderer;
        this.builder = builder;
        this.changeDetector = changeDetector;
        this.menuGlobalService = menuGlobalService;
        this.showItemsNavigation = false;
        this.isNavbarUpdateMenu = false;
        this.id = uuid();
        this.offset = 0;
        this.previousMenusItems = [];
        this.onMediaQueryChange = changed => {
            this.changeNavbarMenuItems(changed.matches, this.items, this.literals.navbarLinks);
        };
        this.windowResizeListener = this.renderer.listen(window, 'resize', this.displayItemsNavigation.bind(this));
    }
    get navbarItemNavigationDisableLeft() {
        return this.offset === 0;
    }
    get navbarItemNavigationDisableRight() {
        return this.disableRight && this.offset !== 0;
    }
    set menuComponent(menu) {
        this._menuComponent = menu;
        this.previousMenuComponentId = (menu === null || menu === void 0 ? void 0 : menu.id) || this.previousMenuComponentId;
    }
    get isCollapsedMedia() {
        return window.innerWidth < poNavbarMenuMedia;
    }
    ngOnInit() {
        // necessário para quando o menu da aplicação carregar os itens lazy e navbar estiver colapsado,
        // quando isso acontece, o navbar inclui 1 item de menu "Navbar links", portanto é removido quando
        // os novos itens de menu é carregado, a partir disso este tratamento é necessario para incluir
        // o navbar links apos a adição dos itens de menu da aplicação.
        this.menusSubscription = this.menuGlobalService.receiveMenus$.subscribe(newMenus => {
            var _a;
            const previousMenusiIsNavbarLinks = ((_a = this.previousMenusItems) === null || _a === void 0 ? void 0 : _a.length) === 1 && this.previousMenusItems[0].id === this.id;
            if (this.applicationMenu && this.isCollapsedMedia && this.isNavbarUpdateMenu && previousMenusiIsNavbarLinks) {
                this.isNavbarUpdateMenu = false;
                this.applicationMenu.menus = [
                    { label: this.literals.navbarLinks, subItems: this.items, id: this.id },
                    ...newMenus
                ];
            }
            this.isNavbarUpdateMenu = false;
            this.previousMenusItems = newMenus;
        });
        this.removedMenuSubscription = this.menuGlobalService.receiveRemovedApplicationMenu$.subscribe(removedMenuId => {
            // verifica se o menu removido foi o presente no navbar, caso sim, ele mantem o applictionMenu.
            // é preciso para tratar a sequencia do ngDestroy, quando o menu do navbar era removido do DOM
            // disparava esse evento, sendo necessario tratar, para não tornar indefinido o applicationMenu
            this.applicationMenu =
                this.applicationMenu && this.previousMenuComponentId === removedMenuId ? this.applicationMenu : undefined;
            this.changeDetector.detectChanges();
            if (!this.applicationMenu && this.mediaQuery) {
                this.mediaQuery.removeListener(this.onMediaQueryChange);
            }
        });
        this.applicationMenuSubscription = this.menuGlobalService.receiveApplicationMenu$
            .pipe(delay(100))
            .subscribe(newMenu => {
            this.applicationMenu = this.previousMenuComponentId === newMenu.id ? undefined : newMenu;
            this.changeDetector.detectChanges();
            if (this.applicationMenu) {
                this.initNavbarMenu();
            }
        });
    }
    ngAfterViewInit() {
        this.displayItemsNavigation();
    }
    ngOnDestroy() {
        var _a, _b, _c;
        if (this.mediaQuery) {
            this.mediaQuery.removeListener(this.onMediaQueryChange);
        }
        (_a = this.removedMenuSubscription) === null || _a === void 0 ? void 0 : _a.unsubscribe();
        (_b = this.applicationMenuSubscription) === null || _b === void 0 ? void 0 : _b.unsubscribe();
        (_c = this.menusSubscription) === null || _c === void 0 ? void 0 : _c.unsubscribe();
    }
    navigateItems(orientation) {
        orientation === 'left' ? this.navigateLeft() : this.navigateRight();
        this.animate(this.offset);
    }
    validateMenuLogo() {
        if (this.applicationMenu.logo && this.logo) {
            this.applicationMenu.logo = undefined;
            this.changeDetector.detectChanges();
        }
    }
    allNavbarItemsWidth() {
        return this.navbarItems.allNavbarItems.reduce((previous, current) => previous + current.nativeElement.offsetWidth, 0);
    }
    animate(offset) {
        const animation = this.buildTransitionAnimation(offset);
        this.player = animation.create(this.navbarItems.navbarItemsContainer.nativeElement);
        this.player.play();
    }
    buildTransitionAnimation(offset) {
        return this.builder.build([animate(poNavbarTiming, keyframes([style({ transform: `translateX(${-offset}px)` })]))]);
    }
    changeNavbarMenuItems(isCollapsedMedia, navbarItems, label) {
        if (isCollapsedMedia) {
            this.applicationMenu.menus = [{ label, subItems: navbarItems, id: this.id }, ...this.applicationMenu.menus];
        }
        else {
            this.applicationMenu.menus = this.applicationMenu.menus.filter(m => m.id !== this.id);
        }
        this.isNavbarUpdateMenu = true;
        this.changeDetector.detectChanges();
    }
    calculateLeftNavigation() {
        let calculatedOffset;
        this.navbarItems.allNavbarItems.some(navbarItem => {
            const navbarItemOffset = navbarItem.nativeElement.offsetLeft;
            const navbarItemWidth = navbarItem.nativeElement.offsetWidth;
            if (navbarItemOffset >= this.offset) {
                calculatedOffset = navbarItemOffset - (this.navbarItemsWidth() - navbarItemWidth);
                return true;
            }
        });
        return calculatedOffset;
    }
    calculateRightNavigation(itemBreakPoint) {
        let calculatedOffset;
        this.navbarItems.allNavbarItems.some(navbarItem => {
            const offsetLeft = navbarItem.nativeElement.offsetLeft;
            const finalPosition = navbarItem.nativeElement.offsetWidth + offsetLeft;
            if (itemBreakPoint < finalPosition) {
                calculatedOffset = offsetLeft;
                return true;
            }
        });
        return calculatedOffset;
    }
    displayItemsNavigation() {
        this.showItemsNavigation = this.navbarItemsWidth() < this.allNavbarItemsWidth() + poNavbarNavigationWidth;
        this.changeDetector.detectChanges();
        if (this.offset !== 0) {
            this.setOffsetToZero();
            this.animate(this.offset);
        }
    }
    initNavbarMenu() {
        this.mediaQuery = window.matchMedia(poNavbarMatchMedia);
        if (this.isCollapsedMedia) {
            this.changeNavbarMenuItems(true, this.items, this.literals.navbarLinks);
        }
        this.validateMenuLogo();
        this.mediaQuery.addListener(this.onMediaQueryChange);
    }
    navbarItemsWidth() {
        return this.navbarItemsElement.nativeElement.offsetWidth;
    }
    navigateLeft() {
        this.disableRight = false;
        this.offset = this.calculateLeftNavigation();
        if (this.offset < 0) {
            this.setOffsetToZero();
        }
    }
    navigateRight() {
        const maxAllowedOffset = this.allNavbarItemsWidth() - this.navbarItemsWidth();
        const itemBreakPoint = this.offset + this.navbarItemsWidth();
        this.offset = this.calculateRightNavigation(itemBreakPoint);
        this.validateMaxOffset(maxAllowedOffset);
    }
    setOffsetToZero() {
        this.offset = 0;
    }
    validateMaxOffset(maxAllowedOffset) {
        if (this.offset >= maxAllowedOffset) {
            this.offset = maxAllowedOffset;
            this.disableRight = true;
        }
    }
}
PoNavbarComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-navbar',
                template: "<header class=\"po-navbar\" [ngClass]=\"{ 'po-navbar-shadow': shadow }\">\r\n  <po-navbar-logo\r\n    class=\"po-navbar-logo\"\r\n    [ngClass]=\"{ 'po-navbar-logo-menu': !!applicationMenu, 'po-navbar-no-logo': !logo }\"\r\n    [p-logo]=\"logo\"\r\n  >\r\n  </po-navbar-logo>\r\n\r\n  <po-navbar-items class=\"po-navbar-items\" [p-items]=\"items\"> </po-navbar-items>\r\n\r\n  <po-navbar-item-navigation\r\n    *ngIf=\"showItemsNavigation\"\r\n    class=\"po-navbar-item-navigation\"\r\n    [p-disable-left]=\"navbarItemNavigationDisableLeft\"\r\n    [p-disable-right]=\"navbarItemNavigationDisableRight\"\r\n    (p-click)=\"navigateItems($event)\"\r\n  >\r\n  </po-navbar-item-navigation>\r\n\r\n  <po-navbar-actions class=\"po-navbar-actions\" [p-icon-actions]=\"iconActions\"> </po-navbar-actions>\r\n</header>\r\n\r\n<po-menu *ngIf=\"!applicationMenu\" [p-menus]=\"items\"> </po-menu>\r\n"
            },] }
];
PoNavbarComponent.ctorParameters = () => [
    { type: PoLanguageService },
    { type: Renderer2 },
    { type: AnimationBuilder },
    { type: ChangeDetectorRef },
    { type: PoMenuGlobalService }
];
PoNavbarComponent.propDecorators = {
    navbarItemsElement: [{ type: ViewChild, args: [PoNavbarItemsComponent, { read: ElementRef, static: true },] }],
    navbarItems: [{ type: ViewChild, args: [PoNavbarItemsComponent, { static: true },] }],
    menuComponent: [{ type: ViewChild, args: [PoMenuComponent,] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tbmF2YmFyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1uYXZiYXIvcG8tbmF2YmFyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxVQUFVLEVBR1YsU0FBUyxFQUNULFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFxQyxTQUFTLEVBQUUsS0FBSyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFckgsT0FBTyxFQUFFLEtBQUssRUFBb0IsTUFBTSxnQkFBZ0IsQ0FBQztBQUd6RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDeEMsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0RBQWdELENBQUM7QUFDbkYsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFFakYsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBRS9ELE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRW5FLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZDQUE2QyxDQUFDO0FBRXJGLE1BQU0sdUJBQXVCLEdBQUcsRUFBRSxDQUFDO0FBQ25DLE1BQU0saUJBQWlCLEdBQUcsR0FBRyxDQUFDO0FBQzlCLE1BQU0sa0JBQWtCLEdBQUcsZUFBZSxpQkFBaUIsS0FBSyxDQUFDO0FBQ2pFLE1BQU0sY0FBYyxHQUFHLFlBQVksQ0FBQztBQUVwQzs7R0FFRztBQUtILE1BQU0sT0FBTyxpQkFBa0IsU0FBUSxxQkFBcUI7SUEyQzFELFlBQ0UsaUJBQW9DLEVBQzVCLFFBQW1CLEVBQ25CLE9BQXlCLEVBQ3pCLGNBQWlDLEVBQ2pDLGlC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QUFZLEdBQUcsSUFBSSxDQUFDO1NBQzFCO0lBQ0gsQ0FBQzs7O1lBN1BGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsV0FBVztnQkFDckIsdzRCQUF5QzthQUMxQzs7O1lBcEJRLGlCQUFpQjtZQVR4QixTQUFTO1lBR08sZ0JBQWdCO1lBUmhDLGlCQUFpQjtZQWVWLG1CQUFtQjs7O2lDQXFCekIsU0FBUyxTQUFDLHNCQUFzQixFQUFFLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFOzBCQUVwRSxTQUFTLFNBQUMsc0JBQXNCLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFOzRCQThCbEQsU0FBUyxTQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIEFmdGVyVmlld0luaXQsXHJcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgQ29tcG9uZW50LFxyXG4gIEVsZW1lbnRSZWYsXHJcbiAgT25EZXN0cm95LFxyXG4gIE9uSW5pdCxcclxuICBSZW5kZXJlcjIsXHJcbiAgVmlld0NoaWxkXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGFuaW1hdGUsIEFuaW1hdGlvbkJ1aWxkZXIsIEFuaW1hdGlvbkZhY3RvcnksIEFuaW1hdGlvblBsYXllciwga2V5ZnJhbWVzLCBzdHlsZSB9IGZyb20gJ0Bhbmd1bGFyL2FuaW1hdGlvbnMnO1xyXG5cclxuaW1wb3J0IHsgZGVsYXksIGZpbHRlciwgZmluYWxpemUgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgdXVpZCB9IGZyb20gJy4uLy4uL3V0aWxzL3V0aWwnO1xyXG5pbXBvcnQgeyBQb0xhbmd1YWdlU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BvLWxhbmd1YWdlL3BvLWxhbmd1YWdlLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBQb01lbnVHbG9iYWxTZXJ2aWNlIH0gZnJvbSAnLi4vcG8tbWVudS9zZXJ2aWNlcy9wby1tZW51LWdsb2JhbC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUG9NZW51SXRlbSB9IGZyb20gJy4uL3BvLW1lbnUvcG8tbWVudS1pdGVtLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvTWVudUNvbXBvbmVudCB9IGZyb20gJy4uL3BvLW1lbnUvcG8tbWVudS5jb21wb25lbnQnO1xyXG5cclxuaW1wb3J0IHsgUG9OYXZiYXJCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1uYXZiYXItYmFzZS5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBQb05hdmJhckl0ZW0gfSBmcm9tICcuL2ludGVyZmFjZXMvcG8tbmF2YmFyLWl0ZW0uaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgUG9OYXZiYXJJdGVtc0NvbXBvbmVudCB9IGZyb20gJy4vcG8tbmF2YmFyLWl0ZW1zL3BvLW5hdmJhci1pdGVtcy5jb21wb25lbnQnO1xyXG5cclxuY29uc3QgcG9OYXZiYXJOYXZpZ2F0aW9uV2lkdGggPSA4ODtcclxuY29uc3QgcG9OYXZiYXJNZW51TWVkaWEgPSA3Njg7XHJcbmNvbnN0IHBvTmF2YmFyTWF0Y2hNZWRpYSA9IGAobWF4LXdpZHRoOiAke3BvTmF2YmFyTWVudU1lZGlhfXB4KWA7XHJcbmNvbnN0IHBvTmF2YmFyVGltaW5nID0gJzI1MG1zIGVhc2UnO1xyXG5cclxuLyoqXHJcbiAqIEBkb2NzRXh0ZW5kcyBQb05hdmJhckJhc2VDb21wb25lbnRcclxuICovXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAncG8tbmF2YmFyJyxcclxuICB0ZW1wbGF0ZVVybDogJy4vcG8tbmF2YmFyLmNvbXBvbmVudC5odG1sJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUG9OYXZiYXJDb21wb25lbnQgZXh0ZW5kcyBQb05hdmJhckJhc2VDb21wb25lbnQgaW1wbGVtZW50cyBBZnRlclZpZXdJbml0LCBPbkRlc3Ryb3ksIE9uSW5pdCB7XHJcbiAgQFZpZXdDaGlsZChQb05hdmJhckl0ZW1zQ29tcG9uZW50LCB7IHJlYWQ6IEVsZW1lbnRSZWYsIHN0YXRpYzogdHJ1ZSB9KSBuYXZiYXJJdGVtc0VsZW1lbnQ6IEVsZW1lbnRSZWY7XHJcblxyXG4gIEBWaWV3Q2hpbGQoUG9OYXZiYXJJdGVtc0NvbXBvbmVudCwgeyBzdGF0aWM6IHRydWUgfSkgbmF2YmFySXRlbXM6IFBvTmF2YmFySXRlbXNDb21wb25lbnQ7XHJcblxyXG4gIGRpc2FibGVSaWdodDogYm9vbGVhbjtcclxuICBzaG93SXRlbXNOYXZpZ2F0aW9uOiBib29sZWFuID0gZmFsc2U7XHJcblxyXG4gIHByb3RlY3RlZCB3aW5kb3dSZXNpemVMaXN0ZW5lcjogKCkgPT4gdm9pZDtcclxuXHJcbiAgcHJpdmF0ZSBfbWVudUNvbXBvbmVudDtcclxuXHJcbiAgcHJpdmF0ZSBpc05hdmJhclVwZGF0ZU1lbnU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICBwcml2YXRlIGlkID0gdXVpZCgpO1xyXG4gIHByaXZhdGUgbWVkaWFRdWVyeTogYW55O1xyXG4gIHByaXZhdGUgb2Zmc2V0OiBudW1iZXIgPSAwO1xyXG4gIHByaXZhdGUgcGxheWVyOiBBbmltYXRpb25QbGF5ZXI7XHJcbiAgcHJpdmF0ZSBtZW51SXRlbXM6IEFycmF5PFBvTWVudUl0ZW0+O1xyXG4gIHByaXZhdGUgcHJldmlvdXNNZW51Q29tcG9uZW50SWQ7XHJcbiAgcHJpdmF0ZSBwcmV2aW91c01lbnVzSXRlbXMgPSBbXTtcclxuXHJcbiAgcHJpdmF0ZSBhcHBsaWNhdGlvbk1lbnVTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcclxuICBwcml2YXRlIG1lbnVzU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcbiAgcHJpdmF0ZSByZW1vdmVkTWVudVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG5cclxuICBnZXQgbmF2YmFySXRlbU5hdmlnYXRpb25EaXNhYmxlTGVmdCgpIHtcclxuICAgIHJldHVybiB0aGlzLm9mZnNldCA9PT0gMDtcclxuICB9XHJcblxyXG4gIGdldCBuYXZiYXJJdGVtTmF2aWdhdGlvbkRpc2FibGVSaWdodCgpIHtcclxuICAgIHJldHVybiB0aGlzLmRpc2FibGVSaWdodCAmJiB0aGlzLm9mZnNldCAhPT0gMDtcclxuICB9XHJcblxyXG4gIEBWaWV3Q2hpbGQoUG9NZW51Q29tcG9uZW50KSBzZXQgbWVudUNvbXBvbmVudChtZW51OiBQb01lbnVDb21wb25lbnQpIHtcclxuICAgIHRoaXMuX21lbnVDb21wb25lbnQgPSBtZW51O1xyXG5cclxuICAgIHRoaXMucHJldmlvdXNNZW51Q29tcG9uZW50SWQgPSBtZW51Py5pZCB8fCB0aGlzLnByZXZpb3VzTWVudUNvbXBvbmVudElkO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXQgaXNDb2xsYXBzZWRNZWRpYSgpIHtcclxuICAgIHJldHVybiB3aW5kb3cuaW5uZXJXaWR0aCA8IHBvTmF2YmFyTWVudU1lZGlhO1xyXG4gIH1cclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwb0xhbmd1YWdlU2VydmljZTogUG9MYW5ndWFnZVNlcnZpY2UsXHJcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXHJcbiAgICBwcml2YXRlIGJ1aWxkZXI6IEFuaW1hdGlvbkJ1aWxkZXIsXHJcbiAgICBwcml2YXRlIGNoYW5nZURldGVjdG9yOiBDaGFuZ2VEZXRlY3RvclJlZixcclxuICAgIHByaXZhdGUgbWVudUdsb2JhbFNlcnZpY2U6IFBvTWVudUdsb2JhbFNlcnZpY2VcclxuICApIHtcclxuICAgIHN1cGVyKHBvTGFuZ3VhZ2VTZXJ2aWNlKTtcclxuICAgIHRoaXMud2luZG93UmVzaXplTGlzdGVuZXIgPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbih3aW5kb3csICdyZXNpemUnLCB0aGlzLmRpc3BsYXlJdGVtc05hdmlnYXRpb24uYmluZCh0aGlzKSk7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIC8vIG5lY2Vzc8OhcmlvIHBhcmEgcXVhbmRvIG8gbWVudSBkYSBhcGxpY2HDp8OjbyBjYXJyZWdhciBvcyBpdGVucyBsYXp5IGUgbmF2YmFyIGVzdGl2ZXIgY29sYXBzYWRvLFxyXG4gICAgLy8gcXVhbmRvIGlzc28gYWNvbnRlY2UsIG8gbmF2YmFyIGluY2x1aSAxIGl0ZW0gZGUgbWVudSBcIk5hdmJhciBsaW5rc1wiLCBwb3J0YW50byDDqSByZW1vdmlkbyBxdWFuZG9cclxuICAgIC8vIG9zIG5vdm9zIGl0ZW5zIGRlIG1lbnUgw6kgY2FycmVnYWRvLCBhIHBhcnRpciBkaXNzbyBlc3RlIHRyYXRhbWVudG8gw6kgbmVjZXNzYXJpbyBwYXJhIGluY2x1aXJcclxuICAgIC8vIG8gbmF2YmFyIGxpbmtzIGFwb3MgYSBhZGnDp8OjbyBkb3MgaXRlbnMgZGUgbWVudSBkYSBhcGxpY2HDp8Ojby5cclxuICAgIHRoaXMubWVudXNTdWJzY3JpcHRpb24gPSB0aGlzLm1lbnVHbG9iYWxTZXJ2aWNlLnJlY2VpdmVNZW51cyQuc3Vic2NyaWJlKG5ld01lbnVzID0+IHtcclxuICAgICAgY29uc3QgcHJldmlvdXNNZW51c2lJc05hdmJhckxpbmtzID1cclxuICAgICAgICB0aGlzLnByZXZpb3VzTWVudXNJdGVtcz8ubGVuZ3RoID09PSAxICYmIHRoaXMucHJldmlvdXNNZW51c0l0ZW1zWzBdLmlkID09PSB0aGlzLmlkO1xyXG5cclxuICAgICAgaWYgKHRoaXMuYXBwbGljYXRpb25NZW51ICYmIHRoaXMuaXNDb2xsYXBzZWRNZWRpYSAmJiB0aGlzLmlzTmF2YmFyVXBkYXRlTWVudSAmJiBwcmV2aW91c01lbnVzaUlzTmF2YmFyTGlua3MpIHtcclxuICAgICAgICB0aGlzLmlzTmF2YmFyVXBkYXRlTWVudSA9IGZhbHNlO1xyXG5cclxuICAgICAgICB0aGlzLmFwcGxpY2F0aW9uTWVudS5tZW51cyA9IFtcclxuICAgICAgICAgIHsgbGFiZWw6IHRoaXMubGl0ZXJhbHMubmF2YmFyTGlua3MsIHN1Ykl0ZW1zOiB0aGlzLml0ZW1zLCBpZDogdGhpcy5pZCB9LFxyXG4gICAgICAgICAgLi4ubmV3TWVudXNcclxuICAgICAgICBdO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmlzTmF2YmFyVXBkYXRlTWVudSA9IGZhbHNlO1xyXG4gICAgICB0aGlzLnByZXZpb3VzTWVudXNJdGVtcyA9IG5ld01lbnVzO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5yZW1vdmVkTWVudVN1YnNjcmlwdGlvbiA9IHRoaXMubWVudUdsb2JhbFNlcnZpY2UucmVjZWl2ZVJlbW92ZWRBcHBsaWNhdGlvbk1lbnUkLnN1YnNjcmliZShyZW1vdmVkTWVudUlkID0+IHtcclxuICAgICAgLy8gdmVyaWZpY2Egc2UgbyBtZW51IHJlbW92aWRvIGZvaSBvIHByZXNlbnRlIG5vIG5hdmJhciwgY2FzbyBzaW0sIGVsZSBtYW50ZW0gbyBhcHBsaWN0aW9uTWVudS5cclxuICAgICAgLy8gw6kgcHJlY2lzbyBwYXJhIHRyYXRhciBhIHNlcXVlbmNpYSBkbyBuZ0Rlc3Ryb3ksIHF1YW5kbyBvIG1lbnUgZG8gbmF2YmFyIGVyYSByZW1vdmlkbyBkbyBET01cclxuICAgICAgLy8gZGlzcGFyYXZhIGVzc2UgZXZlbnRvLCBzZW5kbyBuZWNlc3NhcmlvIHRyYXRhciwgcGFyYSBuw6NvIHRvcm5hciBpbmRlZmluaWRvIG8gYXBwbGljYXRpb25NZW51XHJcbiAgICAgIHRoaXMuYXBwbGljYXRpb25NZW51ID1cclxuICAgICAgICB0aGlzLmFwcGxpY2F0aW9uTWVudSAmJiB0aGlzLnByZXZpb3VzTWVudUNvbXBvbmVudElkID09PSByZW1vdmVkTWVudUlkID8gdGhpcy5hcHBsaWNhdGlvbk1lbnUgOiB1bmRlZmluZWQ7XHJcblxyXG4gICAgICB0aGlzLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcclxuXHJcbiAgICAgIGlmICghdGhpcy5hcHBsaWNhdGlvbk1lbnUgJiYgdGhpcy5tZWRpYVF1ZXJ5KSB7XHJcbiAgICAgICAgdGhpcy5tZWRpYVF1ZXJ5LnJlbW92ZUxpc3RlbmVyKHRoaXMub25NZWRpYVF1ZXJ5Q2hhbmdlKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5hcHBsaWNhdGlvbk1lbnVTdWJzY3JpcHRpb24gPSB0aGlzLm1lbnVHbG9iYWxTZXJ2aWNlLnJlY2VpdmVBcHBsaWNhdGlvbk1lbnUkXHJcbiAgICAgIC5waXBlKGRlbGF5KDEwMCkpXHJcbiAgICAgIC5zdWJzY3JpYmUobmV3TWVudSA9PiB7XHJcbiAgICAgICAgdGhpcy5hcHBsaWNhdGlvbk1lbnUgPSB0aGlzLnByZXZpb3VzTWVudUNvbXBvbmVudElkID09PSBuZXdNZW51LmlkID8gdW5kZWZpbmVkIDogbmV3TWVudTtcclxuXHJcbiAgICAgICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgICAgIGlmICh0aGlzLmFwcGxpY2F0aW9uTWVudSkge1xyXG4gICAgICAgICAgdGhpcy5pbml0TmF2YmFyTWVudSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICB0aGlzLmRpc3BsYXlJdGVtc05hdmlnYXRpb24oKTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgaWYgKHRoaXMubWVkaWFRdWVyeSkge1xyXG4gICAgICB0aGlzLm1lZGlhUXVlcnkucmVtb3ZlTGlzdGVuZXIodGhpcy5vbk1lZGlhUXVlcnlDaGFuZ2UpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucmVtb3ZlZE1lbnVTdWJzY3JpcHRpb24/LnVuc3Vic2NyaWJlKCk7XHJcbiAgICB0aGlzLmFwcGxpY2F0aW9uTWVudVN1YnNjcmlwdGlvbj8udW5zdWJzY3JpYmUoKTtcclxuICAgIHRoaXMubWVudXNTdWJzY3JpcHRpb24/LnVuc3Vic2NyaWJlKCk7XHJcbiAgfVxyXG5cclxuICBuYXZpZ2F0ZUl0ZW1zKG9yaWVudGF0aW9uOiBzdHJpbmcpIHtcclxuICAgIG9yaWVudGF0aW9uID09PSAnbGVmdCcgPyB0aGlzLm5hdmlnYXRlTGVmdCgpIDogdGhpcy5uYXZpZ2F0ZVJpZ2h0KCk7XHJcblxyXG4gICAgdGhpcy5hbmltYXRlKHRoaXMub2Zmc2V0KTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCB2YWxpZGF0ZU1lbnVMb2dvKCkge1xyXG4gICAgaWYgKHRoaXMuYXBwbGljYXRpb25NZW51LmxvZ28gJiYgdGhpcy5sb2dvKSB7XHJcbiAgICAgIHRoaXMuYXBwbGljYXRpb25NZW51LmxvZ28gPSB1bmRlZmluZWQ7XHJcbiAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhbGxOYXZiYXJJdGVtc1dpZHRoKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmF2YmFySXRlbXMuYWxsTmF2YmFySXRlbXMucmVkdWNlKFxyXG4gICAgICAocHJldmlvdXM6IGFueSwgY3VycmVudDogYW55KSA9PiBwcmV2aW91cyArIGN1cnJlbnQubmF0aXZlRWxlbWVudC5vZmZzZXRXaWR0aCxcclxuICAgICAgMFxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYW5pbWF0ZShvZmZzZXQ6IG51bWJlcikge1xyXG4gICAgY29uc3QgYW5pbWF0aW9uOiBBbmltYXRpb25GYWN0b3J5ID0gdGhpcy5idWlsZFRyYW5zaXRpb25BbmltYXRpb24ob2Zmc2V0KTtcclxuXHJcbiAgICB0aGlzLnBsYXllciA9IGFuaW1hdGlvbi5jcmVhdGUodGhpcy5uYXZiYXJJdGVtcy5uYXZiYXJJdGVtc0NvbnRhaW5lci5uYXRpdmVFbGVtZW50KTtcclxuICAgIHRoaXMucGxheWVyLnBsYXkoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYnVpbGRUcmFuc2l0aW9uQW5pbWF0aW9uKG9mZnNldDogbnVtYmVyKSB7XHJcbiAgICByZXR1cm4gdGhpcy5idWlsZGVyLmJ1aWxkKFthbmltYXRlKHBvTmF2YmFyVGltaW5nLCBrZXlmcmFtZXMoW3N0eWxlKHsgdHJhbnNmb3JtOiBgdHJhbnNsYXRlWCgkey1vZmZzZXR9cHgpYCB9KV0pKV0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBjaGFuZ2VOYXZiYXJNZW51SXRlbXMoaXNDb2xsYXBzZWRNZWRpYTogYW55LCBuYXZiYXJJdGVtczogQXJyYXk8UG9OYXZiYXJJdGVtPiwgbGFiZWw6IHN0cmluZykge1xyXG4gICAgaWYgKGlzQ29sbGFwc2VkTWVkaWEpIHtcclxuICAgICAgdGhpcy5hcHBsaWNhdGlvbk1lbnUubWVudXMgPSBbeyBsYWJlbCwgc3ViSXRlbXM6IG5hdmJhckl0ZW1zLCBpZDogdGhpcy5pZCB9LCAuLi50aGlzLmFwcGxpY2F0aW9uTWVudS5tZW51c107XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmFwcGxpY2F0aW9uTWVudS5tZW51cyA9IHRoaXMuYXBwbGljYXRpb25NZW51Lm1lbnVzLmZpbHRlcihtID0+IG0uaWQgIT09IHRoaXMuaWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuaXNOYXZiYXJVcGRhdGVNZW51ID0gdHJ1ZTtcclxuXHJcbiAgICB0aGlzLmNoYW5nZURldGVjdG9yLmRldGVjdENoYW5nZXMoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2FsY3VsYXRlTGVmdE5hdmlnYXRpb24oKSB7XHJcbiAgICBsZXQgY2FsY3VsYXRlZE9mZnNldDogbnVtYmVyO1xyXG5cclxuICAgIHRoaXMubmF2YmFySXRlbXMuYWxsTmF2YmFySXRlbXMuc29tZShuYXZiYXJJdGVtID0+IHtcclxuICAgICAgY29uc3QgbmF2YmFySXRlbU9mZnNldCA9IG5hdmJhckl0ZW0ubmF0aXZlRWxlbWVudC5vZmZzZXRMZWZ0O1xyXG4gICAgICBjb25zdCBuYXZiYXJJdGVtV2lkdGggPSBuYXZiYXJJdGVtLm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGg7XHJcblxyXG4gICAgICBpZiAobmF2YmFySXRlbU9mZnNldCA+PSB0aGlzLm9mZnNldCkge1xyXG4gICAgICAgIGNhbGN1bGF0ZWRPZmZzZXQgPSBuYXZiYXJJdGVtT2Zmc2V0IC0gKHRoaXMubmF2YmFySXRlbXNXaWR0aCgpIC0gbmF2YmFySXRlbVdpZHRoKTtcclxuICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gY2FsY3VsYXRlZE9mZnNldDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2FsY3VsYXRlUmlnaHROYXZpZ2F0aW9uKGl0ZW1CcmVha1BvaW50OiBudW1iZXIpIHtcclxuICAgIGxldCBjYWxjdWxhdGVkT2Zmc2V0OiBudW1iZXI7XHJcblxyXG4gICAgdGhpcy5uYXZiYXJJdGVtcy5hbGxOYXZiYXJJdGVtcy5zb21lKG5hdmJhckl0ZW0gPT4ge1xyXG4gICAgICBjb25zdCBvZmZzZXRMZWZ0ID0gbmF2YmFySXRlbS5uYXRpdmVFbGVtZW50Lm9mZnNldExlZnQ7XHJcbiAgICAgIGNvbnN0IGZpbmFsUG9zaXRpb24gPSBuYXZiYXJJdGVtLm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGggKyBvZmZzZXRMZWZ0O1xyXG5cclxuICAgICAgaWYgKGl0ZW1CcmVha1BvaW50IDwgZmluYWxQb3NpdGlvbikge1xyXG4gICAgICAgIGNhbGN1bGF0ZWRPZmZzZXQgPSBvZmZzZXRMZWZ0O1xyXG4gICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBjYWxjdWxhdGVkT2Zmc2V0O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkaXNwbGF5SXRlbXNOYXZpZ2F0aW9uKCkge1xyXG4gICAgdGhpcy5zaG93SXRlbXNOYXZpZ2F0aW9uID0gdGhpcy5uYXZiYXJJdGVtc1dpZHRoKCkgPCB0aGlzLmFsbE5hdmJhckl0ZW1zV2lkdGgoKSArIHBvTmF2YmFyTmF2aWdhdGlvbldpZHRoO1xyXG5cclxuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG5cclxuICAgIGlmICh0aGlzLm9mZnNldCAhPT0gMCkge1xyXG4gICAgICB0aGlzLnNldE9mZnNldFRvWmVybygpO1xyXG4gICAgICB0aGlzLmFuaW1hdGUodGhpcy5vZmZzZXQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpbml0TmF2YmFyTWVudSgpIHtcclxuICAgIHRoaXMubWVkaWFRdWVyeSA9IHdpbmRvdy5tYXRjaE1lZGlhKHBvTmF2YmFyTWF0Y2hNZWRpYSk7XHJcblxyXG4gICAgaWYgKHRoaXMuaXNDb2xsYXBzZWRNZWRpYSkge1xyXG4gICAgICB0aGlzLmNoYW5nZU5hdmJhck1lbnVJdGVtcyh0cnVlLCB0aGlzLml0ZW1zLCB0aGlzLmxpdGVyYWxzLm5hdmJhckxpbmtzKTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnZhbGlkYXRlTWVudUxvZ28oKTtcclxuXHJcbiAgICB0aGlzLm1lZGlhUXVlcnkuYWRkTGlzdGVuZXIodGhpcy5vbk1lZGlhUXVlcnlDaGFuZ2UpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBuYXZiYXJJdGVtc1dpZHRoKCkge1xyXG4gICAgcmV0dXJuIHRoaXMubmF2YmFySXRlbXNFbGVtZW50Lm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGg7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG5hdmlnYXRlTGVmdCgpIHtcclxuICAgIHRoaXMuZGlzYWJsZVJpZ2h0ID0gZmFsc2U7XHJcblxyXG4gICAgdGhpcy5vZmZzZXQgPSB0aGlzLmNhbGN1bGF0ZUxlZnROYXZpZ2F0aW9uKCk7XHJcblxyXG4gICAgaWYgKHRoaXMub2Zmc2V0IDwgMCkge1xyXG4gICAgICB0aGlzLnNldE9mZnNldFRvWmVybygpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBuYXZpZ2F0ZVJpZ2h0KCkge1xyXG4gICAgY29uc3QgbWF4QWxsb3dlZE9mZnNldCA9IHRoaXMuYWxsTmF2YmFySXRlbXNXaWR0aCgpIC0gdGhpcy5uYXZiYXJJdGVtc1dpZHRoKCk7XHJcbiAgICBjb25zdCBpdGVtQnJlYWtQb2ludCA9IHRoaXMub2Zmc2V0ICsgdGhpcy5uYXZiYXJJdGVtc1dpZHRoKCk7XHJcblxyXG4gICAgdGhpcy5vZmZzZXQgPSB0aGlzLmNhbGN1bGF0ZVJpZ2h0TmF2aWdhdGlvbihpdGVtQnJlYWtQb2ludCk7XHJcblxyXG4gICAgdGhpcy52YWxpZGF0ZU1heE9mZnNldChtYXhBbGxvd2VkT2Zmc2V0KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgb25NZWRpYVF1ZXJ5Q2hhbmdlID0gY2hhbmdlZCA9PiB7XHJcbiAgICB0aGlzLmNoYW5nZU5hdmJhck1lbnVJdGVtcyhjaGFuZ2VkLm1hdGNoZXMsIHRoaXMuaXRlbXMsIHRoaXMubGl0ZXJhbHMubmF2YmFyTGlua3MpO1xyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgc2V0T2Zmc2V0VG9aZXJvKCkge1xyXG4gICAgdGhpcy5vZmZzZXQgPSAwO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB2YWxpZGF0ZU1heE9mZnNldChtYXhBbGxvd2VkT2Zmc2V0OiBudW1iZXIpIHtcclxuICAgIGlmICh0aGlzLm9mZnNldCA+PSBtYXhBbGxvd2VkT2Zmc2V0KSB7XHJcbiAgICAgIHRoaXMub2Zmc2V0ID0gbWF4QWxsb3dlZE9mZnNldDtcclxuICAgICAgdGhpcy5kaXNhYmxlUmlnaHQgPSB0cnVlO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=
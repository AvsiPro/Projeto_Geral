import { Component, ChangeDetectorRef, ViewChild } from '@angular/core';
import { Subject } from 'rxjs';
import { PoDynamicFormBaseComponent } from './po-dynamic-form-base.component';
import { PoDynamicFormLoadService } from './po-dynamic-form-load/po-dynamic-form-load.service';
import { PoDynamicFormValidationService } from './po-dynamic-form-validation/po-dynamic-form-validation.service';
/**
 * @docsExtends PoDynamicFormBaseComponent
 *
 * @example
 *
 * <example name="po-dynamic-form-basic" title="PO Dynamic Form Basic">
 *  <file name="sample-po-dynamic-form-basic/sample-po-dynamic-form-basic.component.html"> </file>
 *  <file name="sample-po-dynamic-form-basic/sample-po-dynamic-form-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-dynamic-form-register" title="PO Dynamic Form - Register">
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.component.html"> </file>
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.component.ts"> </file>
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.service.ts"> </file>
 * </example>
 */
export class PoDynamicFormComponent extends PoDynamicFormBaseComponent {
    constructor(changes, loadService, validationService) {
        super();
        this.changes = changes;
        this.loadService = loadService;
        this.validationService = validationService;
        this.comboOptionSubject = new Subject();
    }
    set form(value) {
        // necessario para nao ocorrer o ExpressionChangedAfterItHasBeenCheckedError
        setTimeout(() => {
            this._form = value;
            this.emitForm();
        });
    }
    get form() {
        return this._form || {};
    }
    ngOnDestroy() {
        this.removeListeners();
    }
    ngOnInit() {
        if (this.load) {
            this.loadDataOnInitialize();
        }
    }
    /**
     * Função que atribui foco ao campo desejado.
     *
     * Para utilizá-la é necessário capturar a instância do `dynamic form`, como por exemplo:
     *
     * ``` html
     * <po-dynamic-form #dynamicForm [p-fields]="fields"></po-dynamic-form>
     * ```
     *
     * ``` javascript
     * import { PoDynamicFormComponent, PoDynamicFormField } from '@po-ui/ng-components';
     *
     * ...
     *
     * @ViewChild('dynamicForm', { static: true }) dynamicForm: PoDynamicFormComponent;
     *
     * fields: Array<PoDynamicFormField> = [
     *   { property: 'fieldOne' },
     *   { property: 'fieldTwo' }
     * ];
     *
     * fieldFocus() {
     *   this.dynamicForm.focus('fieldTwo');
     * }
     * ```
     *
     * @param {string} property Nome da propriedade atribuída ao `PoDynamicFormField.property`.
     */
    focus(property) {
        this.fieldsComponent.focus(property);
    }
    getObjectValue() {
        return this.comboOptionSubject.asObservable();
    }
    sendObjectValue(objectValue) {
        this.comboOptionSubject.next(objectValue);
    }
    validateForm(field) {
        const previousFocusElement = document.activeElement;
        this.disableForm(true);
        const errorOnValidation = () => this.disableForm(false);
        this.sendFormSubscription = this.validationService
            .sendFormChange(this.validate, field, this.value)
            .subscribe(this.applyFormValidation(previousFocusElement), errorOnValidation);
    }
    applyFormUpdatesOnLoad(previousFocusElement) {
        return dynamicFormData => {
            this.updateModelOnLoad(dynamicFormData);
            this.disableForm(false);
            this.setFocusOnFieldByProperty(dynamicFormData.focus, previousFocusElement);
        };
    }
    applyFormValidation(previousFocusElement) {
        return dynamicFormData => {
            this.updateModelWithValidation(dynamicFormData);
            this.disableForm(false);
            this.setFocusOnFieldByProperty(dynamicFormData.focus, previousFocusElement);
        };
    }
    disableForm(value) {
        this.disabledForm = value;
        this.changes.detectChanges();
    }
    emitForm() {
        if (!this.groupForm && this.formOutput.observers.length) {
            this.formOutput.emit(this.form);
        }
    }
    loadDataOnInitialize() {
        const previousFocusElement = document.activeElement;
        this.disabledForm = true;
        const errorOnLoad = () => (this.disabledForm = false);
        this.onLoadSubscription = this.loadService
            .executeLoad(this.load, this.value)
            .subscribe(this.applyFormUpdatesOnLoad(previousFocusElement), errorOnLoad);
    }
    removeListeners() {
        if (this.onLoadSubscription) {
            this.onLoadSubscription.unsubscribe();
        }
        if (this.sendFormSubscription) {
            this.sendFormSubscription.unsubscribe();
        }
    }
    setFocusOnFieldByProperty(property, previousFocusElement) {
        if (property) {
            // precisa do timeout para que o valor seja atribuido no campo antes de setar o focus,
            // para nao disparar a mudança posteriormente. Situação ocorre quando retornar campo com valor e focus atribuido a ele.
            setTimeout(() => this.focus(property));
        }
        else {
            previousFocusElement['focus']();
        }
    }
    updateModelOnLoad(loadedFormData) {
        Object.assign(this.value, loadedFormData.value);
        this.fields = this.loadService.createAndUpdateFieldsForm(loadedFormData.fields, this.fields);
    }
    updateModelWithValidation(formData) {
        Object.assign(this.value, formData.value);
        this.fieldsComponent.updatePreviousValue();
        this.fields = this.validationService.updateFieldsForm(formData.fields, this.fields);
    }
}
PoDynamicFormComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-dynamic-form',
                template: "<ng-container *ngIf=\"groupForm; then reuseFormTemplate; else uniqueFormTemplate\"></ng-container>\r\n\r\n<ng-template #reuseFormTemplate>\r\n  <po-dynamic-form-fields #fieldsComponent [p-auto-focus]=\"autoFocus\" [p-fields]=\"fields\" [p-value]=\"value\">\r\n  </po-dynamic-form-fields>\r\n</ng-template>\r\n\r\n<ng-template #uniqueFormTemplate>\r\n  <form #dynamicForm=\"ngForm\">\r\n    <po-dynamic-form-fields\r\n      #fieldsComponent\r\n      [(p-fields)]=\"fields\"\r\n      [p-auto-focus]=\"autoFocus\"\r\n      [p-disabled-form]=\"disabledForm\"\r\n      [p-validate]=\"validate\"\r\n      [p-validate-fields]=\"validateFields\"\r\n      [p-value]=\"value\"\r\n      (p-object-value)=\"sendObjectValue($event)\"\r\n      (p-form-validate)=\"validateForm($event)\"\r\n    >\r\n    </po-dynamic-form-fields>\r\n  </form>\r\n</ng-template>\r\n"
            },] }
];
PoDynamicFormComponent.ctorParameters = () => [
    { type: ChangeDetectorRef },
    { type: PoDynamicFormLoadService },
    { type: PoDynamicFormValidationService }
];
PoDynamicFormComponent.propDecorators = {
    fieldsComponent: [{ type: ViewChild, args: ['fieldsComponent',] }],
    form: [{ type: ViewChild, args: ['dynamicForm',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1keW5hbWljL3BvLWR5bmFtaWMtZm9ybS9wby1keW5hbWljLWZvcm0uY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQXFCLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUczRixPQUFPLEVBQWMsT0FBTyxFQUFnQixNQUFNLE1BQU0sQ0FBQztBQUV6RCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUc5RSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxxREFBcUQsQ0FBQztBQUUvRixPQUFPLEVBQUUsOEJBQThCLEVBQUUsTUFBTSxpRUFBaUUsQ0FBQztBQUVqSDs7Ozs7Ozs7Ozs7Ozs7O0dBZUc7QUFNSCxNQUFNLE9BQU8sc0JBQXVCLFNBQVEsMEJBQTBCO0lBd0JwRSxZQUNVLE9BQTBCLEVBQzFCLFdBQXFDLEVBQ3JDLGlCQUFpRDtRQUV6RCxLQUFLLEVBQUUsQ0FBQztRQUpBLFlBQU8sR0FBUCxPQUFPLENBQW1CO1FBQzFCLGdCQUFXLEdBQVgsV0FBVyxDQUEwQjtRQUNyQyxzQkFBaUIsR0FBakIsaUJBQWlCLENBQWdDO1FBbEJuRCx1QkFBa0IsR0FBRyxJQUFJLE9BQU8sRUFBTyxDQUFDO0lBcUJoRCxDQUFDO0lBbkJELElBQThCLElBQUksQ0FBQyxLQUFhO1FBQzlDLDRFQUE0RTtRQUM1RSxVQUFVLENBQUMsR0FBRyxFQUFFO1lBQ2QsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7WUFFbkIsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ2xCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELElBQUksSUFBSTtRQUNOLE9BQU8s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LENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN0RixDQUFDOzs7WUFwS0YsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxpQkFBaUI7Z0JBQzNCLDYxQkFBK0M7YUFDaEQ7OztZQWhDbUIsaUJBQWlCO1lBUTVCLHdCQUF3QjtZQUV4Qiw4QkFBOEI7Ozs4QkF3QnBDLFNBQVMsU0FBQyxpQkFBaUI7bUJBVTNCLFNBQVMsU0FBQyxhQUFhIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBDaGFuZ2VEZXRlY3RvclJlZiwgT25EZXN0cm95LCBPbkluaXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBOZ0Zvcm0gfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcblxyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0LCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcclxuXHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1CYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1keW5hbWljLWZvcm0tYmFzZS5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtRmllbGQgfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS1maWVsZC5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtTG9hZCB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLWxvYWQvcG8tZHluYW1pYy1mb3JtLWxvYWQuaW50ZXJmYWNlJztcclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUxvYWRTZXJ2aWNlIH0gZnJvbSAnLi9wby1keW5hbWljLWZvcm0tbG9hZC9wby1keW5hbWljLWZvcm0tbG9hZC5zZXJ2aWNlJztcclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybVZhbGlkYXRpb24gfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1WYWxpZGF0aW9uU2VydmljZSB9IGZyb20gJy4vcG8tZHluYW1pYy1mb3JtLXZhbGlkYXRpb24vcG8tZHluYW1pYy1mb3JtLXZhbGlkYXRpb24uc2VydmljZSc7XHJcblxyXG4vKipcclxuICogQGRvY3NFeHRlbmRzIFBvRHluYW1pY0Zvcm1CYXNlQ29tcG9uZW50XHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqXHJcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1keW5hbWljLWZvcm0tYmFzaWNcIiB0aXRsZT1cIlBPIER5bmFtaWMgRm9ybSBCYXNpY1wiPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tYmFzaWMvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1iYXNpYy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XHJcbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1iYXNpYy9zYW1wbGUtcG8tZHluYW1pYy1mb3JtLWJhc2ljLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XHJcbiAqIDwvZXhhbXBsZT5cclxuICpcclxuICogPGV4YW1wbGUgbmFtZT1cInBvLWR5bmFtaWMtZm9ybS1yZWdpc3RlclwiIHRpdGxlPVwiUE8gRHluYW1pYyBGb3JtIC0gUmVnaXN0ZXJcIj5cclxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tZHluYW1pYy1mb3JtLXJlZ2lzdGVyL3NhbXBsZS1wby1keW5hbWljLWZvcm0tcmVnaXN0ZXIuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tcmVnaXN0ZXIvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci5jb21wb25lbnQudHNcIj4gPC9maWxlPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tcmVnaXN0ZXIvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci5zZXJ2aWNlLnRzXCI+IDwvZmlsZT5cclxuICogPC9leGFtcGxlPlxyXG4gKi9cclxuXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAncG8tZHluYW1pYy1mb3JtJyxcclxuICB0ZW1wbGF0ZVVybDogJy4vcG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC5odG1sJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUG9EeW5hbWljRm9ybUNvbXBvbmVudCBleHRlbmRzIFBvRHluYW1pY0Zvcm1CYXNlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG4gIEBWaWV3Q2hpbGQoJ2ZpZWxkc0NvbXBvbmVudCcpIGZpZWxkc0NvbXBvbmVudDogeyBmb2N1czogKHByb3BlcnR5OiBzdHJpbmcpID0+IHZvaWQ7IHVwZGF0ZVByZXZpb3VzVmFsdWU6ICgpID0+IHZvaWQgfTtcclxuXHJcbiAgZGlzYWJsZWRGb3JtOiBib29sZWFuO1xyXG5cclxuICBwcml2YXRlIF9mb3JtOiBOZ0Zvcm07XHJcblxyXG4gIHByaXZhdGUgb25Mb2FkU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcbiAgcHJpdmF0ZSBzZW5kRm9ybVN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xyXG4gIHByaXZhdGUgY29tYm9PcHRpb25TdWJqZWN0ID0gbmV3IFN1YmplY3Q8YW55PigpO1xyXG5cclxuICBAVmlld0NoaWxkKCdkeW5hbWljRm9ybScpIHNldCBmb3JtKHZhbHVlOiBOZ0Zvcm0pIHtcclxuICAgIC8vIG5lY2Vzc2FyaW8gcGFyYSBuYW8gb2NvcnJlciBvIEV4cHJlc3Npb25DaGFuZ2VkQWZ0ZXJJdEhhc0JlZW5DaGVja2VkRXJyb3JcclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICB0aGlzLl9mb3JtID0gdmFsdWU7XHJcblxyXG4gICAgICB0aGlzLmVtaXRGb3JtKCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIGdldCBmb3JtKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2Zvcm0gfHwgPGFueT57fTtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKFxyXG4gICAgcHJpdmF0ZSBjaGFuZ2VzOiBDaGFuZ2VEZXRlY3RvclJlZixcclxuICAgIHByaXZhdGUgbG9hZFNlcnZpY2U6IFBvRHluYW1pY0Zvcm1Mb2FkU2VydmljZSxcclxuICAgIHByaXZhdGUgdmFsaWRhdGlvblNlcnZpY2U6IFBvRHluYW1pY0Zvcm1WYWxpZGF0aW9uU2VydmljZVxyXG4gICkge1xyXG4gICAgc3VwZXIoKTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCkge1xyXG4gICAgdGhpcy5yZW1vdmVMaXN0ZW5lcnMoKTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgaWYgKHRoaXMubG9hZCkge1xyXG4gICAgICB0aGlzLmxvYWREYXRhT25Jbml0aWFsaXplKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGdW7Dp8OjbyBxdWUgYXRyaWJ1aSBmb2NvIGFvIGNhbXBvIGRlc2VqYWRvLlxyXG4gICAqXHJcbiAgICogUGFyYSB1dGlsaXrDoS1sYSDDqSBuZWNlc3PDoXJpbyBjYXB0dXJhciBhIGluc3TDom5jaWEgZG8gYGR5bmFtaWMgZm9ybWAsIGNvbW8gcG9yIGV4ZW1wbG86XHJcbiAgICpcclxuICAgKiBgYGAgaHRtbFxyXG4gICAqIDxwby1keW5hbWljLWZvcm0gI2R5bmFtaWNGb3JtIFtwLWZpZWxkc109XCJmaWVsZHNcIj48L3BvLWR5bmFtaWMtZm9ybT5cclxuICAgKiBgYGBcclxuICAgKlxyXG4gICAqIGBgYCBqYXZhc2NyaXB0XHJcbiAgICogaW1wb3J0IHsgUG9EeW5hbWljRm9ybUNvbXBvbmVudCwgUG9EeW5hbWljRm9ybUZpZWxkIH0gZnJvbSAnQHBvLXVpL25nLWNvbXBvbmVudHMnO1xyXG4gICAqXHJcbiAgICogLi4uXHJcbiAgICpcclxuICAgKiBAVmlld0NoaWxkKCdkeW5hbWljRm9ybScsIHsgc3RhdGljOiB0cnVlIH0pIGR5bmFtaWNGb3JtOiBQb0R5bmFtaWNGb3JtQ29tcG9uZW50O1xyXG4gICAqXHJcbiAgICogZmllbGRzOiBBcnJheTxQb0R5bmFtaWNGb3JtRmllbGQ+ID0gW1xyXG4gICAqICAgeyBwcm9wZXJ0eTogJ2ZpZWxkT25lJyB9LFxyXG4gICAqICAgeyBwcm9wZXJ0eTogJ2ZpZWxkVHdvJyB9XHJcbiAgICogXTtcclxuICAgKlxyXG4gICAqIGZpZWxkRm9jdXMoKSB7XHJcbiAgICogICB0aGlzLmR5bmFtaWNGb3JtLmZvY3VzKCdmaWVsZFR3bycpO1xyXG4gICAqIH1cclxuICAgKiBgYGBcclxuICAgKlxyXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBwcm9wZXJ0eSBOb21lIGRhIHByb3ByaWVkYWRlIGF0cmlidcOtZGEgYW8gYFBvRHluYW1pY0Zvcm1GaWVsZC5wcm9wZXJ0eWAuXHJcbiAgICovXHJcbiAgZm9jdXMocHJvcGVydHk6IHN0cmluZykge1xyXG4gICAgdGhpcy5maWVsZHNDb21wb25lbnQuZm9jdXMocHJvcGVydHkpO1xyXG4gIH1cclxuXHJcbiAgZ2V0T2JqZWN0VmFsdWUoKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLmNvbWJvT3B0aW9uU3ViamVjdC5hc09ic2VydmFibGUoKTtcclxuICB9XHJcblxyXG4gIHNlbmRPYmplY3RWYWx1ZShvYmplY3RWYWx1ZTogYW55KSB7XHJcbiAgICB0aGlzLmNvbWJvT3B0aW9uU3ViamVjdC5uZXh0KG9iamVjdFZhbHVlKTtcclxuICB9XHJcblxyXG4gIHZhbGlkYXRlRm9ybShmaWVsZDogUG9EeW5hbWljRm9ybUZpZWxkKSB7XHJcbiAgICBjb25zdCBwcmV2aW91c0ZvY3VzRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7XHJcblxyXG4gICAgdGhpcy5kaXNhYmxlRm9ybSh0cnVlKTtcclxuICAgIGNvbnN0IGVycm9yT25WYWxpZGF0aW9uID0gKCkgPT4gdGhpcy5kaXNhYmxlRm9ybShmYWxzZSk7XHJcblxyXG4gICAgdGhpcy5zZW5kRm9ybVN1YnNjcmlwdGlvbiA9IHRoaXMudmFsaWRhdGlvblNlcnZpY2VcclxuICAgICAgLnNlbmRGb3JtQ2hhbmdlKHRoaXMudmFsaWRhdGUsIGZpZWxkLCB0aGlzLnZhbHVlKVxyXG4gICAgICAuc3Vic2NyaWJlKHRoaXMuYXBwbHlGb3JtVmFsaWRhdGlvbihwcmV2aW91c0ZvY3VzRWxlbWVudCksIGVycm9yT25WYWxpZGF0aW9uKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXBwbHlGb3JtVXBkYXRlc09uTG9hZChwcmV2aW91c0ZvY3VzRWxlbWVudDogRWxlbWVudCk6IChkeW5hbWljRm9ybURhdGE6IFBvRHluYW1pY0Zvcm1Mb2FkKSA9PiB2b2lkIHtcclxuICAgIHJldHVybiBkeW5hbWljRm9ybURhdGEgPT4ge1xyXG4gICAgICB0aGlzLnVwZGF0ZU1vZGVsT25Mb2FkKGR5bmFtaWNGb3JtRGF0YSk7XHJcbiAgICAgIHRoaXMuZGlzYWJsZUZvcm0oZmFsc2UpO1xyXG4gICAgICB0aGlzLnNldEZvY3VzT25GaWVsZEJ5UHJvcGVydHkoZHluYW1pY0Zvcm1EYXRhLmZvY3VzLCBwcmV2aW91c0ZvY3VzRWxlbWVudCk7XHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhcHBseUZvcm1WYWxpZGF0aW9uKHByZXZpb3VzRm9jdXNFbGVtZW50OiBFbGVtZW50KTogKGR5bmFtaWNGb3JtRGF0YTogUG9EeW5hbWljRm9ybVZhbGlkYXRpb24pID0+IHZvaWQge1xyXG4gICAgcmV0dXJuIGR5bmFtaWNGb3JtRGF0YSA9PiB7XHJcbiAgICAgIHRoaXMudXBkYXRlTW9kZWxXaXRoVmFsaWRhdGlvbihkeW5hbWljRm9ybURhdGEpO1xyXG4gICAgICB0aGlzLmRpc2FibGVGb3JtKGZhbHNlKTtcclxuICAgICAgdGhpcy5zZXRGb2N1c09uRmllbGRCeVByb3BlcnR5KGR5bmFtaWNGb3JtRGF0YS5mb2N1cywgcHJldmlvdXNGb2N1c0VsZW1lbnQpO1xyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZGlzYWJsZUZvcm0odmFsdWU6IGJvb2xlYW4pIHtcclxuICAgIHRoaXMuZGlzYWJsZWRGb3JtID0gdmFsdWU7XHJcbiAgICB0aGlzLmNoYW5nZXMuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBlbWl0Rm9ybSgpIHtcclxuICAgIGlmICghdGhpcy5ncm91cEZvcm0gJiYgdGhpcy5mb3JtT3V0cHV0Lm9ic2VydmVycy5sZW5ndGgpIHtcclxuICAgICAgdGhpcy5mb3JtT3V0cHV0LmVtaXQodGhpcy5mb3JtKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgbG9hZERhdGFPbkluaXRpYWxpemUoKSB7XHJcbiAgICBjb25zdCBwcmV2aW91c0ZvY3VzRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7XHJcblxyXG4gICAgdGhpcy5kaXNhYmxlZEZvcm0gPSB0cnVlO1xyXG4gICAgY29uc3QgZXJyb3JPbkxvYWQgPSAoKSA9PiAodGhpcy5kaXNhYmxlZEZvcm0gPSBmYWxzZSk7XHJcblxyXG4gICAgdGhpcy5vbkxvYWRTdWJzY3JpcHRpb24gPSB0aGlzLmxvYWRTZXJ2aWNlXHJcbiAgICAgIC5leGVjdXRlTG9hZCh0aGlzLmxvYWQsIHRoaXMudmFsdWUpXHJcbiAgICAgIC5zdWJzY3JpYmUodGhpcy5hcHBseUZvcm1VcGRhdGVzT25Mb2FkKHByZXZpb3VzRm9jdXNFbGVtZW50KSwgZXJyb3JPbkxvYWQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZW1vdmVMaXN0ZW5lcnMoKSB7XHJcbiAgICBpZiAodGhpcy5vbkxvYWRTdWJzY3JpcHRpb24pIHtcclxuICAgICAgdGhpcy5vbkxvYWRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAodGhpcy5zZW5kRm9ybVN1YnNjcmlwdGlvbikge1xyXG4gICAgICB0aGlzLnNlbmRGb3JtU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldEZvY3VzT25GaWVsZEJ5UHJvcGVydHkocHJvcGVydHk6IHN0cmluZywgcHJldmlvdXNGb2N1c0VsZW1lbnQ6IEVsZW1lbnQpIHtcclxuICAgIGlmIChwcm9wZXJ0eSkge1xyXG4gICAgICAvLyBwcmVjaXNhIGRvIHRpbWVvdXQgcGFyYSBxdWUgbyB2YWxvciBzZWphIGF0cmlidWlkbyBubyBjYW1wbyBhbnRlcyBkZSBzZXRhciBvIGZvY3VzLFxyXG4gICAgICAvLyBwYXJhIG5hbyBkaXNwYXJhciBhIG11ZGFuw6dhIHBvc3Rlcmlvcm1lbnRlLiBTaXR1YcOnw6NvIG9jb3JyZSBxdWFuZG8gcmV0b3JuYXIgY2FtcG8gY29tIHZhbG9yIGUgZm9jdXMgYXRyaWJ1aWRvIGEgZWxlLlxyXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuZm9jdXMocHJvcGVydHkpKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHByZXZpb3VzRm9jdXNFbGVtZW50Wydmb2N1cyddKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHVwZGF0ZU1vZGVsT25Mb2FkKGxvYWRlZEZvcm1EYXRhOiBQb0R5bmFtaWNGb3JtTG9hZCkge1xyXG4gICAgT2JqZWN0LmFzc2lnbih0aGlzLnZhbHVlLCBsb2FkZWRGb3JtRGF0YS52YWx1ZSk7XHJcbiAgICB0aGlzLmZpZWxkcyA9IHRoaXMubG9hZFNlcnZpY2UuY3JlYXRlQW5kVXBkYXRlRmllbGRzRm9ybShsb2FkZWRGb3JtRGF0YS5maWVsZHMsIHRoaXMuZmllbGRzKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlTW9kZWxXaXRoVmFsaWRhdGlvbihmb3JtRGF0YTogUG9EeW5hbWljRm9ybVZhbGlkYXRpb24pIHtcclxuICAgIE9iamVjdC5hc3NpZ24odGhpcy52YWx1ZSwgZm9ybURhdGEudmFsdWUpO1xyXG4gICAgdGhpcy5maWVsZHNDb21wb25lbnQudXBkYXRlUHJldmlvdXNWYWx1ZSgpO1xyXG4gICAgdGhpcy5maWVsZHMgPSB0aGlzLnZhbGlkYXRpb25TZXJ2aWNlLnVwZGF0ZUZpZWxkc0Zvcm0oZm9ybURhdGEuZmllbGRzLCB0aGlzLmZpZWxkcyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==
import { __decorate } from "tslib";
import { Component, ElementRef, EventEmitter, Input, Output, Renderer2 } from '@angular/core';
import { from, timer } from 'rxjs';
import { concatMap, mapTo, scan, tap } from 'rxjs/operators';
import { isIE } from '../../../../../utils/util';
import { InputBoolean } from '../../../../../decorators';
const RADIUS_DEFAULT_SIZE = 5;
const RADIUS_HOVER_SIZE = 10;
const ANIMATION_DURATION_TIME = 700;
export class PoChartSeriesPointComponent {
    constructor(renderer, elementRef) {
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.chartLine = false;
        this.pointClick = new EventEmitter();
        this.pointHover = new EventEmitter();
        this.radius = RADIUS_DEFAULT_SIZE;
        this._coordinates = [];
        this.animationState = true;
    }
    set color(value) {
        this.strokeColor = value.includes('po-color') ? value.replace('po-color', 'po-border-color') : value;
        this._color = value;
    }
    get color() {
        return this._color;
    }
    set coordinates(value) {
        this._coordinates = value;
        this.coordinates$ = this.displayPointsWithDelay(this._coordinates);
    }
    get coordinates() {
        return this._coordinates;
    }
    trackBy(index) {
        return index;
    }
    onClick(point) {
        const selectedItem = { label: point.label, data: point.data, category: point.category };
        this.pointClick.emit(selectedItem);
    }
    onMouseEnter(event, point) {
        this.setPointAttribute(event.target, true);
        const selectedItem = { label: point.label, data: point.data, category: point.category };
        this.pointHover.emit(Object.assign({ relativeTo: this.relativeTo }, selectedItem));
    }
    onMouseLeave(event) {
        this.setPointAttribute(event.target, false);
    }
    displayPointsWithDelay(coordinates) {
        if (this.animationState && !isIE()) {
            const animationTimer = ANIMATION_DURATION_TIME / coordinates.length;
            return from(coordinates).pipe(concatMap((item, index) => timer(index === 0 || !this.animate ? 0 : animationTimer).pipe(mapTo(item))), scan((acc, curr) => acc.concat(curr), []), tap(() => (this.animationState = false)));
        }
        else {
            return from([coordinates]);
        }
    }
    setPointAttribute(target, isHover) {
        this.renderer.setAttribute(target, 'r', isHover ? RADIUS_HOVER_SIZE.toString() : RADIUS_DEFAULT_SIZE.toString());
        if (this.color.includes('po-color')) {
            this.renderer.setAttribute(target, 'class', isHover ? `${this.strokeColor} ${this.color}` : `po-chart-line-point po-chart-active-point ${this.strokeColor}`);
        }
        else {
            this.renderer[isHover ? 'setStyle' : 'removeStyle'](target, 'fill', isHover ? this.color : undefined);
        }
    }
}
PoChartSeriesPointComponent.decorators = [
    { type: Component, args: [{
                selector: '[po-chart-series-point]',
                template: "<svg:circle *ngFor=\"let item of coordinates$ | async; trackBy: trackBy\" \r\n  [p-tooltip]=\"item.tooltipLabel\"\r\n  [p-append-in-body]='true'\r\n  [p-display-tooltip]=\"!chartLine && item.isActive\"\r\n  p-tooltip-position=\"top\"\r\n  class=\"po-chart-line-point\"\r\n  [class]=\"strokeColor?.includes('po-border-color') ? strokeColor : ''\"\r\n  [class.po-chart-active-point]=\"item.isActive\"\r\n  [attr.cx]=\"item.xCoordinate\"\r\n  [attr.cy]=\"item.yCoordinate\"\r\n  [attr.r]=\"radius\"\r\n  [attr.stroke]=\"strokeColor\"\r\n  (click)=\"onClick(item)\"\r\n  (mouseenter)=\"onMouseEnter($event, item)\"\r\n  (mouseleave)=\"onMouseLeave($event)\"\r\n  >\r\n</svg:circle>\r\n"
            },] }
];
PoChartSeriesPointComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: ElementRef }
];
PoChartSeriesPointComponent.propDecorators = {
    animate: [{ type: Input, args: ['p-animate',] }],
    isActive: [{ type: Input, args: ['p-is-active',] }],
    chartLine: [{ type: Input, args: ['p-chart-line',] }],
    relativeTo: [{ type: Input, args: ['p-relative-to',] }],
    pointClick: [{ type: Output, args: ['p-point-click',] }],
    pointHover: [{ type: Output, args: ['p-point-hover',] }],
    color: [{ type: Input, args: ['p-color',] }],
    coordinates: [{ type: Input, args: ['p-coordinates',] }]
};
__decorate([
    InputBoolean()
], PoChartSeriesPointComponent.prototype, "isActive", void 0);
__decorate([
    InputBoolean()
], PoChartSeriesPointComponent.prototype, "chartLine", void 0);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tY2hhcnQtc2VyaWVzLXBvaW50LmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL3VpL3NyYy9saWIvY29tcG9uZW50cy9wby1jaGFydC9wby1jaGFydC1jb250YWluZXIvcG8tY2hhcnQtbGluZS9wby1jaGFydC1zZXJpZXMtcG9pbnQvcG8tY2hhcnQtc2VyaWVzLXBvaW50LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzlGLE9BQU8sRUFBRSxJQUFJLEVBQWMsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9DLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUU3RCxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDakQsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBSXpELE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxDQUFDO0FBQzlCLE1BQU0saUJBQWlCLEdBQUcsRUFBRSxDQUFDO0FBQzdCLE1BQU0sdUJBQXVCLEdBQUcsR0FBRyxDQUFDO0FBTXBDLE1BQU0sT0FBTywyQkFBMkI7SUEwQ3RDLFlBQW9CLFFBQW1CLEVBQVUsVUFBc0I7UUFBbkQsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUFVLGVBQVUsR0FBVixVQUFVLENBQVk7UUFyQ2hDLGNBQVMsR0FBWSxLQUFLLENBQUM7UUFLekMsZUFBVSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFFckMsZUFBVSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFHOUQsV0FBTSxHQUFXLG1CQUFtQixDQUFDO1FB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QUVqQjtJQUFmLFlBQVksRUFBRTs4REFBNEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEVsZW1lbnRSZWYsIEV2ZW50RW1pdHRlciwgSW5wdXQsIE91dHB1dCwgUmVuZGVyZXIyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IGZyb20sIE9ic2VydmFibGUsIHRpbWVyIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGNvbmNhdE1hcCwgbWFwVG8sIHNjYW4sIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IGlzSUUgfSBmcm9tICcuLi8uLi8uLi8uLi8uLi91dGlscy91dGlsJztcclxuaW1wb3J0IHsgSW5wdXRCb29sZWFuIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vZGVjb3JhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBQb0NoYXJ0UG9pbnRzQ29vcmRpbmF0ZXMgfSBmcm9tICcuLi8uLi8uLi9pbnRlcmZhY2VzL3BvLWNoYXJ0LXBvaW50cy1jb29yZGluYXRlcy5pbnRlcmZhY2UnO1xyXG5cclxuY29uc3QgUkFESVVTX0RFRkFVTFRfU0laRSA9IDU7XHJcbmNvbnN0IFJBRElVU19IT1ZFUl9TSVpFID0gMTA7XHJcbmNvbnN0IEFOSU1BVElPTl9EVVJBVElPTl9USU1FID0gNzAwO1xyXG5cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdbcG8tY2hhcnQtc2VyaWVzLXBvaW50XScsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLWNoYXJ0LXNlcmllcy1wb2ludC5jb21wb25lbnQuc3ZnJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUG9DaGFydFNlcmllc1BvaW50Q29tcG9uZW50IHtcclxuICBASW5wdXQoJ3AtYW5pbWF0ZScpIGFuaW1hdGU6IGJvb2xlYW47XHJcblxyXG4gIEBJbnB1dCgncC1pcy1hY3RpdmUnKSBASW5wdXRCb29sZWFuKCkgaXNBY3RpdmU6IGJvb2xlYW47XHJcblxyXG4gIEBJbnB1dCgncC1jaGFydC1saW5lJykgQElucHV0Qm9vbGVhbigpIGNoYXJ0TGluZTogYm9vbGVhbiA9IGZhbHNlO1xyXG5cclxuICAvLyBSZWZlcsOqbmNpYSBwYXJhIG8gc3ZnUGF0aEdyb3VwIGFvIHF1YWwgcGVydGVuY2UgbyBwb250by4gTmVjZXNzw6FyaW8gcGFyYSByZW9yZGVuYcOnw6NvIGRvcyBzdmdFbGVtZW50cyBubyBET00gcGFyYSB0cmF0YW1lbnRvIG9uSG92ZXJcclxuICBASW5wdXQoJ3AtcmVsYXRpdmUtdG8nKSByZWxhdGl2ZVRvOiBzdHJpbmc7XHJcblxyXG4gIEBPdXRwdXQoJ3AtcG9pbnQtY2xpY2snKSBwb2ludENsaWNrID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIEBPdXRwdXQoJ3AtcG9pbnQtaG92ZXInKSBwb2ludEhvdmVyID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIGNvb3JkaW5hdGVzJDogT2JzZXJ2YWJsZTxBcnJheTxQb0NoYXJ0UG9pbnRzQ29vcmRpbmF0ZXM+PjtcclxuICByYWRpdXM6IG51bWJlciA9IFJBRElVU19ERUZBVUxUX1NJWkU7XHJcbiAgc3Ryb2tlQ29sb3I6IHN0cmluZztcclxuXHJcbiAgcHJpdmF0ZSBfY29sb3I6IHN0cmluZztcclxuICBwcml2YXRlIF9jb29yZGluYXRlczogQXJyYXk8UG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzPiA9IFtdO1xyXG5cclxuICBwcml2YXRlIGFuaW1hdGlvblN0YXRlOiBib29sZWFuID0gdHJ1ZTtcclxuXHJcbiAgQElucHV0KCdwLWNvbG9yJykgc2V0IGNvbG9yKHZhbHVlOiBzdHJpbmcpIHtcclxuICAgIHRoaXMuc3Ryb2tlQ29sb3IgPSB2YWx1ZS5pbmNsdWRlcygncG8tY29sb3InKSA/IHZhbHVlLnJlcGxhY2UoJ3BvLWNvbG9yJywgJ3BvLWJvcmRlci1jb2xvcicpIDogdmFsdWU7XHJcbiAgICB0aGlzLl9jb2xvciA9IHZhbHVlO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGNvbG9yKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuX2NvbG9yO1xyXG4gIH1cclxuXHJcbiAgQElucHV0KCdwLWNvb3JkaW5hdGVzJykgc2V0IGNvb3JkaW5hdGVzKHZhbHVlOiBBcnJheTxQb0NoYXJ0UG9pbnRzQ29vcmRpbmF0ZXM+KSB7XHJcbiAgICB0aGlzLl9jb29yZGluYXRlcyA9IHZhbHVlO1xyXG5cclxuICAgIHRoaXMuY29vcmRpbmF0ZXMkID0gdGhpcy5kaXNwbGF5UG9pbnRzV2l0aERlbGF5KHRoaXMuX2Nvb3JkaW5hdGVzKTtcclxuICB9XHJcblxyXG4gIGdldCBjb29yZGluYXRlcygpIHtcclxuICAgIHJldHVybiB0aGlzLl9jb29yZGluYXRlcztcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMiwgcHJpdmF0ZSBlbGVtZW50UmVmOiBFbGVtZW50UmVmKSB7fVxyXG5cclxuICB0cmFja0J5KGluZGV4KSB7XHJcbiAgICByZXR1cm4gaW5kZXg7XHJcbiAgfVxyXG5cclxuICBvbkNsaWNrKHBvaW50OiBQb0NoYXJ0UG9pbnRzQ29vcmRpbmF0ZXMpIHtcclxuICAgIGNvbnN0IHNlbGVjdGVkSXRlbSA9IHsgbGFiZWw6IHBvaW50LmxhYmVsLCBkYXRhOiBwb2ludC5kYXRhLCBjYXRlZ29yeTogcG9pbnQuY2F0ZWdvcnkgfTtcclxuXHJcbiAgICB0aGlzLnBvaW50Q2xpY2suZW1pdChzZWxlY3RlZEl0ZW0pO1xyXG4gIH1cclxuXHJcbiAgb25Nb3VzZUVudGVyKGV2ZW50OiBhbnksIHBvaW50OiBQb0NoYXJ0UG9pbnRzQ29vcmRpbmF0ZXMpIHtcclxuICAgIHRoaXMuc2V0UG9pbnRBdHRyaWJ1dGUoZXZlbnQudGFyZ2V0LCB0cnVlKTtcclxuXHJcbiAgICBjb25zdCBzZWxlY3RlZEl0ZW0gPSB7IGxhYmVsOiBwb2ludC5sYWJlbCwgZGF0YTogcG9pbnQuZGF0YSwgY2F0ZWdvcnk6IHBvaW50LmNhdGVnb3J5IH07XHJcbiAgICB0aGlzLnBvaW50SG92ZXIuZW1pdCh7IHJlbGF0aXZlVG86IHRoaXMucmVsYXRpdmVUbywgLi4uc2VsZWN0ZWRJdGVtIH0pO1xyXG4gIH1cclxuXHJcbiAgb25Nb3VzZUxlYXZlKGV2ZW50OiBhbnkpIHtcclxuICAgIHRoaXMuc2V0UG9pbnRBdHRyaWJ1dGUoZXZlbnQudGFyZ2V0LCBmYWxzZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGRpc3BsYXlQb2ludHNXaXRoRGVsYXkoXHJcbiAgICBjb29yZGluYXRlczogQXJyYXk8UG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzPlxyXG4gICk6IE9ic2VydmFibGU8QXJyYXk8UG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzPj4ge1xyXG4gICAgaWYgKHRoaXMuYW5pbWF0aW9uU3RhdGUgJiYgIWlzSUUoKSkge1xyXG4gICAgICBjb25zdCBhbmltYXRpb25UaW1lciA9IEFOSU1BVElPTl9EVVJBVElPTl9USU1FIC8gY29vcmRpbmF0ZXMubGVuZ3RoO1xyXG5cclxuICAgICAgcmV0dXJuIGZyb20oY29vcmRpbmF0ZXMpLnBpcGUoXHJcbiAgICAgICAgY29uY2F0TWFwKChpdGVtLCBpbmRleCkgPT4gdGltZXIoaW5kZXggPT09IDAgfHwgIXRoaXMuYW5pbWF0ZSA/IDAgOiBhbmltYXRpb25UaW1lcikucGlwZShtYXBUbyhpdGVtKSkpLFxyXG4gICAgICAgIHNjYW4oKGFjYywgY3VycjogUG9DaGFydFBvaW50c0Nvb3JkaW5hdGVzKSA9PiBhY2MuY29uY2F0KGN1cnIpLCBbXSksXHJcbiAgICAgICAgdGFwKCgpID0+ICh0aGlzLmFuaW1hdGlvblN0YXRlID0gZmFsc2UpKVxyXG4gICAgICApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgcmV0dXJuIGZyb20oW2Nvb3JkaW5hdGVzXSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldFBvaW50QXR0cmlidXRlKHRhcmdldDogU1ZHRWxlbWVudCwgaXNIb3ZlcjogYm9vbGVhbikge1xyXG4gICAgdGhpcy5yZW5kZXJlci5zZXRBdHRyaWJ1dGUodGFyZ2V0LCAncicsIGlzSG92ZXIgPyBSQURJVVNfSE9WRVJfU0laRS50b1N0cmluZygpIDogUkFESVVTX0RFRkFVTFRfU0laRS50b1N0cmluZygpKTtcclxuICAgIGlmICh0aGlzLmNvbG9yLmluY2x1ZGVzKCdwby1jb2xvcicpKSB7XHJcbiAgICAgIHRoaXMucmVuZGVyZXIuc2V0QXR0cmlidXRlKFxyXG4gICAgICAgIHRhcmdldCxcclxuICAgICAgICAnY2xhc3MnLFxyXG4gICAgICAgIGlzSG92ZXIgPyBgJHt0aGlzLnN0cm9rZUNvbG9yfSAke3RoaXMuY29sb3J9YCA6IGBwby1jaGFydC1saW5lLXBvaW50IHBvLWNoYXJ0LWFjdGl2ZS1wb2ludCAke3RoaXMuc3Ryb2tlQ29sb3J9YFxyXG4gICAgICApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5yZW5kZXJlcltpc0hvdmVyID8gJ3NldFN0eWxlJyA6ICdyZW1vdmVTdHlsZSddKHRhcmdldCwgJ2ZpbGwnLCBpc0hvdmVyID8gdGhpcy5jb2xvciA6IHVuZGVmaW5lZCk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==
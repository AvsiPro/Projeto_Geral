import { Component, EventEmitter, Output, ViewChild } from '@angular/core';
import { isExternalLink, isIE } from '../../../../utils/util';
import { PoLanguageService } from './../../../../services/po-language/po-language.service';
import { poRichTextLiteralsDefault } from '../po-rich-text-literals';
export class PoRichTextLinkModalComponent {
    constructor(languageService) {
        this.languageService = languageService;
        this.command = new EventEmitter();
        this.linkEditing = new EventEmitter();
        this.selection = document.getSelection();
        this.literals = Object.assign({}, poRichTextLiteralsDefault[this.languageService.getShortLanguage()]);
        this.modalCancelAction = {
            label: this.literals.cancel,
            action: () => {
                this.modal.close();
                this.command.emit();
                this.retrieveCursorPosition();
                this.cleanUpFields();
            }
        };
        this.modalConfirmAction = {
            label: this.linkConfirmAction(),
            disabled: true,
            action: () => (this.isLinkEditing ? this.toEditLink() : this.toInsertLink(this.urlLink, this.urlLinkText))
        };
    }
    linkConfirmAction() {
        return this.isLinkEditing ? this.literals.editLink : this.literals.insertLink;
    }
    formModelValidate() {
        var _a;
        return (this.modalConfirmAction.disabled = (_a = this.modalLinkForm) === null || _a === void 0 ? void 0 : _a.invalid);
    }
    openModal(selectedLinkElement) {
        this.saveCursorPosition();
        this.prepareModalForLink(selectedLinkElement);
        this.modalConfirmAction.label = this.linkConfirmAction();
        this.modal.open();
    }
    selectedLink(linkElement) {
        this.isSelectedLink = !!linkElement;
        this.linkElement = linkElement;
    }
    checkIfIsEmpty(urlLink, urlLinkText) {
        return urlLinkText === undefined || urlLinkText.trim() === '' ? urlLink : urlLinkText;
    }
    cleanUpFields() {
        this.urlLink = undefined;
        this.urlLinkText = undefined;
        this.isLinkEditing = false;
        this.isSelectedLink = false;
        this.linkElement = undefined;
    }
    formReset(control) {
        control.markAsPristine();
        control.markAsUntouched();
        control.updateValueAndValidity();
    }
    prepareModalForLink(selectedLinkElement) {
        this.saveSelectionText();
        if (this.modalLinkForm) {
            this.formReset(this.modalLinkForm.control);
        }
        setTimeout(() => {
            this.formModelValidate();
        });
        this.selectedLink(selectedLinkElement);
        if (this.isSelectedLink) {
            this.isLinkEditing = true;
            this.setLinkEditableForModal();
        }
        this.linkEditing.emit(this.isLinkEditing);
    }
    restoreSelection() {
        if (this.savedSelection) {
            if (this.selection) {
                this.selection.removeAllRanges();
                this.selection.addRange(this.savedSelection);
            }
            return true;
        }
        else {
            return false;
        }
    }
    retrieveCursorPosition() {
        this.selection.collapse(this.savedCursorPosition[0], this.savedCursorPosition[1]);
    }
    saveCursorPosition() {
        this.savedCursorPosition = [this.selection.focusNode, this.selection.focusOffset];
    }
    saveSelectionText() {
        if (this.selection.anchorNode !== null) {
            this.savedSelection = this.selection.getRangeAt(0);
            this.urlLinkText = this.selection.toString();
        }
        else {
            return null;
        }
    }
    setLinkEditableForModal() {
        this.urlLinkText = this.linkElement.innerText;
        this.urlLink = this.linkElement.getAttribute('href');
    }
    toEditLink() {
        if (isIE()) {
            this.linkElement.parentNode.removeChild(this.linkElement);
        }
        else {
            this.linkElement.remove();
        }
        this.toInsertLink(this.urlLink, this.urlLinkText);
    }
    toInsertLink(urlLink, urlLinkText) {
        this.modal.close();
        this.restoreSelection();
        const urlLinkTextValue = this.checkIfIsEmpty(urlLink, urlLinkText);
        const urlAsExternalLink = isExternalLink(urlLink) ? urlLink : `http://${urlLink}`;
        const command = 'InsertHTML';
        const value = { urlLink: urlAsExternalLink, urlLinkText: urlLinkTextValue };
        this.command.emit({ command, value });
        this.cleanUpFields();
    }
}
PoRichTextLinkModalComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-rich-text-link-modal',
                template: "<po-modal\r\n  #modal\r\n  p-hide-close\r\n  [p-primary-action]=\"modalConfirmAction\"\r\n  [p-secondary-action]=\"modalCancelAction\"\r\n  [p-title]=\"linkConfirmAction()\"\r\n>\r\n  <form #modalLinkForm=\"ngForm\">\r\n    <div class=\"po-row\">\r\n      <po-input\r\n        class=\"po-md-12 po-mb-2\"\r\n        name=\"urlLinkText\"\r\n        [(ngModel)]=\"urlLinkText\"\r\n        p-optional\r\n        [p-label]=\"literals.linkTextLabel\"\r\n        [p-placeholder]=\"literals.linkTextLabel\"\r\n      >\r\n      </po-input>\r\n\r\n      <po-url\r\n        class=\"po-md-12\"\r\n        name=\"urlLink\"\r\n        [(ngModel)]=\"urlLink\"\r\n        p-label=\"Link\"\r\n        p-required\r\n        [p-help]=\"literals.linkUrlTextHelper\"\r\n        [p-placeholder]=\"literals.linkUrlTextPlaceholder\"\r\n        (p-change-model)=\"formModelValidate()\"\r\n      >\r\n      </po-url>\r\n    </div>\r\n  </form>\r\n</po-modal>\r\n"
            },] }
];
PoRichTextLinkModalComponent.ctorParameters = () => [
    { type: PoLanguageService }
];
PoRichTextLinkModalComponent.propDecorators = {
    modal: [{ type: ViewChild, args: ['modal', { static: true },] }],
    modalLinkForm: [{ type: ViewChild, args: ['modalLinkForm',] }],
    command: [{ type: Output, args: ['p-command',] }],
    linkEditing: [{ type: Output, args: ['p-link-editing',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LWxpbmstbW9kYWwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLWZpZWxkL3BvLXJpY2gtdGV4dC9wby1yaWNoLXRleHQtbGluay1tb2RhbC9wby1yaWNoLXRleHQtbGluay1tb2RhbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFNBQVMsRUFBYyxZQUFZLEVBQVUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUcvRixPQUFPLEVBQUUsY0FBYyxFQUFFLElBQUksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzlELE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdEQUF3RCxDQUFDO0FBRzNGLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBTXJFLE1BQU0sT0FBTyw0QkFBNEI7SUF1Q3ZDLFlBQW9CLGVBQWtDO1FBQWxDLG9CQUFlLEdBQWYsZUFBZSxDQUFtQjtRQWxDakMsWUFBTyxHQUFHLElBQUksWUFBWSxFQUFxRCxDQUFDO1FBRTNFLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztRQUdoRSxjQUFTLEdBQUcsUUFBUSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBSTNCLGFBQVEscUJBQ1oseUJBQXlCLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLEVBQ3JFO1FBRUYsc0JBQWlCLEdBQWtCO1lBQ2pDLEtBQUssRUFBRSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU07WUFDM0IsTUFBTSxFQUFFLEdBQUcsRUFBRTtnQkFDWCxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDO2dCQUNuQixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNwQixJQUFJ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LEVBQUU7NEJBRW5DLFNBQVMsU0FBQyxlQUFlO3NCQUV6QixNQUFNLFNBQUMsV0FBVzswQkFFbEIsTUFBTSxTQUFDLGdCQUFnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgRWxlbWVudFJlZiwgRXZlbnRFbWl0dGVyLCBPbkluaXQsIE91dHB1dCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgTmdGb3JtIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xyXG5cclxuaW1wb3J0IHsgaXNFeHRlcm5hbExpbmssIGlzSUUgfSBmcm9tICcuLi8uLi8uLi8uLi91dGlscy91dGlsJztcclxuaW1wb3J0IHsgUG9MYW5ndWFnZVNlcnZpY2UgfSBmcm9tICcuLy4uLy4uLy4uLy4uL3NlcnZpY2VzL3BvLWxhbmd1YWdlL3BvLWxhbmd1YWdlLnNlcnZpY2UnO1xyXG5cclxuaW1wb3J0IHsgUG9Nb2RhbEFjdGlvbiwgUG9Nb2RhbENvbXBvbmVudCB9IGZyb20gJy4uLy4uLy4uL3BvLW1vZGFsJztcclxuaW1wb3J0IHsgcG9SaWNoVGV4dExpdGVyYWxzRGVmYXVsdCB9IGZyb20gJy4uL3BvLXJpY2gtdGV4dC1saXRlcmFscyc7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ3BvLXJpY2gtdGV4dC1saW5rLW1vZGFsJyxcclxuICB0ZW1wbGF0ZVVybDogJy4vcG8tcmljaC10ZXh0LWxpbmstbW9kYWwuY29tcG9uZW50Lmh0bWwnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQb1JpY2hUZXh0TGlua01vZGFsQ29tcG9uZW50IHtcclxuICBAVmlld0NoaWxkKCdtb2RhbCcsIHsgc3RhdGljOiB0cnVlIH0pIG1vZGFsOiBQb01vZGFsQ29tcG9uZW50O1xyXG5cclxuICBAVmlld0NoaWxkKCdtb2RhbExpbmtGb3JtJykgbW9kYWxMaW5rRm9ybTogTmdGb3JtO1xyXG5cclxuICBAT3V0cHV0KCdwLWNvbW1hbmQnKSBjb21tYW5kID0gbmV3IEV2ZW50RW1pdHRlcjxzdHJpbmcgfCB7IGNvbW1hbmQ6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB8IGFueSB9PigpO1xyXG5cclxuICBAT3V0cHV0KCdwLWxpbmstZWRpdGluZycpIGxpbmtFZGl0aW5nID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gIHNhdmVkQ3Vyc29yUG9zaXRpb247XHJcbiAgc2VsZWN0aW9uID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7XHJcbiAgdXJsTGluazogc3RyaW5nO1xyXG4gIHVybExpbmtUZXh0OiBzdHJpbmc7XHJcblxyXG4gIHJlYWRvbmx5IGxpdGVyYWxzID0ge1xyXG4gICAgLi4ucG9SaWNoVGV4dExpdGVyYWxzRGVmYXVsdFt0aGlzLmxhbmd1YWdlU2VydmljZS5nZXRTaG9ydExhbmd1YWdlKCldXHJcbiAgfTtcclxuXHJcbiAgbW9kYWxDYW5jZWxBY3Rpb246IFBvTW9kYWxBY3Rpb24gPSB7XHJcbiAgICBsYWJlbDogdGhpcy5saXRlcmFscy5jYW5jZWwsXHJcbiAgICBhY3Rpb246ICgpID0+IHtcclxuICAgICAgdGhpcy5tb2RhbC5jbG9zZSgpO1xyXG4gICAgICB0aGlzLmNvbW1hbmQuZW1pdCgpO1xyXG4gICAgICB0aGlzLnJldHJpZXZlQ3Vyc29yUG9zaXRpb24oKTtcclxuICAgICAgdGhpcy5jbGVhblVwRmllbGRzKCk7XHJcbiAgICB9XHJcbiAgfTtcclxuXHJcbiAgbW9kYWxDb25maXJtQWN0aW9uID0ge1xyXG4gICAgbGFiZWw6IHRoaXMubGlua0NvbmZpcm1BY3Rpb24oKSxcclxuICAgIGRpc2FibGVkOiB0cnVlLFxyXG4gICAgYWN0aW9uOiAoKSA9PiAodGhpcy5pc0xpbmtFZGl0aW5nID8gdGhpcy50b0VkaXRMaW5rKCkgOiB0aGlzLnRvSW5zZXJ0TGluayh0aGlzLnVybExpbmssIHRoaXMudXJsTGlua1RleHQpKVxyXG4gIH07XHJcblxyXG4gIHByaXZhdGUgaXNMaW5rRWRpdGluZzogYm9vbGVhbjtcclxuICBwcml2YXRlIGlzU2VsZWN0ZWRMaW5rOiBib29sZWFuO1xyXG4gIHByaXZhdGUgbGlua0VsZW1lbnQ6IGFueTtcclxuICBwcml2YXRlIHNhdmVkU2VsZWN0aW9uOiBSYW5nZSB8IG51bGw7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbGFuZ3VhZ2VTZXJ2aWNlOiBQb0xhbmd1YWdlU2VydmljZSkge31cclxuXHJcbiAgbGlua0NvbmZpcm1BY3Rpb24oKTogc3RyaW5nIHtcclxuICAgIHJldHVybiB0aGlzLmlzTGlua0VkaXRpbmcgPyB0aGlzLmxpdGVyYWxzLmVkaXRMaW5rIDogdGhpcy5saXRlcmFscy5pbnNlcnRMaW5rO1xyXG4gIH1cclxuXHJcbiAgZm9ybU1vZGVsVmFsaWRhdGUoKSB7XHJcbiAgICByZXR1cm4gKHRoaXMubW9kYWxDb25maXJtQWN0aW9uLmRpc2FibGVkID0gdGhpcy5tb2RhbExpbmtGb3JtPy5pbnZhbGlkKTtcclxuICB9XHJcblxyXG4gIG9wZW5Nb2RhbChzZWxlY3RlZExpbmtFbGVtZW50OiBFbGVtZW50UmVmKSB7XHJcbiAgICB0aGlzLnNhdmVDdXJzb3JQb3NpdGlvbigpO1xyXG4gICAgdGhpcy5wcmVwYXJlTW9kYWxGb3JMaW5rKHNlbGVjdGVkTGlua0VsZW1lbnQpO1xyXG5cclxuICAgIHRoaXMubW9kYWxDb25maXJtQWN0aW9uLmxhYmVsID0gdGhpcy5saW5rQ29uZmlybUFjdGlvbigpO1xyXG4gICAgdGhpcy5tb2RhbC5vcGVuKCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNlbGVjdGVkTGluayhsaW5rRWxlbWVudDogRWxlbWVudFJlZikge1xyXG4gICAgdGhpcy5pc1NlbGVjdGVkTGluayA9ICEhbGlua0VsZW1lbnQ7XHJcbiAgICB0aGlzLmxpbmtFbGVtZW50ID0gbGlua0VsZW1lbnQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNoZWNrSWZJc0VtcHR5KHVybExpbms6IHN0cmluZywgdXJsTGlua1RleHQ6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIHVybExpbmtUZXh0ID09PSB1bmRlZmluZWQgfHwgdXJsTGlua1RleHQudHJpbSgpID09PSAnJyA/IHVybExpbmsgOiB1cmxMaW5rVGV4dDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2xlYW5VcEZpZWxkcygpIHtcclxuICAgIHRoaXMudXJsTGluayA9IHVuZGVmaW5lZDtcclxuICAgIHRoaXMudXJsTGlua1RleHQgPSB1bmRlZmluZWQ7XHJcbiAgICB0aGlzLmlzTGlua0VkaXRpbmcgPSBmYWxzZTtcclxuICAgIHRoaXMuaXNTZWxlY3RlZExpbmsgPSBmYWxzZTtcclxuICAgIHRoaXMubGlua0VsZW1lbnQgPSB1bmRlZmluZWQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGZvcm1SZXNldChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpIHtcclxuICAgIGNvbnRyb2wubWFya0FzUHJpc3RpbmUoKTtcclxuICAgIGNvbnRyb2wubWFya0FzVW50b3VjaGVkKCk7XHJcbiAgICBjb250cm9sLnVwZGF0ZVZhbHVlQW5kVmFsaWRpdHkoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcHJlcGFyZU1vZGFsRm9yTGluayhzZWxlY3RlZExpbmtFbGVtZW50OiBFbGVtZW50UmVmKSB7XHJcbiAgICB0aGlzLnNhdmVTZWxlY3Rpb25UZXh0KCk7XHJcbiAgICBpZiAodGhpcy5tb2RhbExpbmtGb3JtKSB7XHJcbiAgICAgIHRoaXMuZm9ybVJlc2V0KHRoaXMubW9kYWxMaW5rRm9ybS5jb250cm9sKTtcclxuICAgIH1cclxuXHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgdGhpcy5mb3JtTW9kZWxWYWxpZGF0ZSgpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5zZWxlY3RlZExpbmsoc2VsZWN0ZWRMaW5rRWxlbWVudCk7XHJcblxyXG4gICAgaWYgKHRoaXMuaXNTZWxlY3RlZExpbmspIHtcclxuICAgICAgdGhpcy5pc0xpbmtFZGl0aW5nID0gdHJ1ZTtcclxuICAgICAgdGhpcy5zZXRMaW5rRWRpdGFibGVGb3JNb2RhbCgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMubGlua0VkaXRpbmcuZW1pdCh0aGlzLmlzTGlua0VkaXRpbmcpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZXN0b3JlU2VsZWN0aW9uKCkge1xyXG4gICAgaWYgKHRoaXMuc2F2ZWRTZWxlY3Rpb24pIHtcclxuICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uKSB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3Rpb24ucmVtb3ZlQWxsUmFuZ2VzKCk7XHJcbiAgICAgICAgdGhpcy5zZWxlY3Rpb24uYWRkUmFuZ2UodGhpcy5zYXZlZFNlbGVjdGlvbik7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJldHJpZXZlQ3Vyc29yUG9zaXRpb24oKSB7XHJcbiAgICB0aGlzLnNlbGVjdGlvbi5jb2xsYXBzZSh0aGlzLnNhdmVkQ3Vyc29yUG9zaXRpb25bMF0sIHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvblsxXSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNhdmVDdXJzb3JQb3NpdGlvbigpIHtcclxuICAgIHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvbiA9IFt0aGlzLnNlbGVjdGlvbi5mb2N1c05vZGUsIHRoaXMuc2VsZWN0aW9uLmZvY3VzT2Zmc2V0XTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2F2ZVNlbGVjdGlvblRleHQoKSB7XHJcbiAgICBpZiAodGhpcy5zZWxlY3Rpb24uYW5jaG9yTm9kZSAhPT0gbnVsbCkge1xyXG4gICAgICB0aGlzLnNhdmVkU2VsZWN0aW9uID0gdGhpcy5zZWxlY3Rpb24uZ2V0UmFuZ2VBdCgwKTtcclxuICAgICAgdGhpcy51cmxMaW5rVGV4dCA9IHRoaXMuc2VsZWN0aW9uLnRvU3RyaW5nKCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0TGlua0VkaXRhYmxlRm9yTW9kYWwoKSB7XHJcbiAgICB0aGlzLnVybExpbmtUZXh0ID0gdGhpcy5saW5rRWxlbWVudC5pbm5lclRleHQ7XHJcbiAgICB0aGlzLnVybExpbmsgPSB0aGlzLmxpbmtFbGVtZW50LmdldEF0dHJpYnV0ZSgnaHJlZicpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB0b0VkaXRMaW5rKCkge1xyXG4gICAgaWYgKGlzSUUoKSkge1xyXG4gICAgICB0aGlzLmxpbmtFbGVtZW50LnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQodGhpcy5saW5rRWxlbWVudCk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB0aGlzLmxpbmtFbGVtZW50LnJlbW92ZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMudG9JbnNlcnRMaW5rKHRoaXMudXJsTGluaywgdGhpcy51cmxMaW5rVGV4dCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHRvSW5zZXJ0TGluayh1cmxMaW5rLCB1cmxMaW5rVGV4dCkge1xyXG4gICAgdGhpcy5tb2RhbC5jbG9zZSgpO1xyXG4gICAgdGhpcy5yZXN0b3JlU2VsZWN0aW9uKCk7XHJcblxyXG4gICAgY29uc3QgdXJsTGlua1RleHRWYWx1ZSA9IHRoaXMuY2hlY2tJZklzRW1wdHkodXJsTGluaywgdXJsTGlua1RleHQpO1xyXG4gICAgY29uc3QgdXJsQXNFeHRlcm5hbExpbmsgPSBpc0V4dGVybmFsTGluayh1cmxMaW5rKSA/IHVybExpbmsgOiBgaHR0cDovLyR7dXJsTGlua31gO1xyXG5cclxuICAgIGNvbnN0IGNvbW1hbmQ6IHN0cmluZyA9ICdJbnNlcnRIVE1MJztcclxuXHJcbiAgICBjb25zdCB2YWx1ZSA9IHsgdXJsTGluazogdXJsQXNFeHRlcm5hbExpbmssIHVybExpbmtUZXh0OiB1cmxMaW5rVGV4dFZhbHVlIH07XHJcblxyXG4gICAgdGhpcy5jb21tYW5kLmVtaXQoeyBjb21tYW5kLCB2YWx1ZSB9KTtcclxuXHJcbiAgICB0aGlzLmNsZWFuVXBGaWVsZHMoKTtcclxuICB9XHJcbn1cclxuIl19
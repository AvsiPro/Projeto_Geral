import { __awaiter } from "tslib";
import { Component, ChangeDetectorRef, ViewChildren } from '@angular/core';
import { ControlContainer, NgForm } from '@angular/forms';
import { TitleCasePipe } from '@angular/common';
import { PoDynamicFormFieldsBaseComponent } from './po-dynamic-form-fields-base.component';
import { PoDynamicFormValidationService } from '../po-dynamic-form-validation/po-dynamic-form-validation.service';
/**
 * @docsPrivate
 *
 * @description
 *
 * Componente de criação dos campos dinâmicos.
 */
export class PoDynamicFormFieldsComponent extends PoDynamicFormFieldsBaseComponent {
    constructor(titleCasePipe, validationService, changes, form) {
        super(titleCasePipe);
        this.validationService = validationService;
        this.changes = changes;
        this.form = form;
        this.previousValue = {};
    }
    ngOnChanges(changes) {
        if (changes.fields) {
            this.visibleFields = this.getVisibleFields();
        }
    }
    focus(property) {
        const foundComponent = this.components.find(component => component.name === property);
        if (foundComponent) {
            foundComponent.focus();
        }
    }
    isDisabled(field) {
        return field.disabled || this.disabledForm;
    }
    onChangeField(visibleField, objectValue) {
        return __awaiter(this, void 0, void 0, function* () {
            const { property } = visibleField;
            const isBooleanType = visibleField.type === 'boolean';
            const isChangedValueField = this.previousValue[property] !== this.value[property];
            if (visibleField.optionsService) {
                this.objectValue.emit(objectValue);
            }
            // verifica se o formulario esta touched para não disparar o validate ao carregar a tela.
            if ((this.form.touched || isBooleanType) && isChangedValueField) {
                const { changedField, changedFieldIndex } = this.getField(property);
                if (changedField.validate) {
                    yield this.validateField(changedField, changedFieldIndex, visibleField);
                }
                this.triggerValidationOnForm(changedFieldIndex);
            }
            this.updatePreviousValue();
        });
    }
    updatePreviousValue() {
        this.previousValue = JSON.parse(JSON.stringify(this.value));
    }
    trackBy(index) {
        return index;
    }
    applyFieldValidation(index, validatedField) {
        const field = this.fields[index];
        this.fields[index] = Object.assign(Object.assign({}, field), validatedField.field);
        this.updateFields();
        if (validatedField.hasOwnProperty('value')) {
            this.value[field.property] = validatedField.value;
        }
        this.changes.detectChanges();
        if (validatedField.focus) {
            this.focus(field.property);
        }
    }
    getField(property) {
        const changedFieldIndex = this.fields.findIndex(field => field.property === property);
        const changedField = this.fields[changedFieldIndex];
        return { changedField, changedFieldIndex };
    }
    triggerValidationOnForm(changedFieldIndex) {
        var _a;
        const isValidatableField = ((_a = this.validateFields) === null || _a === void 0 ? void 0 : _a.length)
            ? this.validateFieldsChecker(this.validateFields, this.fields[changedFieldIndex].property)
            : true;
        const hasValidationForm = this.validate && isValidatableField && this.formValidate.observers.length;
        if (hasValidationForm) {
            const updatedField = this.fields[changedFieldIndex];
            this.formValidate.emit(updatedField);
        }
    }
    updateFields() {
        this.fieldsChange.emit(this.fields);
        this.visibleFields = this.getVisibleFields();
    }
    validateFieldsChecker(validateFields, propertyField) {
        return validateFields.some(validateFieldItem => validateFieldItem === propertyField);
    }
    validateField(field, fieldIndex, visibleField) {
        return __awaiter(this, void 0, void 0, function* () {
            const value = this.value[field.property];
            const previousDisabled = visibleField.disabled;
            visibleField.disabled = true;
            this.changes.detectChanges();
            try {
                const validatedField = yield this.validationService.sendFieldChange(field, value).toPromise();
                this.applyFieldValidation(fieldIndex, validatedField);
            }
            catch (_a) {
                visibleField.disabled = previousDisabled;
            }
        });
    }
}
PoDynamicFormFieldsComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-dynamic-form-fields',
                template: "<div class=\"po-row\" *ngIf=\"visibleFields && visibleFields.length > 0\">\r\n  <ng-container *ngFor=\"let field of visibleFields; trackBy: trackBy\">\r\n    <po-divider *ngIf=\"field?.divider?.trim()\" class=\"po-sm-12\" [p-label]=\"field.divider\"> </po-divider>\r\n\r\n    <po-datepicker\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'datepicker')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-error-pattern]=\"field.errorMessage\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-format]=\"field.format\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-locale]=\"field.locale\"\r\n      [p-max-date]=\"field.maxValue\"\r\n      [p-min-date]=\"field.minValue\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n      [p-placeholder]=\"field.placeholder\"\r\n    >\r\n    </po-datepicker>\r\n\r\n    <po-datepicker-range\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'datepickerrange')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n    >\r\n    </po-datepicker-range>\r\n\r\n    <po-input\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'input')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-error-pattern]=\"field.errorMessage\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-mask-format-model]=\"field.maskFormatModel\"\r\n      [p-mask]=\"field.mask\"\r\n      [p-maxlength]=\"field.maxLength\"\r\n      [p-minlength]=\"field.minLength\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-pattern]=\"field.pattern\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n      [p-icon]=\"field.icon\"\r\n      [p-placeholder]=\"field.placeholder\"\r\n    >\r\n    </po-input>\r\n\r\n    <po-number\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'number')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-error-pattern]=\"field.errorMessage\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-min]=\"field.minValue\"\r\n      [p-max]=\"field.maxValue\"\r\n      [p-maxlength]=\"field.maxLength\"\r\n      [p-minlength]=\"field.minLength\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n      [p-icon]=\"field.icon\"\r\n      [p-placeholder]=\"field.placeholder\"\r\n    >\r\n    </po-number>\r\n\r\n    <po-decimal\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'decimal')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-decimals-length]=\"field.decimalsLength\"\r\n      [p-thousand-maxlength]=\"field.thousandMaxlength\"\r\n      [p-icon]=\"field.icon\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-locale]=\"field.locale\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n      [p-placeholder]=\"field.placeholder\"\r\n    >\r\n    </po-decimal>\r\n\r\n    <po-select\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'select')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-options]=\"field.options\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n      [p-placeholder]=\"field.placeholder\"\r\n    >\r\n    </po-select>\r\n\r\n    <po-radio-group\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'radioGroup')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-columns=\"3\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-options]=\"field.options\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n    >\r\n    </po-radio-group>\r\n\r\n    <po-switch\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'switch')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-label-off]=\"field.booleanFalse\"\r\n      [p-label-on]=\"field.booleanTrue\"\r\n      (p-change)=\"onChangeField(field)\"\r\n    >\r\n    </po-switch>\r\n\r\n    <po-combo\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'combo')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-emit-object-value\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-field-label]=\"field.fieldLabel\"\r\n      [p-field-value]=\"field.fieldValue\"\r\n      [p-filter-params]=\"field.params\"\r\n      [p-filter-service]=\"field.optionsService\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field, $event)\"\r\n      [p-icon]=\"field.icon\"\r\n      [p-placeholder]=\"field.placeholder\"\r\n    >\r\n    </po-combo>\r\n\r\n    <po-lookup\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'lookup')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      p-field-label=\"label\"\r\n      p-field-value=\"value\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-columns]=\"field.columns\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-field-label]=\"field.fieldLabel || 'label'\"\r\n      [p-field-value]=\"field.fieldValue || 'value'\"\r\n      [p-filter-params]=\"field.params\"\r\n      [p-filter-service]=\"field.searchService\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-field-format]=\"field.format\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n      [p-placeholder]=\"field.placeholder\"\r\n    >\r\n    </po-lookup>\r\n\r\n    <po-checkbox-group\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'checkboxGroup')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-columns=\"3\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-options]=\"field.options\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n    >\r\n    </po-checkbox-group>\r\n\r\n    <po-multiselect\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'multiselect')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-options]=\"field.options\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n      [p-placeholder]=\"field.placeholder\"\r\n      [p-field-label]=\"field.fieldLabel\"\r\n      [p-field-value]=\"field.fieldValue\"\r\n      [p-filter-service]=\"field.optionsService\"\r\n    >\r\n    </po-multiselect>\r\n\r\n    <po-textarea\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'textarea')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-maxlength]=\"field.maxLength\"\r\n      [p-minlength]=\"field.minLength\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-required]=\"field.required\"\r\n      [p-rows]=\"field.rows\"\r\n      (p-change)=\"onChangeField(field)\"\r\n      [p-placeholder]=\"field.placeholder\"\r\n    >\r\n    </po-textarea>\r\n\r\n    <po-password\r\n      #component\r\n      *ngIf=\"compareTo(field.control, 'password')\"\r\n      [name]=\"field.property\"\r\n      [(ngModel)]=\"value[field.property]\"\r\n      [ngClass]=\"field.componentClass\"\r\n      p-clean\r\n      [p-disabled]=\"isDisabled(field)\"\r\n      [p-error-pattern]=\"field.errorMessage\"\r\n      [p-auto-focus]=\"field.focus\"\r\n      [p-help]=\"field.help\"\r\n      [p-label]=\"field.label\"\r\n      [p-maxlength]=\"field.maxLength\"\r\n      [p-minlength]=\"field.minLength\"\r\n      [p-optional]=\"field.optional\"\r\n      [p-pattern]=\"field.pattern\"\r\n      [p-required]=\"field.required\"\r\n      (p-change)=\"onChangeField(field)\"\r\n      [p-placeholder]=\"field.placeholder\"\r\n    >\r\n    </po-password>\r\n  </ng-container>\r\n</div>\r\n",
                viewProviders: [{ provide: ControlContainer, useExisting: NgForm }],
                providers: [PoDynamicFormValidationService]
            },] }
];
PoDynamicFormFieldsComponent.ctorParameters = () => [
    { type: TitleCasePipe },
    { type: PoDynamicFormValidationService },
    { type: ChangeDetectorRef },
    { type: NgForm }
];
PoDynamicFormFieldsComponent.propDecorators = {
    components: [{ type: ViewChildren, args: ['component',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tZHluYW1pYy1mb3JtLWZpZWxkcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2NvbXBvbmVudHMvcG8tZHluYW1pYy9wby1keW5hbWljLWZvcm0vcG8tZHluYW1pYy1mb3JtLWZpZWxkcy9wby1keW5hbWljLWZvcm0tZmllbGRzLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBdUMsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hILE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFHaEQsT0FBTyxFQUFFLGdDQUFnQyxFQUFFLE1BQU0seUNBQXlDLENBQUM7QUFFM0YsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0sa0VBQWtFLENBQUM7QUFFbEg7Ozs7OztHQU1HO0FBT0gsTUFBTSxPQUFPLDRCQUE2QixTQUFRLGdDQUFnQztJQUtoRixZQUNFLGFBQTRCLEVBQ3BCLGlCQUFpRCxFQUNqRCxPQUEwQixFQUMxQixJQUFZO1FBRXBCLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUpiLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBZ0M7UUFDakQsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFDMUIsU0FBSSxHQUFKLElBQUksQ0FBUTtRQU5kLGtCQUFhLEdBQUcsRUFBRSxDQUFDO0lBUzNCLENBQUM7SUFFRCxXQUFXLENBQUMsT0FBc0I7UUFDaEMsSUFBSSxPQUFPLENBQUMsTUFBTSxFQUFFO1lBQ2xCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7U0FDOUM7SUFDSCxDQUFDO0lBRUQsS0FBSyxDQUFDLFFBQWdC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SUFBSSxDQUFDO1lBQzdCLElBQUksQ0FBQyxPQUFPLENBQUMsYUFBYSxFQUFFLENBQUM7WUFFN0IsSUFBSTtnQkFDRixNQUFNLGNBQWMsR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUM5RixJQUFJLENBQUMsb0JBQW9CLENBQUMsVUFBVSxFQUFFLGNBQWMsQ0FBQyxDQUFDO2FBQ3ZEO1lBQUMsV0FBTTtnQkFDTixZQUFZLENBQUMsUUFBUSxHQUFHLGdCQUFnQixDQUFDO2FBQzFDO1FBQ0gsQ0FBQztLQUFBOzs7WUE5SEYsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSx3QkFBd0I7Z0JBQ2xDLDQyVUFBb0Q7Z0JBQ3BELGFBQWEsRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUUsQ0FBQztnQkFDbkUsU0FBUyxFQUFFLENBQUMsOEJBQThCLENBQUM7YUFDNUM7OztZQW5CUSxhQUFhO1lBS2IsOEJBQThCO1lBUG5CLGlCQUFpQjtZQUNWLE1BQU07Ozt5QkFzQjlCLFlBQVksU0FBQyxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBDaGFuZ2VEZXRlY3RvclJlZiwgT25DaGFuZ2VzLCBRdWVyeUxpc3QsIFNpbXBsZUNoYW5nZXMsIFZpZXdDaGlsZHJlbiB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBDb250cm9sQ29udGFpbmVyLCBOZ0Zvcm0gfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XHJcbmltcG9ydCB7IFRpdGxlQ2FzZVBpcGUgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xyXG5cclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUZpZWxkIH0gZnJvbSAnLi4vcG8tZHluYW1pYy1mb3JtLWZpZWxkLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1GaWVsZHNCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1keW5hbWljLWZvcm0tZmllbGRzLWJhc2UuY29tcG9uZW50JztcclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUZpZWxkVmFsaWRhdGlvbiB9IGZyb20gJy4uL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uL3BvLWR5bmFtaWMtZm9ybS1maWVsZC12YWxpZGF0aW9uLmludGVyZmFjZSc7XHJcbmltcG9ydCB7IFBvRHluYW1pY0Zvcm1WYWxpZGF0aW9uU2VydmljZSB9IGZyb20gJy4uL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uLnNlcnZpY2UnO1xyXG5cclxuLyoqXHJcbiAqIEBkb2NzUHJpdmF0ZVxyXG4gKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICpcclxuICogQ29tcG9uZW50ZSBkZSBjcmlhw6fDo28gZG9zIGNhbXBvcyBkaW7Dom1pY29zLlxyXG4gKi9cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdwby1keW5hbWljLWZvcm0tZmllbGRzJyxcclxuICB0ZW1wbGF0ZVVybDogJ3BvLWR5bmFtaWMtZm9ybS1maWVsZHMuY29tcG9uZW50Lmh0bWwnLFxyXG4gIHZpZXdQcm92aWRlcnM6IFt7IHByb3ZpZGU6IENvbnRyb2xDb250YWluZXIsIHVzZUV4aXN0aW5nOiBOZ0Zvcm0gfV0sXHJcbiAgcHJvdmlkZXJzOiBbUG9EeW5hbWljRm9ybVZhbGlkYXRpb25TZXJ2aWNlXVxyXG59KVxyXG5leHBvcnQgY2xhc3MgUG9EeW5hbWljRm9ybUZpZWxkc0NvbXBvbmVudCBleHRlbmRzIFBvRHluYW1pY0Zvcm1GaWVsZHNCYXNlQ29tcG9uZW50IGltcGxlbWVudHMgT25DaGFuZ2VzIHtcclxuICBAVmlld0NoaWxkcmVuKCdjb21wb25lbnQnKSBjb21wb25lbnRzOiBRdWVyeUxpc3Q8eyBuYW1lOiBzdHJpbmc7IGZvY3VzOiAoKSA9PiB2b2lkIH0+O1xyXG5cclxuICBwcml2YXRlIHByZXZpb3VzVmFsdWUgPSB7fTtcclxuXHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICB0aXRsZUNhc2VQaXBlOiBUaXRsZUNhc2VQaXBlLFxyXG4gICAgcHJpdmF0ZSB2YWxpZGF0aW9uU2VydmljZTogUG9EeW5hbWljRm9ybVZhbGlkYXRpb25TZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBjaGFuZ2VzOiBDaGFuZ2VEZXRlY3RvclJlZixcclxuICAgIHByaXZhdGUgZm9ybTogTmdGb3JtXHJcbiAgKSB7XHJcbiAgICBzdXBlcih0aXRsZUNhc2VQaXBlKTtcclxuICB9XHJcblxyXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcclxuICAgIGlmIChjaGFuZ2VzLmZpZWxkcykge1xyXG4gICAgICB0aGlzLnZpc2libGVGaWVsZHMgPSB0aGlzLmdldFZpc2libGVGaWVsZHMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGZvY3VzKHByb3BlcnR5OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGZvdW5kQ29tcG9uZW50ID0gdGhpcy5jb21wb25lbnRzLmZpbmQoY29tcG9uZW50ID0+IGNvbXBvbmVudC5uYW1lID09PSBwcm9wZXJ0eSk7XHJcbiAgICBpZiAoZm91bmRDb21wb25lbnQpIHtcclxuICAgICAgZm91bmRDb21wb25lbnQuZm9jdXMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGlzRGlzYWJsZWQoZmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIGZpZWxkLmRpc2FibGVkIHx8IHRoaXMuZGlzYWJsZWRGb3JtO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgb25DaGFuZ2VGaWVsZCh2aXNpYmxlRmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZCwgb2JqZWN0VmFsdWU/OiBhbnkpIHtcclxuICAgIGNvbnN0IHsgcHJvcGVydHkgfSA9IHZpc2libGVGaWVsZDtcclxuICAgIGNvbnN0IGlzQm9vbGVhblR5cGUgPSB2aXNpYmxlRmllbGQudHlwZSA9PT0gJ2Jvb2xlYW4nO1xyXG4gICAgY29uc3QgaXNDaGFuZ2VkVmFsdWVGaWVsZCA9IHRoaXMucHJldmlvdXNWYWx1ZVtwcm9wZXJ0eV0gIT09IHRoaXMudmFsdWVbcHJvcGVydHldO1xyXG5cclxuICAgIGlmICh2aXNpYmxlRmllbGQub3B0aW9uc1NlcnZpY2UpIHtcclxuICAgICAgdGhpcy5vYmplY3RWYWx1ZS5lbWl0KG9iamVjdFZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICAvLyB2ZXJpZmljYSBzZSBvIGZvcm11bGFyaW8gZXN0YSB0b3VjaGVkIHBhcmEgbsOjbyBkaXNwYXJhciBvIHZhbGlkYXRlIGFvIGNhcnJlZ2FyIGEgdGVsYS5cclxuICAgIGlmICgodGhpcy5mb3JtLnRvdWNoZWQgfHwgaXNCb29sZWFuVHlwZSkgJiYgaXNDaGFuZ2VkVmFsdWVGaWVsZCkge1xyXG4gICAgICBjb25zdCB7IGNoYW5nZWRGaWVsZCwgY2hhbmdlZEZpZWxkSW5kZXggfSA9IHRoaXMuZ2V0RmllbGQocHJvcGVydHkpO1xyXG5cclxuICAgICAgaWYgKGNoYW5nZWRGaWVsZC52YWxpZGF0ZSkge1xyXG4gICAgICAgIGF3YWl0IHRoaXMudmFsaWRhdGVGaWVsZChjaGFuZ2VkRmllbGQsIGNoYW5nZWRGaWVsZEluZGV4LCB2aXNpYmxlRmllbGQpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLnRyaWdnZXJWYWxpZGF0aW9uT25Gb3JtKGNoYW5nZWRGaWVsZEluZGV4KTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnVwZGF0ZVByZXZpb3VzVmFsdWUoKTtcclxuICB9XHJcblxyXG4gIHVwZGF0ZVByZXZpb3VzVmFsdWUoKSB7XHJcbiAgICB0aGlzLnByZXZpb3VzVmFsdWUgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMudmFsdWUpKTtcclxuICB9XHJcblxyXG4gIHRyYWNrQnkoaW5kZXgpIHtcclxuICAgIHJldHVybiBpbmRleDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYXBwbHlGaWVsZFZhbGlkYXRpb24oaW5kZXg6IG51bWJlciwgdmFsaWRhdGVkRmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZFZhbGlkYXRpb24pIHtcclxuICAgIGNvbnN0IGZpZWxkID0gdGhpcy5maWVsZHNbaW5kZXhdO1xyXG5cclxuICAgIHRoaXMuZmllbGRzW2luZGV4XSA9IHsgLi4uZmllbGQsIC4uLnZhbGlkYXRlZEZpZWxkLmZpZWxkIH07XHJcbiAgICB0aGlzLnVwZGF0ZUZpZWxkcygpO1xyXG5cclxuICAgIGlmICh2YWxpZGF0ZWRGaWVsZC5oYXNPd25Qcm9wZXJ0eSgndmFsdWUnKSkge1xyXG4gICAgICB0aGlzLnZhbHVlW2ZpZWxkLnByb3BlcnR5XSA9IHZhbGlkYXRlZEZpZWxkLnZhbHVlO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuY2hhbmdlcy5kZXRlY3RDaGFuZ2VzKCk7XHJcblxyXG4gICAgaWYgKHZhbGlkYXRlZEZpZWxkLmZvY3VzKSB7XHJcbiAgICAgIHRoaXMuZm9jdXMoZmllbGQucHJvcGVydHkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRGaWVsZChwcm9wZXJ0eTogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBjaGFuZ2VkRmllbGRJbmRleCA9IHRoaXMuZmllbGRzLmZpbmRJbmRleChmaWVsZCA9PiBmaWVsZC5wcm9wZXJ0eSA9PT0gcHJvcGVydHkpO1xyXG4gICAgY29uc3QgY2hhbmdlZEZpZWxkID0gdGhpcy5maWVsZHNbY2hhbmdlZEZpZWxkSW5kZXhdO1xyXG5cclxuICAgIHJldHVybiB7IGNoYW5nZWRGaWVsZCwgY2hhbmdlZEZpZWxkSW5kZXggfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdHJpZ2dlclZhbGlkYXRpb25PbkZvcm0oY2hhbmdlZEZpZWxkSW5kZXg6IG51bWJlcikge1xyXG4gICAgY29uc3QgaXNWYWxpZGF0YWJsZUZpZWxkID0gdGhpcy52YWxpZGF0ZUZpZWxkcz8ubGVuZ3RoXHJcbiAgICAgID8gdGhpcy52YWxpZGF0ZUZpZWxkc0NoZWNrZXIodGhpcy52YWxpZGF0ZUZpZWxkcywgdGhpcy5maWVsZHNbY2hhbmdlZEZpZWxkSW5kZXhdLnByb3BlcnR5KVxyXG4gICAgICA6IHRydWU7XHJcbiAgICBjb25zdCBoYXNWYWxpZGF0aW9uRm9ybSA9IHRoaXMudmFsaWRhdGUgJiYgaXNWYWxpZGF0YWJsZUZpZWxkICYmIHRoaXMuZm9ybVZhbGlkYXRlLm9ic2VydmVycy5sZW5ndGg7XHJcblxyXG4gICAgaWYgKGhhc1ZhbGlkYXRpb25Gb3JtKSB7XHJcbiAgICAgIGNvbnN0IHVwZGF0ZWRGaWVsZCA9IHRoaXMuZmllbGRzW2NoYW5nZWRGaWVsZEluZGV4XTtcclxuICAgICAgdGhpcy5mb3JtVmFsaWRhdGUuZW1pdCh1cGRhdGVkRmllbGQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB1cGRhdGVGaWVsZHMoKSB7XHJcbiAgICB0aGlzLmZpZWxkc0NoYW5nZS5lbWl0KHRoaXMuZmllbGRzKTtcclxuICAgIHRoaXMudmlzaWJsZUZpZWxkcyA9IHRoaXMuZ2V0VmlzaWJsZUZpZWxkcygpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSB2YWxpZGF0ZUZpZWxkc0NoZWNrZXIodmFsaWRhdGVGaWVsZHM6IEFycmF5PHN0cmluZz4sIHByb3BlcnR5RmllbGQ6IFBvRHluYW1pY0Zvcm1GaWVsZFsncHJvcGVydHknXSk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHZhbGlkYXRlRmllbGRzLnNvbWUodmFsaWRhdGVGaWVsZEl0ZW0gPT4gdmFsaWRhdGVGaWVsZEl0ZW0gPT09IHByb3BlcnR5RmllbGQpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhc3luYyB2YWxpZGF0ZUZpZWxkKGZpZWxkOiBQb0R5bmFtaWNGb3JtRmllbGQsIGZpZWxkSW5kZXg6IG51bWJlciwgdmlzaWJsZUZpZWxkOiBQb0R5bmFtaWNGb3JtRmllbGQpIHtcclxuICAgIGNvbnN0IHZhbHVlID0gdGhpcy52YWx1ZVtmaWVsZC5wcm9wZXJ0eV07XHJcblxyXG4gICAgY29uc3QgcHJldmlvdXNEaXNhYmxlZCA9IHZpc2libGVGaWVsZC5kaXNhYmxlZDtcclxuICAgIHZpc2libGVGaWVsZC5kaXNhYmxlZCA9IHRydWU7XHJcbiAgICB0aGlzLmNoYW5nZXMuZGV0ZWN0Q2hhbmdlcygpO1xyXG5cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnN0IHZhbGlkYXRlZEZpZWxkID0gYXdhaXQgdGhpcy52YWxpZGF0aW9uU2VydmljZS5zZW5kRmllbGRDaGFuZ2UoZmllbGQsIHZhbHVlKS50b1Byb21pc2UoKTtcclxuICAgICAgdGhpcy5hcHBseUZpZWxkVmFsaWRhdGlvbihmaWVsZEluZGV4LCB2YWxpZGF0ZWRGaWVsZCk7XHJcbiAgICB9IGNhdGNoIHtcclxuICAgICAgdmlzaWJsZUZpZWxkLmRpc2FibGVkID0gcHJldmlvdXNEaXNhYmxlZDtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19
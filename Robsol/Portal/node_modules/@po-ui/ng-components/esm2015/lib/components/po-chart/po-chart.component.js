import { ChangeDetectorRef, Component, ComponentFactoryResolver, ElementRef, HostListener, ViewChild, ViewContainerRef, Renderer2 } from '@angular/core';
import { Subject, Subscription } from 'rxjs';
import { PoChartAxisXLabelArea, PoChartPadding } from './helpers/po-chart-default-values.constant';
import { PoDefaultColors } from '../../services/po-color/po-colors.constant';
import { PoChartBaseComponent } from './po-chart-base.component';
import { PoChartSvgContainerService } from './services/po-chart-svg-container.service';
import { PoChartGaugeComponent } from './po-chart-types/po-chart-gauge/po-chart-gauge.component';
import { PoChartType } from './enums/po-chart-type.enum';
import { PoColorService } from '../../services/po-color/po-color.service';
import { PoChartMathsService } from './services/po-chart-maths.service';
/**
 * @docsExtends PoChartBaseComponent
 *
 * @example
 *
 * <example name="po-chart-basic" title="PO Chart Basic">
 *  <file name="sample-po-chart-basic/sample-po-chart-basic.component.html"> </file>
 *  <file name="sample-po-chart-basic/sample-po-chart-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-chart-labs" title="PO Chart Labs">
 *  <file name="sample-po-chart-labs/sample-po-chart-labs.component.html"> </file>
 *  <file name="sample-po-chart-labs/sample-po-chart-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-chart-coffee-ranking" title="PO Chart - Coffee Ranking">
 *  <file name="sample-po-chart-coffee-ranking/sample-po-chart-coffee-ranking.component.html"> </file>
 *  <file name="sample-po-chart-coffee-ranking/sample-po-chart-coffee-ranking.component.ts"> </file>
 * </example>
 */
export class PoChartComponent extends PoChartBaseComponent {
    constructor(colorService, changeDetector, containerService, componentFactoryResolver, elementRef, mathsService, renderer) {
        super(colorService);
        this.colorService = colorService;
        this.changeDetector = changeDetector;
        this.containerService = containerService;
        this.componentFactoryResolver = componentFactoryResolver;
        this.elementRef = elementRef;
        this.mathsService = mathsService;
        this.renderer = renderer;
        this.calculatedComponentRefElement = false;
        this.calculatedSvgContainerElement = false;
        this.initialized = false;
        this.windowResizeListener = new Subject();
        this.subscription = new Subscription();
        this.mappings = {
            [PoChartType.Gauge]: PoChartGaugeComponent
        };
        this.onResize = () => {
            this.getSvgContainerSize();
            this.windowResizeListener.next();
        };
    }
    get isChartGaugeType() {
        return this.type === PoChartType.Gauge;
    }
    ngAfterViewInit() {
        this.initialized = true;
        this.getSvgContainerSize();
    }
    ngDoCheck() {
        const charWrapperWidth = this.chartWrapper.nativeElement.offsetWidth;
        const isDynamicChart = this.getComponentType(this.type);
        // Permite que o chart seja calculado na primeira vez que o componente torna-se visível,
        // evitando com isso, problemas com Tabs ou Divs que iniciem escondidas.
        // Quando modificada a estrutura dos gráficos do tipo circular isto será melhorado.
        if (charWrapperWidth && this.initialized) {
            if (!isDynamicChart && !this.calculatedSvgContainerElement) {
                this.getSvgContainerSize();
                this.calculatedSvgContainerElement = true;
            }
            else if (isDynamicChart && !this.calculatedComponentRefElement) {
                this.dynamicComponentSetting();
                this.calculatedComponentRefElement = true;
            }
        }
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
        this.removeWindowResizeListener();
    }
    resizeAction() {
        this.getSvgContainerSize();
        this.windowResizeListener.next();
        this.changeDetector.detectChanges();
    }
    ngOnInit() {
        this.getSvgContainerSize();
    }
    rebuildComponentRef() {
        if (this.componentRef) {
            this.componentRef.destroy();
            if (this.isChartGaugeType) {
                this.dynamicComponentSetting();
            }
        }
    }
    calculateAxisXLabelArea() {
        const axisXLabels = this.chartType === PoChartType.Bar ? this.categories : this.chartSeries;
        return this.getAxisXLabelArea(this.mathsService.getLongestDataValue(axisXLabels, this.chartType, this.options));
    }
    getSvgContainerSize() {
        let axisXLabelWidth;
        const { chartHeaderHeight, chartLegendHeight, chartWrapperWidth } = this.getChartMeasurements();
        if (!this.isTypeCircular) {
            axisXLabelWidth = this.calculateAxisXLabelArea();
        }
        this.svgContainerSize = Object.assign(Object.assign({}, this.containerService.calculateSVGContainerMeasurements(this.height, chartWrapperWidth, chartHeaderHeight, chartLegendHeight)), { axisXLabelWidth });
    }
    chartLegendHeight(chartLegend) {
        return chartLegend ? chartLegend.nativeElement.offsetHeight : 0;
    }
    createComponent() {
        const componentType = this.getComponentType(this.type);
        const factory = this.componentFactoryResolver.resolveComponentFactory(componentType);
        this.componentRef = this.chartContainer.createComponent(factory);
        const instance = this.componentRef.instance;
        this.setComponentRefProperties(instance);
        return instance;
    }
    dynamicComponentSetting() {
        const instance = this.createComponent();
        this.setResizeListenerSubscribe(instance);
        this.changeDetector.detectChanges();
        this.setClickSubscribe(instance);
        this.setHoverSubscribe(instance);
    }
    getAxisXLabelArea(axisXLabel) {
        const labelPoChartPadding = PoChartPadding / 3;
        const spanElement = this.renderer.createElement('span');
        this.renderer.addClass(spanElement, 'po-chart-axis-x-label');
        spanElement.innerHTML = axisXLabel;
        this.renderer.appendChild(this.elementRef.nativeElement, spanElement);
        const axisXLabelWidth = Math.ceil(spanElement.offsetWidth) + labelPoChartPadding;
        this.renderer.removeChild(this.elementRef.nativeElement, spanElement);
        return axisXLabelWidth > PoChartAxisXLabelArea ? axisXLabelWidth : PoChartAxisXLabelArea;
    }
    getComponentType(typeName) {
        return this.mappings[typeName];
    }
    getChartMeasurements() {
        const chartWrapperWidth = this.chartWrapper.nativeElement.offsetWidth;
        const chartHeaderHeight = this.chartHeader.nativeElement.offsetHeight;
        const chartLegendHeight = this.chartLegendHeight(this.chartLegend);
        return { chartWrapperWidth, chartHeaderHeight, chartLegendHeight };
    }
    removeWindowResizeListener() {
        if (this.onResize) {
            this.onResize = () => { };
        }
    }
    setComponentRefProperties(instance) {
        const { chartHeaderHeight, chartLegendHeight, chartWrapperWidth } = this.getChartMeasurements();
        instance.chartHeader = chartHeaderHeight;
        instance.chartLegend = chartLegendHeight;
        instance.chartWrapper = chartWrapperWidth;
        instance.colors = PoDefaultColors[0];
        instance.height = this.height;
        instance.type = this.type;
        instance.series = this.chartSeries || [];
    }
    setClickSubscribe(instance) {
        this.subscription.add(instance.onSerieClick.subscribe(event => {
            this.onSeriesClick(event);
        }));
    }
    setHoverSubscribe(instance) {
        this.subscription.add(instance.onSerieHover.subscribe(event => {
            this.onSeriesHover(event);
        }));
    }
    setResizeListenerSubscribe(instance) {
        this.subscription.add(this.windowResizeListener.subscribe(() => {
            const measuresForComponentRef = this.getChartMeasurements();
            instance.chartWrapper = measuresForComponentRef.chartWrapperWidth;
            instance.chartHeader = measuresForComponentRef.chartHeaderHeight;
            instance.chartLegend = measuresForComponentRef.chartLegendHeight;
        }));
    }
}
PoChartComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-chart',
                template: "<div #chartWrapper class=\"po-chart-wrapper\" (p-resize-observer)=\"resizeAction()\">\r\n  <div #chartHeader class=\"po-chart-header\">\r\n    <div class=\"po-chart-title\">{{ title }}</div>\r\n  </div>\r\n\r\n  <po-chart-container\r\n    *ngIf=\"!isChartGaugeType\"\r\n    [p-options]=\"options\"\r\n    [p-type]=\"chartType\"\r\n    [p-series]=\"chartSeries\"\r\n    [p-categories]=\"categories\"\r\n    [p-container-size]=\"svgContainerSize\"\r\n    (p-serie-click)=\"onSeriesClick($event)\"\r\n    (p-serie-hover)=\"onSeriesHover($event)\"\r\n  ></po-chart-container>\r\n\r\n  <!-- Inje\u00E7\u00E3o de gr\u00E1ficos do tipo gauge. Remover na deprecia\u00E7\u00E3o.  -->\r\n  <ng-template #chartContainer></ng-template>\r\n\r\n  <div *ngIf=\"!isChartGaugeType && options?.legend !== false\">\r\n    <ng-container *ngTemplateOutlet=\"chartLegendGroup\"></ng-container>\r\n  </div>\r\n</div>\r\n\r\n<ng-template #chartLegendGroup>\r\n  <po-chart-legend #chartLegend [p-series]=\"chartSeries\" [p-type]=\"type\"> </po-chart-legend>\r\n</ng-template>\r\n"
            },] }
];
PoChartComponent.ctorParameters = () => [
    { type: PoColorService },
    { type: ChangeDetectorRef },
    { type: PoChartSvgContainerService },
    { type: ComponentFactoryResolver },
    { type: ElementRef },
    { type: PoChartMathsService },
    { type: Renderer2 }
];
PoChartComponent.propDecorators = {
    chartContainer: [{ type: ViewChild, args: ['chartContainer', { read: ViewContainerRef, static: true },] }],
    chartHeader: [{ type: ViewChild, args: ['chartHeader', { static: true },] }],
    chartLegend: [{ type: ViewChild, args: ['chartLegend', { read: ElementRef },] }],
    chartWrapper: [{ type: ViewChild, args: ['chartWrapper', { static: true },] }],
    onResize: [{ type: HostListener, args: ['window:resize',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tY2hhcnQuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLWNoYXJ0L3BvLWNoYXJ0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCx3QkFBd0IsRUFHeEIsVUFBVSxFQUNWLFlBQVksRUFFWixTQUFTLEVBQ1QsZ0JBQWdCLEVBRWhCLFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUU3QyxPQUFPLEVBQUUscUJBQXFCLEVBQUUsY0FBYyxFQUFFLE1BQU0sNENBQTRDLENBQUM7QUFDbkcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRDQUE0QyxDQUFDO0FBRTdFLE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ2pFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBRXZGLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDBEQUEwRCxDQUFDO0FBQ2pHLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSw0QkFBNEIsQ0FBQztBQUV6RCxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sMENBQTBDLENBQUM7QUFDMUUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbUNBQW1DLENBQUM7QUFFeEU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FtQkc7QUFLSCxNQUFNLE9BQU8sZ0JBQWlCLFNBQVEsb0JBQW9CO0lBb0J4RCxZQUNZLFlBQTRCLEVBQzlCLGNBQWlDLEVBQ2pDLGdCQUE0QyxFQUM1Qyx3QkFBa0QsRUFDbEQsVUFBc0IsRUFDdEIsWUFBaUMsRUFDakMsUUFBbUI7UUFFM0IsS0FBSyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FB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YSxFQUFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRTswQkFFekMsU0FBUyxTQUFDLGFBQWEsRUFBRSxFQUFFLElBQUksRUFBRSxVQUFVLEVBQUU7MkJBRTdDLFNBQVMsU0FBQyxjQUFjLEVBQUUsRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFO3VCQTZCMUMsWUFBWSxTQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xyXG4gIEFmdGVyVmlld0luaXQsXHJcbiAgQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgQ29tcG9uZW50LFxyXG4gIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICBDb21wb25lbnRSZWYsXHJcbiAgRG9DaGVjayxcclxuICBFbGVtZW50UmVmLFxyXG4gIEhvc3RMaXN0ZW5lcixcclxuICBPbkRlc3Ryb3ksXHJcbiAgVmlld0NoaWxkLFxyXG4gIFZpZXdDb250YWluZXJSZWYsXHJcbiAgT25Jbml0LFxyXG4gIFJlbmRlcmVyMlxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgU3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XHJcblxyXG5pbXBvcnQgeyBQb0NoYXJ0QXhpc1hMYWJlbEFyZWEsIFBvQ2hhcnRQYWRkaW5nIH0gZnJvbSAnLi9oZWxwZXJzL3BvLWNoYXJ0LWRlZmF1bHQtdmFsdWVzLmNvbnN0YW50JztcclxuaW1wb3J0IHsgUG9EZWZhdWx0Q29sb3JzIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcG8tY29sb3IvcG8tY29sb3JzLmNvbnN0YW50JztcclxuXHJcbmltcG9ydCB7IFBvQ2hhcnRCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi9wby1jaGFydC1iYXNlLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IFBvQ2hhcnRTdmdDb250YWluZXJTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9wby1jaGFydC1zdmctY29udGFpbmVyLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBQb0NoYXJ0RHluYW1pY1R5cGVDb21wb25lbnQgfSBmcm9tICcuL3BvLWNoYXJ0LXR5cGVzL3BvLWNoYXJ0LWR5bmFtaWMtdHlwZS5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBQb0NoYXJ0R2F1Z2VDb21wb25lbnQgfSBmcm9tICcuL3BvLWNoYXJ0LXR5cGVzL3BvLWNoYXJ0LWdhdWdlL3BvLWNoYXJ0LWdhdWdlLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IFBvQ2hhcnRUeXBlIH0gZnJvbSAnLi9lbnVtcy9wby1jaGFydC10eXBlLmVudW0nO1xyXG5pbXBvcnQgeyBQb0NoYXJ0Q29udGFpbmVyU2l6ZSB9IGZyb20gJy4vaW50ZXJmYWNlcy9wby1jaGFydC1jb250YWluZXItc2l6ZS5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBQb0NvbG9yU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BvLWNvbG9yL3BvLWNvbG9yLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBQb0NoYXJ0TWF0aHNTZXJ2aWNlIH0gZnJvbSAnLi9zZXJ2aWNlcy9wby1jaGFydC1tYXRocy5zZXJ2aWNlJztcclxuXHJcbi8qKlxyXG4gKiBAZG9jc0V4dGVuZHMgUG9DaGFydEJhc2VDb21wb25lbnRcclxuICpcclxuICogQGV4YW1wbGVcclxuICpcclxuICogPGV4YW1wbGUgbmFtZT1cInBvLWNoYXJ0LWJhc2ljXCIgdGl0bGU9XCJQTyBDaGFydCBCYXNpY1wiPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1jaGFydC1iYXNpYy9zYW1wbGUtcG8tY2hhcnQtYmFzaWMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1jaGFydC1iYXNpYy9zYW1wbGUtcG8tY2hhcnQtYmFzaWMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cclxuICogPC9leGFtcGxlPlxyXG4gKlxyXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tY2hhcnQtbGFic1wiIHRpdGxlPVwiUE8gQ2hhcnQgTGFic1wiPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1jaGFydC1sYWJzL3NhbXBsZS1wby1jaGFydC1sYWJzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cclxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tY2hhcnQtbGFicy9zYW1wbGUtcG8tY2hhcnQtbGFicy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxyXG4gKiA8L2V4YW1wbGU+XHJcbiAqXHJcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1jaGFydC1jb2ZmZWUtcmFua2luZ1wiIHRpdGxlPVwiUE8gQ2hhcnQgLSBDb2ZmZWUgUmFua2luZ1wiPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1jaGFydC1jb2ZmZWUtcmFua2luZy9zYW1wbGUtcG8tY2hhcnQtY29mZmVlLXJhbmtpbmcuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1jaGFydC1jb2ZmZWUtcmFua2luZy9zYW1wbGUtcG8tY2hhcnQtY29mZmVlLXJhbmtpbmcuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cclxuICogPC9leGFtcGxlPlxyXG4gKi9cclxuQENvbXBvbmVudCh7XHJcbiAgc2VsZWN0b3I6ICdwby1jaGFydCcsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLWNoYXJ0LmNvbXBvbmVudC5odG1sJ1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUG9DaGFydENvbXBvbmVudCBleHRlbmRzIFBvQ2hhcnRCYXNlQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJWaWV3SW5pdCwgRG9DaGVjaywgT25EZXN0cm95LCBPbkluaXQge1xyXG4gIEBWaWV3Q2hpbGQoJ2NoYXJ0Q29udGFpbmVyJywgeyByZWFkOiBWaWV3Q29udGFpbmVyUmVmLCBzdGF0aWM6IHRydWUgfSkgY2hhcnRDb250YWluZXI6IFZpZXdDb250YWluZXJSZWY7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ2NoYXJ0SGVhZGVyJywgeyBzdGF0aWM6IHRydWUgfSkgY2hhcnRIZWFkZXI6IEVsZW1lbnRSZWY7XHJcblxyXG4gIEBWaWV3Q2hpbGQoJ2NoYXJ0TGVnZW5kJywgeyByZWFkOiBFbGVtZW50UmVmIH0pIGNoYXJ0TGVnZW5kOiBFbGVtZW50UmVmO1xyXG5cclxuICBAVmlld0NoaWxkKCdjaGFydFdyYXBwZXInLCB7IHN0YXRpYzogdHJ1ZSB9KSBjaGFydFdyYXBwZXI6IEVsZW1lbnRSZWY7XHJcblxyXG4gIHByaXZhdGUgY2FsY3VsYXRlZENvbXBvbmVudFJlZkVsZW1lbnQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICBwcml2YXRlIGNhbGN1bGF0ZWRTdmdDb250YWluZXJFbGVtZW50OiBib29sZWFuID0gZmFsc2U7XHJcbiAgcHJpdmF0ZSBjb21wb25lbnRSZWY6IENvbXBvbmVudFJlZjx7fT47XHJcbiAgcHJpdmF0ZSBpbml0aWFsaXplZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIHByaXZhdGUgd2luZG93UmVzaXplTGlzdGVuZXI6IFN1YmplY3Q8YW55PiA9IG5ldyBTdWJqZWN0KCk7XHJcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XHJcblxyXG4gIHByaXZhdGUgbWFwcGluZ3MgPSB7XHJcbiAgICBbUG9DaGFydFR5cGUuR2F1Z2VdOiBQb0NoYXJ0R2F1Z2VDb21wb25lbnRcclxuICB9O1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIHByb3RlY3RlZCBjb2xvclNlcnZpY2U6IFBvQ29sb3JTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBjaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICBwcml2YXRlIGNvbnRhaW5lclNlcnZpY2U6IFBvQ2hhcnRTdmdDb250YWluZXJTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSBjb21wb25lbnRGYWN0b3J5UmVzb2x2ZXI6IENvbXBvbmVudEZhY3RvcnlSZXNvbHZlcixcclxuICAgIHByaXZhdGUgZWxlbWVudFJlZjogRWxlbWVudFJlZixcclxuICAgIHByaXZhdGUgbWF0aHNTZXJ2aWNlOiBQb0NoYXJ0TWF0aHNTZXJ2aWNlLFxyXG4gICAgcHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyXHJcbiAgKSB7XHJcbiAgICBzdXBlcihjb2xvclNlcnZpY2UpO1xyXG4gIH1cclxuXHJcbiAgZ2V0IGlzQ2hhcnRHYXVnZVR5cGUoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdGhpcy50eXBlID09PSBQb0NoYXJ0VHlwZS5HYXVnZTtcclxuICB9XHJcblxyXG4gIEBIb3N0TGlzdGVuZXIoJ3dpbmRvdzpyZXNpemUnKVxyXG4gIG9uUmVzaXplID0gKCkgPT4ge1xyXG4gICAgdGhpcy5nZXRTdmdDb250YWluZXJTaXplKCk7XHJcbiAgICB0aGlzLndpbmRvd1Jlc2l6ZUxpc3RlbmVyLm5leHQoKTtcclxuICB9O1xyXG5cclxuICBuZ0FmdGVyVmlld0luaXQoKSB7XHJcbiAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcclxuICAgIHRoaXMuZ2V0U3ZnQ29udGFpbmVyU2l6ZSgpO1xyXG4gIH1cclxuXHJcbiAgbmdEb0NoZWNrKCkge1xyXG4gICAgY29uc3QgY2hhcldyYXBwZXJXaWR0aCA9IHRoaXMuY2hhcnRXcmFwcGVyLm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGg7XHJcbiAgICBjb25zdCBpc0R5bmFtaWNDaGFydCA9IHRoaXMuZ2V0Q29tcG9uZW50VHlwZSh0aGlzLnR5cGUpO1xyXG5cclxuICAgIC8vIFBlcm1pdGUgcXVlIG8gY2hhcnQgc2VqYSBjYWxjdWxhZG8gbmEgcHJpbWVpcmEgdmV6IHF1ZSBvIGNvbXBvbmVudGUgdG9ybmEtc2Ugdmlzw612ZWwsXHJcbiAgICAvLyBldml0YW5kbyBjb20gaXNzbywgcHJvYmxlbWFzIGNvbSBUYWJzIG91IERpdnMgcXVlIGluaWNpZW0gZXNjb25kaWRhcy5cclxuICAgIC8vIFF1YW5kbyBtb2RpZmljYWRhIGEgZXN0cnV0dXJhIGRvcyBncsOhZmljb3MgZG8gdGlwbyBjaXJjdWxhciBpc3RvIHNlcsOhIG1lbGhvcmFkby5cclxuICAgIGlmIChjaGFyV3JhcHBlcldpZHRoICYmIHRoaXMuaW5pdGlhbGl6ZWQpIHtcclxuICAgICAgaWYgKCFpc0R5bmFtaWNDaGFydCAmJiAhdGhpcy5jYWxjdWxhdGVkU3ZnQ29udGFpbmVyRWxlbWVudCkge1xyXG4gICAgICAgIHRoaXMuZ2V0U3ZnQ29udGFpbmVyU2l6ZSgpO1xyXG4gICAgICAgIHRoaXMuY2FsY3VsYXRlZFN2Z0NvbnRhaW5lckVsZW1lbnQgPSB0cnVlO1xyXG4gICAgICB9IGVsc2UgaWYgKGlzRHluYW1pY0NoYXJ0ICYmICF0aGlzLmNhbGN1bGF0ZWRDb21wb25lbnRSZWZFbGVtZW50KSB7XHJcbiAgICAgICAgdGhpcy5keW5hbWljQ29tcG9uZW50U2V0dGluZygpO1xyXG4gICAgICAgIHRoaXMuY2FsY3VsYXRlZENvbXBvbmVudFJlZkVsZW1lbnQgPSB0cnVlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBuZ09uRGVzdHJveSgpIHtcclxuICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICB0aGlzLnJlbW92ZVdpbmRvd1Jlc2l6ZUxpc3RlbmVyKCk7XHJcbiAgfVxyXG5cclxuICByZXNpemVBY3Rpb24oKSB7XHJcbiAgICB0aGlzLmdldFN2Z0NvbnRhaW5lclNpemUoKTtcclxuICAgIHRoaXMud2luZG93UmVzaXplTGlzdGVuZXIubmV4dCgpO1xyXG4gICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgfVxyXG5cclxuICBuZ09uSW5pdCgpIHtcclxuICAgIHRoaXMuZ2V0U3ZnQ29udGFpbmVyU2l6ZSgpO1xyXG4gIH1cclxuXHJcbiAgcmVidWlsZENvbXBvbmVudFJlZigpIHtcclxuICAgIGlmICh0aGlzLmNvbXBvbmVudFJlZikge1xyXG4gICAgICB0aGlzLmNvbXBvbmVudFJlZi5kZXN0cm95KCk7XHJcblxyXG4gICAgICBpZiAodGhpcy5pc0NoYXJ0R2F1Z2VUeXBlKSB7XHJcbiAgICAgICAgdGhpcy5keW5hbWljQ29tcG9uZW50U2V0dGluZygpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgY2FsY3VsYXRlQXhpc1hMYWJlbEFyZWEoKSB7XHJcbiAgICBjb25zdCBheGlzWExhYmVscyA9IHRoaXMuY2hhcnRUeXBlID09PSBQb0NoYXJ0VHlwZS5CYXIgPyB0aGlzLmNhdGVnb3JpZXMgOiB0aGlzLmNoYXJ0U2VyaWVzO1xyXG5cclxuICAgIHJldHVybiB0aGlzLmdldEF4aXNYTGFiZWxBcmVhKHRoaXMubWF0aHNTZXJ2aWNlLmdldExvbmdlc3REYXRhVmFsdWUoYXhpc1hMYWJlbHMsIHRoaXMuY2hhcnRUeXBlLCB0aGlzLm9wdGlvbnMpKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBnZXRTdmdDb250YWluZXJTaXplKCkge1xyXG4gICAgbGV0IGF4aXNYTGFiZWxXaWR0aDtcclxuICAgIGNvbnN0IHsgY2hhcnRIZWFkZXJIZWlnaHQsIGNoYXJ0TGVnZW5kSGVpZ2h0LCBjaGFydFdyYXBwZXJXaWR0aCB9ID0gdGhpcy5nZXRDaGFydE1lYXN1cmVtZW50cygpO1xyXG5cclxuICAgIGlmICghdGhpcy5pc1R5cGVDaXJjdWxhcikge1xyXG4gICAgICBheGlzWExhYmVsV2lkdGggPSB0aGlzLmNhbGN1bGF0ZUF4aXNYTGFiZWxBcmVhKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5zdmdDb250YWluZXJTaXplID0ge1xyXG4gICAgICAuLi50aGlzLmNvbnRhaW5lclNlcnZpY2UuY2FsY3VsYXRlU1ZHQ29udGFpbmVyTWVhc3VyZW1lbnRzKFxyXG4gICAgICAgIHRoaXMuaGVpZ2h0LFxyXG4gICAgICAgIGNoYXJ0V3JhcHBlcldpZHRoLFxyXG4gICAgICAgIGNoYXJ0SGVhZGVySGVpZ2h0LFxyXG4gICAgICAgIGNoYXJ0TGVnZW5kSGVpZ2h0XHJcbiAgICAgICksXHJcbiAgICAgIGF4aXNYTGFiZWxXaWR0aFxyXG4gICAgfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2hhcnRMZWdlbmRIZWlnaHQoY2hhcnRMZWdlbmQ6IEVsZW1lbnRSZWYpIHtcclxuICAgIHJldHVybiBjaGFydExlZ2VuZCA/IGNoYXJ0TGVnZW5kLm5hdGl2ZUVsZW1lbnQub2Zmc2V0SGVpZ2h0IDogMDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlQ29tcG9uZW50KCkge1xyXG4gICAgY29uc3QgY29tcG9uZW50VHlwZSA9IHRoaXMuZ2V0Q29tcG9uZW50VHlwZSh0aGlzLnR5cGUpO1xyXG4gICAgY29uc3QgZmFjdG9yeSA9IHRoaXMuY29tcG9uZW50RmFjdG9yeVJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KGNvbXBvbmVudFR5cGUpO1xyXG5cclxuICAgIHRoaXMuY29tcG9uZW50UmVmID0gdGhpcy5jaGFydENvbnRhaW5lci5jcmVhdGVDb21wb25lbnQoZmFjdG9yeSk7XHJcblxyXG4gICAgY29uc3QgaW5zdGFuY2UgPSA8UG9DaGFydER5bmFtaWNUeXBlQ29tcG9uZW50PnRoaXMuY29tcG9uZW50UmVmLmluc3RhbmNlO1xyXG5cclxuICAgIHRoaXMuc2V0Q29tcG9uZW50UmVmUHJvcGVydGllcyhpbnN0YW5jZSk7XHJcblxyXG4gICAgcmV0dXJuIGluc3RhbmNlO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBkeW5hbWljQ29tcG9uZW50U2V0dGluZygpIHtcclxuICAgIGNvbnN0IGluc3RhbmNlID0gdGhpcy5jcmVhdGVDb21wb25lbnQoKTtcclxuXHJcbiAgICB0aGlzLnNldFJlc2l6ZUxpc3RlbmVyU3Vic2NyaWJlKGluc3RhbmNlKTtcclxuICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xyXG4gICAgdGhpcy5zZXRDbGlja1N1YnNjcmliZShpbnN0YW5jZSk7XHJcbiAgICB0aGlzLnNldEhvdmVyU3Vic2NyaWJlKGluc3RhbmNlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0QXhpc1hMYWJlbEFyZWEoYXhpc1hMYWJlbDogYW55KSB7XHJcbiAgICBjb25zdCBsYWJlbFBvQ2hhcnRQYWRkaW5nID0gUG9DaGFydFBhZGRpbmcgLyAzO1xyXG4gICAgY29uc3Qgc3BhbkVsZW1lbnQgPSB0aGlzLnJlbmRlcmVyLmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuXHJcbiAgICB0aGlzLnJlbmRlcmVyLmFkZENsYXNzKHNwYW5FbGVtZW50LCAncG8tY2hhcnQtYXhpcy14LWxhYmVsJyk7XHJcbiAgICBzcGFuRWxlbWVudC5pbm5lckhUTUwgPSBheGlzWExhYmVsO1xyXG5cclxuICAgIHRoaXMucmVuZGVyZXIuYXBwZW5kQ2hpbGQodGhpcy5lbGVtZW50UmVmLm5hdGl2ZUVsZW1lbnQsIHNwYW5FbGVtZW50KTtcclxuICAgIGNvbnN0IGF4aXNYTGFiZWxXaWR0aCA9IE1hdGguY2VpbChzcGFuRWxlbWVudC5vZmZzZXRXaWR0aCkgKyBsYWJlbFBvQ2hhcnRQYWRkaW5nO1xyXG4gICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDaGlsZCh0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCwgc3BhbkVsZW1lbnQpO1xyXG5cclxuICAgIHJldHVybiBheGlzWExhYmVsV2lkdGggPiBQb0NoYXJ0QXhpc1hMYWJlbEFyZWEgPyBheGlzWExhYmVsV2lkdGggOiBQb0NoYXJ0QXhpc1hMYWJlbEFyZWE7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldENvbXBvbmVudFR5cGUodHlwZU5hbWUpIHtcclxuICAgIHJldHVybiB0aGlzLm1hcHBpbmdzW3R5cGVOYW1lXTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0Q2hhcnRNZWFzdXJlbWVudHMoKSB7XHJcbiAgICBjb25zdCBjaGFydFdyYXBwZXJXaWR0aCA9IHRoaXMuY2hhcnRXcmFwcGVyLm5hdGl2ZUVsZW1lbnQub2Zmc2V0V2lkdGg7XHJcbiAgICBjb25zdCBjaGFydEhlYWRlckhlaWdodCA9IHRoaXMuY2hhcnRIZWFkZXIubmF0aXZlRWxlbWVudC5vZmZzZXRIZWlnaHQ7XHJcbiAgICBjb25zdCBjaGFydExlZ2VuZEhlaWdodCA9IHRoaXMuY2hhcnRMZWdlbmRIZWlnaHQodGhpcy5jaGFydExlZ2VuZCk7XHJcblxyXG4gICAgcmV0dXJuIHsgY2hhcnRXcmFwcGVyV2lkdGgsIGNoYXJ0SGVhZGVySGVpZ2h0LCBjaGFydExlZ2VuZEhlaWdodCB9O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSByZW1vdmVXaW5kb3dSZXNpemVMaXN0ZW5lcigpIHtcclxuICAgIGlmICh0aGlzLm9uUmVzaXplKSB7XHJcbiAgICAgIHRoaXMub25SZXNpemUgPSAoKSA9PiB7fTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0Q29tcG9uZW50UmVmUHJvcGVydGllcyhpbnN0YW5jZTogUG9DaGFydER5bmFtaWNUeXBlQ29tcG9uZW50KSB7XHJcbiAgICBjb25zdCB7IGNoYXJ0SGVhZGVySGVpZ2h0LCBjaGFydExlZ2VuZEhlaWdodCwgY2hhcnRXcmFwcGVyV2lkdGggfSA9IHRoaXMuZ2V0Q2hhcnRNZWFzdXJlbWVudHMoKTtcclxuXHJcbiAgICBpbnN0YW5jZS5jaGFydEhlYWRlciA9IGNoYXJ0SGVhZGVySGVpZ2h0O1xyXG4gICAgaW5zdGFuY2UuY2hhcnRMZWdlbmQgPSBjaGFydExlZ2VuZEhlaWdodDtcclxuICAgIGluc3RhbmNlLmNoYXJ0V3JhcHBlciA9IGNoYXJ0V3JhcHBlcldpZHRoO1xyXG4gICAgaW5zdGFuY2UuY29sb3JzID0gUG9EZWZhdWx0Q29sb3JzWzBdO1xyXG4gICAgaW5zdGFuY2UuaGVpZ2h0ID0gdGhpcy5oZWlnaHQ7XHJcbiAgICBpbnN0YW5jZS50eXBlID0gdGhpcy50eXBlO1xyXG4gICAgaW5zdGFuY2Uuc2VyaWVzID0gdGhpcy5jaGFydFNlcmllcyB8fCBbXTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0Q2xpY2tTdWJzY3JpYmUoaW5zdGFuY2U6IFBvQ2hhcnREeW5hbWljVHlwZUNvbXBvbmVudCkge1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKFxyXG4gICAgICBpbnN0YW5jZS5vblNlcmllQ2xpY2suc3Vic2NyaWJlKGV2ZW50ID0+IHtcclxuICAgICAgICB0aGlzLm9uU2VyaWVzQ2xpY2soZXZlbnQpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0SG92ZXJTdWJzY3JpYmUoaW5zdGFuY2U6IFBvQ2hhcnREeW5hbWljVHlwZUNvbXBvbmVudCkge1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKFxyXG4gICAgICBpbnN0YW5jZS5vblNlcmllSG92ZXIuc3Vic2NyaWJlKGV2ZW50ID0+IHtcclxuICAgICAgICB0aGlzLm9uU2VyaWVzSG92ZXIoZXZlbnQpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2V0UmVzaXplTGlzdGVuZXJTdWJzY3JpYmUoaW5zdGFuY2U6IFBvQ2hhcnREeW5hbWljVHlwZUNvbXBvbmVudCkge1xyXG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKFxyXG4gICAgICB0aGlzLndpbmRvd1Jlc2l6ZUxpc3RlbmVyLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgICAgY29uc3QgbWVhc3VyZXNGb3JDb21wb25lbnRSZWYgPSB0aGlzLmdldENoYXJ0TWVhc3VyZW1lbnRzKCk7XHJcblxyXG4gICAgICAgIGluc3RhbmNlLmNoYXJ0V3JhcHBlciA9IG1lYXN1cmVzRm9yQ29tcG9uZW50UmVmLmNoYXJ0V3JhcHBlcldpZHRoO1xyXG4gICAgICAgIGluc3RhbmNlLmNoYXJ0SGVhZGVyID0gbWVhc3VyZXNGb3JDb21wb25lbnRSZWYuY2hhcnRIZWFkZXJIZWlnaHQ7XHJcbiAgICAgICAgaW5zdGFuY2UuY2hhcnRMZWdlbmQgPSBtZWFzdXJlc0ZvckNvbXBvbmVudFJlZi5jaGFydExlZ2VuZEhlaWdodDtcclxuICAgICAgfSlcclxuICAgICk7XHJcbiAgfVxyXG59XHJcbiJdfQ==
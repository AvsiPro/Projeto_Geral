import { ChangeDetectorRef, Component, ContentChildren } from '@angular/core';
import { Observable, of, throwError } from 'rxjs';
import { take, tap, catchError } from 'rxjs/operators';
import { PoStepperStatus } from './enums/po-stepper-status.enum';
import { PoStepComponent } from './po-step/po-step.component';
import { PoStepperBaseComponent } from './po-stepper-base.component';
/**
 * @docsExtends PoStepperBaseComponent
 *
 * @example
 *
 * <example name="po-stepper-basic" title="PO Stepper Basic">
 *  <file name="sample-po-stepper-basic/sample-po-stepper-basic.component.html"> </file>
 *  <file name="sample-po-stepper-basic/sample-po-stepper-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-stepper-labs" title="PO Stepper Labs">
 *  <file name="sample-po-stepper-labs/sample-po-stepper-labs.component.html"> </file>
 *  <file name="sample-po-stepper-labs/sample-po-stepper-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-stepper-sales" title="PO Stepper - Sales">
 *  <file name="sample-po-stepper-sales/sample-po-stepper-sales.component.html"> </file>
 *  <file name="sample-po-stepper-sales/sample-po-stepper-sales.component.ts"> </file>
 * </example>
 *
 * <example name="po-stepper-active" title="PO Stepper - Active">
 *  <file name="sample-po-stepper-active/sample-po-stepper-active.component.html"> </file>
 *  <file name="sample-po-stepper-active/sample-po-stepper-active.component.ts"> </file>
 *  <file name="sample-po-stepper-active/sample-po-stepper-active.service.ts"> </file>
 * </example>
 */
export class PoStepperComponent extends PoStepperBaseComponent {
    constructor(changeDetector) {
        super();
        this.changeDetector = changeDetector;
    }
    get currentStepIndex() {
        return this.step - 1;
    }
    get stepList() {
        return (this.usePoSteps && this.poSteps) || this.steps;
    }
    get usePoSteps() {
        return !!this.poSteps.length;
    }
    ngAfterContentInit() {
        this.activeFirstStep();
        this.poSteps.changes.subscribe(() => {
            this.controlStepsStatus(0, this.poSteps.first);
        });
    }
    /**
     * Altera o status do *step* para ativo.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     *
     * @param {number} index Índice do `po-step` que se deseja ativar.
     */
    active(index) {
        if (!this.usePoSteps) {
            return;
        }
        const stepsArray = this.getPoSteps();
        const step = stepsArray[index];
        this.changeStep(index, step);
    }
    /**
     * Ativa o primeiro *step*.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    first() {
        if (!this.usePoSteps) {
            return;
        }
        const firstStep = this.poSteps.first;
        const firstStepIndex = 0;
        this.changeStep(firstStepIndex, firstStep);
    }
    /**
     * Ativa o próximo *step*.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    next() {
        if (!this.usePoSteps) {
            return;
        }
        const { steps, stepIndex } = this.getStepsAndIndex(this.currentActiveStep);
        const nextIndex = stepIndex + 1;
        const nextStep = steps[nextIndex];
        this.changeStep(nextIndex, nextStep);
    }
    /**
     * Ativa o *step* anterior.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    previous() {
        if (!this.usePoSteps) {
            return;
        }
        const { steps, stepIndex } = this.getStepsAndIndex(this.currentActiveStep);
        const previousIndex = stepIndex - 1;
        const previousStep = steps[previousIndex];
        this.changeStep(previousIndex, previousStep);
    }
    changeStep(stepIndex, step) {
        this.allowNextStep(stepIndex)
            .pipe(take(1))
            .subscribe(nextStepAllowed => {
            if (nextStepAllowed) {
                const isDifferentStep = !this.currentActiveStep || step.id !== this.currentActiveStep.id;
                if (this.usePoSteps && isDifferentStep) {
                    this.controlStepsStatus(stepIndex, step);
                    this.onChangeStep.emit(step);
                }
                else if (!this.usePoSteps && stepIndex !== this.currentStepIndex) {
                    // if para tratamento do modelo antigo do po-stepper
                    this.onChangeStep.emit(stepIndex + 1);
                }
            }
        });
    }
    onStepActive(step) {
        this.currentActiveStep = step;
        const { stepIndex } = this.getStepsAndIndex(this.currentActiveStep);
        this.poSteps.forEach((stepChild, i) => {
            if (i < stepIndex) {
                stepChild.status = PoStepperStatus.Done;
            }
        });
    }
    trackByFn(step) {
        return step.id;
    }
    activeFirstStep() {
        const hasStepActive = this.poSteps.some(poStep => poStep.status === PoStepperStatus.Active);
        if (this.usePoSteps && !hasStepActive) {
            this.changeStep(0, this.poSteps.first);
        }
    }
    allowNextStep(nextStepIndex) {
        if (!this.sequential) {
            return of(true);
        }
        const isAllowNextStep$ = this.usePoSteps
            ? this.isBeforeStep(nextStepIndex) || this.canActiveNextStep(this.currentActiveStep)
            : this.steps.slice(this.step, nextStepIndex).every(step => step.status === PoStepperStatus.Done);
        return typeof isAllowNextStep$ === 'boolean' ? of(isAllowNextStep$) : isAllowNextStep$;
    }
    canActiveNextStep(currentActiveStep = {}) {
        if (!currentActiveStep.canActiveNextStep) {
            return of(true);
        }
        const canActiveNextStep = currentActiveStep.canActiveNextStep(currentActiveStep);
        const canActiveNextStep$ = canActiveNextStep instanceof Observable ? canActiveNextStep : of(canActiveNextStep);
        return canActiveNextStep$.pipe(tap(isCanActiveNextStep => {
            currentActiveStep.status = this.getStepperStatusByCanActive(isCanActiveNextStep);
        }), catchError(err => {
            currentActiveStep.status = PoStepperStatus.Error;
            return throwError(err);
        }));
    }
    controlStepsStatus(stepIndex, step) {
        if (this.usePoSteps) {
            this.setStepAsActive(step);
            this.setNextStepAsDefault(step);
            if (this.isBeforeStep(stepIndex)) {
                this.setFinalSteppersAsDisabled(stepIndex);
            }
            this.changeDetector.detectChanges();
        }
    }
    getStepperStatusByCanActive(canActiveNextStep) {
        return canActiveNextStep ? PoStepperStatus.Done : PoStepperStatus.Error;
    }
    getStepsAndIndex(step = {}) {
        const steps = this.getPoSteps();
        const stepIndex = steps.findIndex(poStep => poStep.id === step.id);
        return { steps, stepIndex };
    }
    getPoSteps() {
        return this.poSteps.toArray();
    }
    isBeforeStep(stepIndex) {
        const currentActiveStepIndex = () => this.getPoSteps().findIndex(step => step.id === this.currentActiveStep.id);
        return !!this.currentActiveStep && currentActiveStepIndex() >= stepIndex;
    }
    setFinalSteppersAsDisabled(stepIndex) {
        this.getPoSteps()
            .filter((step, index) => step && index >= stepIndex + 2)
            .forEach(step => (step.status = PoStepperStatus.Disabled));
    }
    setStepAsActive(step) {
        step.status = PoStepperStatus.Active;
    }
    setNextStepAsDefault(currentStep) {
        const { steps, stepIndex } = this.getStepsAndIndex(currentStep);
        const nextIndex = stepIndex + 1;
        if (nextIndex < this.poSteps.length) {
            steps[nextIndex].status = PoStepperStatus.Default;
        }
    }
}
PoStepperComponent.decorators = [
    { type: Component, args: [{
                selector: 'po-stepper',
                template: "<div class=\"po-stepper po-stepper-{{ orientation }}\">\r\n  <div class=\"po-stepper-container\">\r\n    <po-stepper-step\r\n      *ngFor=\"let step of stepList; let index = index; trackBy: trackByFn\"\r\n      class=\"po-stepper-step-position\"\r\n      [p-circle-content]=\"index + 1\"\r\n      [p-label]=\"step.label\"\r\n      [p-orientation]=\"orientation\"\r\n      [p-status]=\"step.status\"\r\n      [p-step-icons]=\"stepIcons\"\r\n      [p-step-size]=\"stepSize\"\r\n      [p-next-status]=\"poSteps.get(index + 1)?.status\"\r\n      (p-activated)=\"onStepActive(step)\"\r\n      (p-click)=\"changeStep(index, step)\"\r\n      (p-enter)=\"changeStep(index, step)\"\r\n    >\r\n    </po-stepper-step>\r\n  </div>\r\n\r\n  <div *ngIf=\"usePoSteps\" class=\"po-stepper-content\">\r\n    <ng-content></ng-content>\r\n  </div>\r\n</div>\r\n"
            },] }
];
PoStepperComponent.ctorParameters = () => [
    { type: ChangeDetectorRef }
];
PoStepperComponent.propDecorators = {
    poSteps: [{ type: ContentChildren, args: [PoStepComponent,] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tc3RlcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy91aS9zcmMvbGliL2NvbXBvbmVudHMvcG8tc3RlcHBlci9wby1zdGVwcGVyLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQW9CLGlCQUFpQixFQUFFLFNBQVMsRUFBRSxlQUFlLEVBQWEsTUFBTSxlQUFlLENBQUM7QUFFM0csT0FBTyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsVUFBVSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2xELE9BQU8sRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLFVBQVUsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXZELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNqRSxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDOUQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFHckU7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0F5Qkc7QUFLSCxNQUFNLE9BQU8sa0JBQW1CLFNBQVEsc0JBQXNCO0lBaUI1RCxZQUFvQixjQUFpQztRQUNuRCxLQUFLLEVBQUUsQ0FBQztRQURVLG1CQUFjLEdBQWQsY0FBYyxDQUFtQjtJQUVyRCxDQUFDO0lBZEQsSUFBSSxnQkFBZ0I7UUFDbEIsT0FBTyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztJQUN2QixDQUFDO0lBRUQsSUFBSSxRQUFRO1FBQ1YsT0FBTyxDQUFDLElBQUksQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUM7SUFDekQsQ0FBQztJQUVELElBQUksVUFBVTtRQUNaLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO0lBQy9CLENBQUM7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QUMsSUFBSSxDQUFDLGlCQUFpQixJQUFJLHNCQUFzQixFQUFFLElBQUksU0FBUyxDQUFDO0lBQzNFLENBQUM7SUFFTywwQkFBMEIsQ0FBQyxTQUFpQjtRQUNsRCxJQUFJLENBQUMsVUFBVSxFQUFFO2FBQ2QsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsSUFBSSxJQUFJLEtBQUssSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZELE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUMvRCxDQUFDO0lBRU8sZUFBZSxDQUFDLElBQXFCO1FBQzNDLElBQUksQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDLE1BQU0sQ0FBQztJQUN2QyxDQUFDO0lBRU8sb0JBQW9CLENBQUMsV0FBNEI7UUFDdkQsTUFBTSxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsV0FBVyxDQUFDLENBQUM7UUFDaEUsTUFBTSxTQUFTLEdBQUcsU0FBUyxHQUFHLENBQUMsQ0FBQztRQUVoQyxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRTtZQUNuQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxHQUFHLGVBQWUsQ0FBQyxPQUFPLENBQUM7U0FDbkQ7SUFDSCxDQUFDOzs7WUFsT0YsU0FBUyxTQUFDO2dCQUNULFFBQVEsRUFBRSxZQUFZO2dCQUN0Qix1MUJBQTBDO2FBQzNDOzs7WUF2QzBCLGlCQUFpQjs7O3NCQXlDekMsZUFBZSxTQUFDLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBZnRlckNvbnRlbnRJbml0LCBDaGFuZ2VEZXRlY3RvclJlZiwgQ29tcG9uZW50LCBDb250ZW50Q2hpbGRyZW4sIFF1ZXJ5TGlzdCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIHRocm93RXJyb3IgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgdGFrZSwgdGFwLCBjYXRjaEVycm9yIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgUG9TdGVwcGVyU3RhdHVzIH0gZnJvbSAnLi9lbnVtcy9wby1zdGVwcGVyLXN0YXR1cy5lbnVtJztcclxuaW1wb3J0IHsgUG9TdGVwQ29tcG9uZW50IH0gZnJvbSAnLi9wby1zdGVwL3BvLXN0ZXAuY29tcG9uZW50JztcclxuaW1wb3J0IHsgUG9TdGVwcGVyQmFzZUNvbXBvbmVudCB9IGZyb20gJy4vcG8tc3RlcHBlci1iYXNlLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IFBvU3RlcHBlckl0ZW0gfSBmcm9tICcuL3BvLXN0ZXBwZXItaXRlbS5pbnRlcmZhY2UnO1xyXG5cclxuLyoqXHJcbiAqIEBkb2NzRXh0ZW5kcyBQb1N0ZXBwZXJCYXNlQ29tcG9uZW50XHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqXHJcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1zdGVwcGVyLWJhc2ljXCIgdGl0bGU9XCJQTyBTdGVwcGVyIEJhc2ljXCI+XHJcbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItYmFzaWMvc2FtcGxlLXBvLXN0ZXBwZXItYmFzaWMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zdGVwcGVyLWJhc2ljL3NhbXBsZS1wby1zdGVwcGVyLWJhc2ljLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XHJcbiAqIDwvZXhhbXBsZT5cclxuICpcclxuICogPGV4YW1wbGUgbmFtZT1cInBvLXN0ZXBwZXItbGFic1wiIHRpdGxlPVwiUE8gU3RlcHBlciBMYWJzXCI+XHJcbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItbGFicy9zYW1wbGUtcG8tc3RlcHBlci1sYWJzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cclxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc3RlcHBlci1sYWJzL3NhbXBsZS1wby1zdGVwcGVyLWxhYnMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cclxuICogPC9leGFtcGxlPlxyXG4gKlxyXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tc3RlcHBlci1zYWxlc1wiIHRpdGxlPVwiUE8gU3RlcHBlciAtIFNhbGVzXCI+XHJcbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItc2FsZXMvc2FtcGxlLXBvLXN0ZXBwZXItc2FsZXMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zdGVwcGVyLXNhbGVzL3NhbXBsZS1wby1zdGVwcGVyLXNhbGVzLmNvbXBvbmVudC50c1wiPiA8L2ZpbGU+XHJcbiAqIDwvZXhhbXBsZT5cclxuICpcclxuICogPGV4YW1wbGUgbmFtZT1cInBvLXN0ZXBwZXItYWN0aXZlXCIgdGl0bGU9XCJQTyBTdGVwcGVyIC0gQWN0aXZlXCI+XHJcbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItYWN0aXZlL3NhbXBsZS1wby1zdGVwcGVyLWFjdGl2ZS5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XHJcbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItYWN0aXZlL3NhbXBsZS1wby1zdGVwcGVyLWFjdGl2ZS5jb21wb25lbnQudHNcIj4gPC9maWxlPlxyXG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zdGVwcGVyLWFjdGl2ZS9zYW1wbGUtcG8tc3RlcHBlci1hY3RpdmUuc2VydmljZS50c1wiPiA8L2ZpbGU+XHJcbiAqIDwvZXhhbXBsZT5cclxuICovXHJcbkBDb21wb25lbnQoe1xyXG4gIHNlbGVjdG9yOiAncG8tc3RlcHBlcicsXHJcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLXN0ZXBwZXIuY29tcG9uZW50Lmh0bWwnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBQb1N0ZXBwZXJDb21wb25lbnQgZXh0ZW5kcyBQb1N0ZXBwZXJCYXNlQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCB7XHJcbiAgQENvbnRlbnRDaGlsZHJlbihQb1N0ZXBDb21wb25lbnQpIHBvU3RlcHM6IFF1ZXJ5TGlzdDxQb1N0ZXBDb21wb25lbnQ+O1xyXG5cclxuICBwcml2YXRlIGN1cnJlbnRBY3RpdmVTdGVwOiBQb1N0ZXBDb21wb25lbnQ7XHJcblxyXG4gIGdldCBjdXJyZW50U3RlcEluZGV4KCk6IG51bWJlciB7XHJcbiAgICByZXR1cm4gdGhpcy5zdGVwIC0gMTtcclxuICB9XHJcblxyXG4gIGdldCBzdGVwTGlzdCgpOiBRdWVyeUxpc3Q8UG9TdGVwQ29tcG9uZW50PiB8IEFycmF5PFBvU3RlcHBlckl0ZW0+IHtcclxuICAgIHJldHVybiAodGhpcy51c2VQb1N0ZXBzICYmIHRoaXMucG9TdGVwcykgfHwgdGhpcy5zdGVwcztcclxuICB9XHJcblxyXG4gIGdldCB1c2VQb1N0ZXBzKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuICEhdGhpcy5wb1N0ZXBzLmxlbmd0aDtcclxuICB9XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gIH1cclxuXHJcbiAgbmdBZnRlckNvbnRlbnRJbml0KCkge1xyXG4gICAgdGhpcy5hY3RpdmVGaXJzdFN0ZXAoKTtcclxuXHJcbiAgICB0aGlzLnBvU3RlcHMuY2hhbmdlcy5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLmNvbnRyb2xTdGVwc1N0YXR1cygwLCB0aGlzLnBvU3RlcHMuZmlyc3QpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBbHRlcmEgbyBzdGF0dXMgZG8gKnN0ZXAqIHBhcmEgYXRpdm8uXHJcbiAgICpcclxuICAgKiA+IEVzdGUgbcOpdG9kbyDDqSB2YWxpZG8gYXBlbmFzIHBhcmEgYXMgaW1wbGVtZW50YcOnw7VlcyBxdWUgdXRpbGl6YW0gbyBjb21wb25lbnRlIFsqKnBvLXN0ZXAqKl0oL2RvY3VtZW50YXRpb24vcG8tc3RlcCkuXHJcbiAgICpcclxuICAgKiBAcGFyYW0ge251bWJlcn0gaW5kZXggw41uZGljZSBkbyBgcG8tc3RlcGAgcXVlIHNlIGRlc2VqYSBhdGl2YXIuXHJcbiAgICovXHJcbiAgYWN0aXZlKGluZGV4OiBudW1iZXIpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy51c2VQb1N0ZXBzKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdGVwc0FycmF5ID0gdGhpcy5nZXRQb1N0ZXBzKCk7XHJcbiAgICBjb25zdCBzdGVwID0gc3RlcHNBcnJheVtpbmRleF07XHJcbiAgICB0aGlzLmNoYW5nZVN0ZXAoaW5kZXgsIHN0ZXApO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQXRpdmEgbyBwcmltZWlybyAqc3RlcCouXHJcbiAgICpcclxuICAgKiA+IEVzdGUgbcOpdG9kbyDDqSB2YWxpZG8gYXBlbmFzIHBhcmEgYXMgaW1wbGVtZW50YcOnw7VlcyBxdWUgdXRpbGl6YW0gbyBjb21wb25lbnRlIFsqKnBvLXN0ZXAqKl0oL2RvY3VtZW50YXRpb24vcG8tc3RlcCkuXHJcbiAgICovXHJcbiAgZmlyc3QoKTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMudXNlUG9TdGVwcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgZmlyc3RTdGVwID0gdGhpcy5wb1N0ZXBzLmZpcnN0O1xyXG4gICAgY29uc3QgZmlyc3RTdGVwSW5kZXggPSAwO1xyXG5cclxuICAgIHRoaXMuY2hhbmdlU3RlcChmaXJzdFN0ZXBJbmRleCwgZmlyc3RTdGVwKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEF0aXZhIG8gcHLDs3hpbW8gKnN0ZXAqLlxyXG4gICAqXHJcbiAgICogPiBFc3RlIG3DqXRvZG8gw6kgdmFsaWRvIGFwZW5hcyBwYXJhIGFzIGltcGxlbWVudGHDp8O1ZXMgcXVlIHV0aWxpemFtIG8gY29tcG9uZW50ZSBbKipwby1zdGVwKipdKC9kb2N1bWVudGF0aW9uL3BvLXN0ZXApLlxyXG4gICAqL1xyXG4gIG5leHQoKTogdm9pZCB7XHJcbiAgICBpZiAoIXRoaXMudXNlUG9TdGVwcykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgeyBzdGVwcywgc3RlcEluZGV4IH0gPSB0aGlzLmdldFN0ZXBzQW5kSW5kZXgodGhpcy5jdXJyZW50QWN0aXZlU3RlcCk7XHJcbiAgICBjb25zdCBuZXh0SW5kZXggPSBzdGVwSW5kZXggKyAxO1xyXG4gICAgY29uc3QgbmV4dFN0ZXAgPSBzdGVwc1tuZXh0SW5kZXhdO1xyXG5cclxuICAgIHRoaXMuY2hhbmdlU3RlcChuZXh0SW5kZXgsIG5leHRTdGVwKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEF0aXZhIG8gKnN0ZXAqIGFudGVyaW9yLlxyXG4gICAqXHJcbiAgICogPiBFc3RlIG3DqXRvZG8gw6kgdmFsaWRvIGFwZW5hcyBwYXJhIGFzIGltcGxlbWVudGHDp8O1ZXMgcXVlIHV0aWxpemFtIG8gY29tcG9uZW50ZSBbKipwby1zdGVwKipdKC9kb2N1bWVudGF0aW9uL3BvLXN0ZXApLlxyXG4gICAqL1xyXG4gIHByZXZpb3VzKCk6IHZvaWQge1xyXG4gICAgaWYgKCF0aGlzLnVzZVBvU3RlcHMpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHsgc3RlcHMsIHN0ZXBJbmRleCB9ID0gdGhpcy5nZXRTdGVwc0FuZEluZGV4KHRoaXMuY3VycmVudEFjdGl2ZVN0ZXApO1xyXG4gICAgY29uc3QgcHJldmlvdXNJbmRleCA9IHN0ZXBJbmRleCAtIDE7XHJcbiAgICBjb25zdCBwcmV2aW91c1N0ZXAgPSBzdGVwc1twcmV2aW91c0luZGV4XTtcclxuXHJcbiAgICB0aGlzLmNoYW5nZVN0ZXAocHJldmlvdXNJbmRleCwgcHJldmlvdXNTdGVwKTtcclxuICB9XHJcblxyXG4gIGNoYW5nZVN0ZXAoc3RlcEluZGV4OiBudW1iZXIsIHN0ZXA/OiBQb1N0ZXBDb21wb25lbnQpOiB2b2lkIHtcclxuICAgIHRoaXMuYWxsb3dOZXh0U3RlcChzdGVwSW5kZXgpXHJcbiAgICAgIC5waXBlKHRha2UoMSkpXHJcbiAgICAgIC5zdWJzY3JpYmUobmV4dFN0ZXBBbGxvd2VkID0+IHtcclxuICAgICAgICBpZiAobmV4dFN0ZXBBbGxvd2VkKSB7XHJcbiAgICAgICAgICBjb25zdCBpc0RpZmZlcmVudFN0ZXAgPSAhdGhpcy5jdXJyZW50QWN0aXZlU3RlcCB8fCBzdGVwLmlkICE9PSB0aGlzLmN1cnJlbnRBY3RpdmVTdGVwLmlkO1xyXG5cclxuICAgICAgICAgIGlmICh0aGlzLnVzZVBvU3RlcHMgJiYgaXNEaWZmZXJlbnRTdGVwKSB7XHJcbiAgICAgICAgICAgIHRoaXMuY29udHJvbFN0ZXBzU3RhdHVzKHN0ZXBJbmRleCwgc3RlcCk7XHJcbiAgICAgICAgICAgIHRoaXMub25DaGFuZ2VTdGVwLmVtaXQoc3RlcCk7XHJcbiAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLnVzZVBvU3RlcHMgJiYgc3RlcEluZGV4ICE9PSB0aGlzLmN1cnJlbnRTdGVwSW5kZXgpIHtcclxuICAgICAgICAgICAgLy8gaWYgcGFyYSB0cmF0YW1lbnRvIGRvIG1vZGVsbyBhbnRpZ28gZG8gcG8tc3RlcHBlclxyXG4gICAgICAgICAgICB0aGlzLm9uQ2hhbmdlU3RlcC5lbWl0KHN0ZXBJbmRleCArIDEpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICBvblN0ZXBBY3RpdmUoc3RlcDogUG9TdGVwQ29tcG9uZW50KSB7XHJcbiAgICB0aGlzLmN1cnJlbnRBY3RpdmVTdGVwID0gc3RlcDtcclxuXHJcbiAgICBjb25zdCB7IHN0ZXBJbmRleCB9ID0gdGhpcy5nZXRTdGVwc0FuZEluZGV4KHRoaXMuY3VycmVudEFjdGl2ZVN0ZXApO1xyXG5cclxuICAgIHRoaXMucG9TdGVwcy5mb3JFYWNoKChzdGVwQ2hpbGQsIGkpID0+IHtcclxuICAgICAgaWYgKGkgPCBzdGVwSW5kZXgpIHtcclxuICAgICAgICBzdGVwQ2hpbGQuc3RhdHVzID0gUG9TdGVwcGVyU3RhdHVzLkRvbmU7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgdHJhY2tCeUZuKHN0ZXA6IFBvU3RlcENvbXBvbmVudCkge1xyXG4gICAgcmV0dXJuIHN0ZXAuaWQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGFjdGl2ZUZpcnN0U3RlcCgpIHtcclxuICAgIGNvbnN0IGhhc1N0ZXBBY3RpdmUgPSB0aGlzLnBvU3RlcHMuc29tZShwb1N0ZXAgPT4gcG9TdGVwLnN0YXR1cyA9PT0gUG9TdGVwcGVyU3RhdHVzLkFjdGl2ZSk7XHJcblxyXG4gICAgaWYgKHRoaXMudXNlUG9TdGVwcyAmJiAhaGFzU3RlcEFjdGl2ZSkge1xyXG4gICAgICB0aGlzLmNoYW5nZVN0ZXAoMCwgdGhpcy5wb1N0ZXBzLmZpcnN0KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgYWxsb3dOZXh0U3RlcChuZXh0U3RlcEluZGV4OiBudW1iZXIpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcclxuICAgIGlmICghdGhpcy5zZXF1ZW50aWFsKSB7XHJcbiAgICAgIHJldHVybiBvZih0cnVlKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBpc0FsbG93TmV4dFN0ZXAkID0gdGhpcy51c2VQb1N0ZXBzXHJcbiAgICAgID8gdGhpcy5pc0JlZm9yZVN0ZXAobmV4dFN0ZXBJbmRleCkgfHwgdGhpcy5jYW5BY3RpdmVOZXh0U3RlcCh0aGlzLmN1cnJlbnRBY3RpdmVTdGVwKVxyXG4gICAgICA6IHRoaXMuc3RlcHMuc2xpY2UodGhpcy5zdGVwLCBuZXh0U3RlcEluZGV4KS5ldmVyeShzdGVwID0+IHN0ZXAuc3RhdHVzID09PSBQb1N0ZXBwZXJTdGF0dXMuRG9uZSk7XHJcblxyXG4gICAgcmV0dXJuIHR5cGVvZiBpc0FsbG93TmV4dFN0ZXAkID09PSAnYm9vbGVhbicgPyBvZihpc0FsbG93TmV4dFN0ZXAkKSA6IGlzQWxsb3dOZXh0U3RlcCQ7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGNhbkFjdGl2ZU5leHRTdGVwKGN1cnJlbnRBY3RpdmVTdGVwID0gPFBvU3RlcENvbXBvbmVudD57fSk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgaWYgKCFjdXJyZW50QWN0aXZlU3RlcC5jYW5BY3RpdmVOZXh0U3RlcCkge1xyXG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY2FuQWN0aXZlTmV4dFN0ZXAgPSBjdXJyZW50QWN0aXZlU3RlcC5jYW5BY3RpdmVOZXh0U3RlcChjdXJyZW50QWN0aXZlU3RlcCk7XHJcblxyXG4gICAgY29uc3QgY2FuQWN0aXZlTmV4dFN0ZXAkID0gY2FuQWN0aXZlTmV4dFN0ZXAgaW5zdGFuY2VvZiBPYnNlcnZhYmxlID8gY2FuQWN0aXZlTmV4dFN0ZXAgOiBvZihjYW5BY3RpdmVOZXh0U3RlcCk7XHJcblxyXG4gICAgcmV0dXJuIGNhbkFjdGl2ZU5leHRTdGVwJC5waXBlKFxyXG4gICAgICB0YXAoaXNDYW5BY3RpdmVOZXh0U3RlcCA9PiB7XHJcbiAgICAgICAgY3VycmVudEFjdGl2ZVN0ZXAuc3RhdHVzID0gdGhpcy5nZXRTdGVwcGVyU3RhdHVzQnlDYW5BY3RpdmUoaXNDYW5BY3RpdmVOZXh0U3RlcCk7XHJcbiAgICAgIH0pLFxyXG4gICAgICBjYXRjaEVycm9yKGVyciA9PiB7XHJcbiAgICAgICAgY3VycmVudEFjdGl2ZVN0ZXAuc3RhdHVzID0gUG9TdGVwcGVyU3RhdHVzLkVycm9yO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnIpO1xyXG4gICAgICB9KVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY29udHJvbFN0ZXBzU3RhdHVzKHN0ZXBJbmRleDogbnVtYmVyLCBzdGVwOiBQb1N0ZXBDb21wb25lbnQpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLnVzZVBvU3RlcHMpIHtcclxuICAgICAgdGhpcy5zZXRTdGVwQXNBY3RpdmUoc3RlcCk7XHJcbiAgICAgIHRoaXMuc2V0TmV4dFN0ZXBBc0RlZmF1bHQoc3RlcCk7XHJcblxyXG4gICAgICBpZiAodGhpcy5pc0JlZm9yZVN0ZXAoc3RlcEluZGV4KSkge1xyXG4gICAgICAgIHRoaXMuc2V0RmluYWxTdGVwcGVyc0FzRGlzYWJsZWQoc3RlcEluZGV4KTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldFN0ZXBwZXJTdGF0dXNCeUNhbkFjdGl2ZShjYW5BY3RpdmVOZXh0U3RlcDogYm9vbGVhbik6IFBvU3RlcHBlclN0YXR1cyB7XHJcbiAgICByZXR1cm4gY2FuQWN0aXZlTmV4dFN0ZXAgPyBQb1N0ZXBwZXJTdGF0dXMuRG9uZSA6IFBvU3RlcHBlclN0YXR1cy5FcnJvcjtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0U3RlcHNBbmRJbmRleChzdGVwOiBQb1N0ZXBDb21wb25lbnQgPSA8YW55Pnt9KTogeyBzdGVwczogQXJyYXk8UG9TdGVwQ29tcG9uZW50Pjsgc3RlcEluZGV4OiBudW1iZXIgfSB7XHJcbiAgICBjb25zdCBzdGVwcyA9IHRoaXMuZ2V0UG9TdGVwcygpO1xyXG4gICAgY29uc3Qgc3RlcEluZGV4ID0gc3RlcHMuZmluZEluZGV4KHBvU3RlcCA9PiBwb1N0ZXAuaWQgPT09IHN0ZXAuaWQpO1xyXG5cclxuICAgIHJldHVybiB7IHN0ZXBzLCBzdGVwSW5kZXggfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0UG9TdGVwcygpOiBBcnJheTxQb1N0ZXBDb21wb25lbnQ+IHtcclxuICAgIHJldHVybiB0aGlzLnBvU3RlcHMudG9BcnJheSgpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBpc0JlZm9yZVN0ZXAoc3RlcEluZGV4OiBudW1iZXIpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGN1cnJlbnRBY3RpdmVTdGVwSW5kZXggPSAoKSA9PiB0aGlzLmdldFBvU3RlcHMoKS5maW5kSW5kZXgoc3RlcCA9PiBzdGVwLmlkID09PSB0aGlzLmN1cnJlbnRBY3RpdmVTdGVwLmlkKTtcclxuXHJcbiAgICByZXR1cm4gISF0aGlzLmN1cnJlbnRBY3RpdmVTdGVwICYmIGN1cnJlbnRBY3RpdmVTdGVwSW5kZXgoKSA+PSBzdGVwSW5kZXg7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldEZpbmFsU3RlcHBlcnNBc0Rpc2FibGVkKHN0ZXBJbmRleDogbnVtYmVyKTogdm9pZCB7XHJcbiAgICB0aGlzLmdldFBvU3RlcHMoKVxyXG4gICAgICAuZmlsdGVyKChzdGVwLCBpbmRleCkgPT4gc3RlcCAmJiBpbmRleCA+PSBzdGVwSW5kZXggKyAyKVxyXG4gICAgICAuZm9yRWFjaChzdGVwID0+IChzdGVwLnN0YXR1cyA9IFBvU3RlcHBlclN0YXR1cy5EaXNhYmxlZCkpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZXRTdGVwQXNBY3RpdmUoc3RlcDogUG9TdGVwQ29tcG9uZW50KTogdm9pZCB7XHJcbiAgICBzdGVwLnN0YXR1cyA9IFBvU3RlcHBlclN0YXR1cy5BY3RpdmU7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHNldE5leHRTdGVwQXNEZWZhdWx0KGN1cnJlbnRTdGVwOiBQb1N0ZXBDb21wb25lbnQpOiB2b2lkIHtcclxuICAgIGNvbnN0IHsgc3RlcHMsIHN0ZXBJbmRleCB9ID0gdGhpcy5nZXRTdGVwc0FuZEluZGV4KGN1cnJlbnRTdGVwKTtcclxuICAgIGNvbnN0IG5leHRJbmRleCA9IHN0ZXBJbmRleCArIDE7XHJcblxyXG4gICAgaWYgKG5leHRJbmRleCA8IHRoaXMucG9TdGVwcy5sZW5ndGgpIHtcclxuICAgICAgc3RlcHNbbmV4dEluZGV4XS5zdGF0dXMgPSBQb1N0ZXBwZXJTdGF0dXMuRGVmYXVsdDtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19
import { __rest } from "tslib";
import { EventEmitter, Input, Output, Directive } from '@angular/core';
import { convertToBoolean } from '../../utils/util';
const poTreeViewMaxLevel = 4;
/**
 * @description
 *
 * O componente fornece um modelo de visualização em árvore, possibilitando a visualização das informações de maneira
 * hierárquica, desta forma sendo possível utilizar até 4 níveis.
 *
 * Nele é possível navegar entre os itens através da tecla *tab*, permitindo expandir ou colapsar o item em foco
 * por meio das teclas *enter* e *space*.
 *
 * Além da navegação, o componente possibilita também a seleção dos itens do primeiro ao último nível, tanto de forma parcial como completa.
 *
 * O componente também possui eventos disparados ao marcar/desmarcar e expandir/colapsar os itens.
 */
export class PoTreeViewBaseComponent {
    constructor() {
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao colapsar um item.
         *
         * > Como parâmetro o componente envia o item colapsado.
         */
        this.collapsed = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao expandir um item.
         *
         * > Como parâmetro o componente envia o item expandido.
         */
        this.expanded = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao selecionar um item.
         *
         * > Como parâmetro o componente envia o item selecionado.
         */
        this.selected = new EventEmitter();
        /**
         * @optional
         *
         * @description
         *
         * Ação que será disparada ao desfazer a seleção de um item.
         *
         * > Como parâmetro o componente envia o item que foi desmarcado.
         */
        this.unselected = new EventEmitter();
        this._items = [];
        this._selectable = false;
    }
    /**
     * Lista de itens do tipo `PoTreeViewItem` que será renderizada pelo componente.
     */
    set items(value) {
        this._items = Array.isArray(value) ? this.getItemsByMaxLevel(value) : [];
    }
    get items() {
        return this._items;
    }
    /**
     * @optional
     *
     * @description
     *
     * Habilita uma caixa de seleção para selecionar e/ou desmarcar um item da lista.
     *
     * @default false
     */
    set selectable(value) {
        this._selectable = convertToBoolean(value);
    }
    get selectable() {
        return this._selectable;
    }
    emitExpanded(treeViewItem) {
        const event = treeViewItem.expanded ? 'expanded' : 'collapsed';
        this[event].emit(Object.assign({}, treeViewItem));
    }
    emitSelected(treeViewItem) {
        const event = treeViewItem.selected ? 'selected' : 'unselected';
        this.updateItemsOnSelect(treeViewItem);
        this[event].emit(Object.assign({}, treeViewItem));
    }
    addChildItemInParent(childItem, parentItem) {
        if (!parentItem.subItems) {
            parentItem.subItems = [];
        }
        parentItem.subItems.push(childItem);
    }
    // caso houver parentItem:
    //  - expande o parentItem caso o filho estiver expandido;
    //  - adiciona o childItem no parentItem;
    //  - marca o parentItem caso conter subItems marcodos ou nulos;
    // Se não conter parentItem, adiciona o childItem no items.
    addItem(items, childItem, parentItem) {
        if (parentItem) {
            this.expandParentItem(childItem, parentItem);
            this.addChildItemInParent(childItem, parentItem);
            this.selectItemBySubItems(parentItem);
            items.push(parentItem);
        }
        else {
            items.push(childItem);
        }
    }
    selectAllItems(items, isSelected) {
        items.forEach(item => {
            if (item.subItems) {
                this.selectAllItems(item.subItems, isSelected);
            }
            item.selected = isSelected;
        });
    }
    selectItemBySubItems(item) {
        item.selected = this.everyItemSelected(item.subItems);
    }
    // retornará:
    //  - true: se todos os items estiverem marcados;
    //  - null: se no minimo um item esteja marcado ou nullo (indeterminate)
    //  - false: caso não corresponda em nenhuma das opções acima, no caso, nenhum marcado ou nulo;
    everyItemSelected(items = []) {
        const itemsLength = items.length;
        const lengthCheckedItems = items.filter(item => item.selected).length;
        if (itemsLength && itemsLength === lengthCheckedItems) {
            return true;
        }
        const hasIndeterminateItems = items.filter(item => item.selected || item.selected === null).length;
        if (hasIndeterminateItems) {
            return null;
        }
        return false;
    }
    // expande o item pai caso o filho estiver expandido.
    expandParentItem(childItem, parentItem) {
        if (childItem.expanded) {
            parentItem.expanded = true;
        }
    }
    getItemsByMaxLevel(items = [], level = 0, parentItem, newItems = []) {
        items.forEach(item => {
            const { subItems } = item, currentItem = __rest(item, ["subItems"]);
            if (level === poTreeViewMaxLevel) {
                return;
            }
            if (Array.isArray(subItems)) {
                // caso um item pai iniciar selecionado, deve selecionar os filhos.
                if (currentItem.selected) {
                    this.selectAllItems(subItems, currentItem.selected);
                }
                this.getItemsByMaxLevel(subItems, ++level, currentItem);
                --level;
            }
            this.addItem(newItems, currentItem, parentItem);
        });
        return newItems;
    }
    getItemsWithParentSelected(items = [], parentItem, newItems = []) {
        items.forEach(item => {
            const { subItems } = item, currentItem = __rest(item, ["subItems"]);
            if (Array.isArray(subItems)) {
                this.getItemsWithParentSelected(subItems, currentItem);
            }
            this.addItem(newItems, currentItem, parentItem);
        });
        return newItems;
    }
    updateItemsOnSelect(selectedItem) {
        if (selectedItem.subItems) {
            this.selectAllItems(selectedItem.subItems, selectedItem.selected);
        }
        this._items = this.getItemsWithParentSelected(this.items);
    }
}
PoTreeViewBaseComponent.decorators = [
    { type: Directive }
];
PoTreeViewBaseComponent.propDecorators = {
    collapsed: [{ type: Output, args: ['p-collapsed',] }],
    expanded: [{ type: Output, args: ['p-expanded',] }],
    selected: [{ type: Output, args: ['p-selected',] }],
    unselected: [{ type: Output, args: ['p-unselected',] }],
    items: [{ type: Input, args: ['p-items',] }],
    selectable: [{ type: Input, args: ['p-selectable',] }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdHJlZS12aWV3LWJhc2UuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvdWkvc3JjL2xpYi9jb21wb25lbnRzL3BvLXRyZWUtdmlldy9wby10cmVlLXZpZXctYmFzZS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFdkUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFJcEQsTUFBTSxrQkFBa0IsR0FBRyxDQUFDLENBQUM7QUFFN0I7Ozs7Ozs7Ozs7OztHQVlHO0FBRUgsTUFBTSxPQUFPLHVCQUF1QjtJQURwQztRQUVFOzs7Ozs7OztXQVFHO1FBQ29CLGNBQVMsR0FBRyxJQUFJLFlBQVksRUFBa0IsQ0FBQztRQUV0RTs7Ozs7Ozs7V0FRRztRQUNtQixhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQWtCLENBQUM7UUFFcEU7Ozs7Ozs7O1dBUUc7UUFDbUIsYUFBUSxHQUFHLElBQUksWUFBWSxFQUFrQixDQUFDO1FBRXBFOzs7Ozs7OztXQVFHO1FBQ3FCLGVBQVUsR0FBRyxJQUFJLFlBQVksRUFBa0IsQ0FBQztRQUVoRSxXQUFNLEdBQTBCLEVBQUUsQ0FBQztRQUNuQyxnQkFBVyxHQUFZLEtBQUssQ0FBQztJQWtLdkMsQ0FBQztJQWhLQzs7T0FFRztJQUNILElBQXNCLEtBQUssQ0FBQyxLQUE0QjtRQUN0RCxJQUFJLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQzNFLENBQUM7SUFFRCxJQUFJLEtBQUs7UUFDUCxPQUFPLElBQUksQ0FBQyxNQUFN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RU8sMEJBQTBCLENBQUMsUUFBK0IsRUFBRSxFQUFFLFVBQTJCLEVBQUUsUUFBUSxHQUFHLEVBQUU7UUFDOUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNuQixNQUFNLEVBQUUsUUFBUSxLQUFxQixJQUFJLEVBQXBCLFdBQVcsVUFBSyxJQUFJLEVBQW5DLFlBQTRCLENBQU8sQ0FBQztZQUUxQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQzNCLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxRQUFRLEVBQUUsV0FBVyxDQUFDLENBQUM7YUFDeEQ7WUFFRCxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxXQUFXLEVBQUUsVUFBVSxDQUFDLENBQUM7UUFDbEQsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLFFBQVEsQ0FBQztJQUNsQixDQUFDO0lBRU8sbUJBQW1CLENBQUMsWUFBNEI7UUFDdEQsSUFBSSxZQUFZLENBQUMsUUFBUSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDbkU7UUFFRCxJQUFJLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDNUQsQ0FBQzs7O1lBaE5GLFNBQVM7Ozt3QkFXUCxNQUFNLFNBQUMsYUFBYTt1QkFXcEIsTUFBTSxTQUFDLFlBQVk7dUJBV25CLE1BQU0sU0FBQyxZQUFZO3lCQVduQixNQUFNLFNBQUMsY0FBYztvQkFRckIsS0FBSyxTQUFDLFNBQVM7eUJBaUJmLEtBQUssU0FBQyxjQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT3V0cHV0LCBEaXJlY3RpdmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IGNvbnZlcnRUb0Jvb2xlYW4gfSBmcm9tICcuLi8uLi91dGlscy91dGlsJztcclxuXHJcbmltcG9ydCB7IFBvVHJlZVZpZXdJdGVtIH0gZnJvbSAnLi9wby10cmVlLXZpZXctaXRlbS9wby10cmVlLXZpZXctaXRlbS5pbnRlcmZhY2UnO1xyXG5cclxuY29uc3QgcG9UcmVlVmlld01heExldmVsID0gNDtcclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICpcclxuICogTyBjb21wb25lbnRlIGZvcm5lY2UgdW0gbW9kZWxvIGRlIHZpc3VhbGl6YcOnw6NvIGVtIMOhcnZvcmUsIHBvc3NpYmlsaXRhbmRvIGEgdmlzdWFsaXphw6fDo28gZGFzIGluZm9ybWHDp8O1ZXMgZGUgbWFuZWlyYVxyXG4gKiBoaWVyw6FycXVpY2EsIGRlc3RhIGZvcm1hIHNlbmRvIHBvc3PDrXZlbCB1dGlsaXphciBhdMOpIDQgbsOtdmVpcy5cclxuICpcclxuICogTmVsZSDDqSBwb3Nzw612ZWwgbmF2ZWdhciBlbnRyZSBvcyBpdGVucyBhdHJhdsOpcyBkYSB0ZWNsYSAqdGFiKiwgcGVybWl0aW5kbyBleHBhbmRpciBvdSBjb2xhcHNhciBvIGl0ZW0gZW0gZm9jb1xyXG4gKiBwb3IgbWVpbyBkYXMgdGVjbGFzICplbnRlciogZSAqc3BhY2UqLlxyXG4gKlxyXG4gKiBBbMOpbSBkYSBuYXZlZ2HDp8OjbywgbyBjb21wb25lbnRlIHBvc3NpYmlsaXRhIHRhbWLDqW0gYSBzZWxlw6fDo28gZG9zIGl0ZW5zIGRvIHByaW1laXJvIGFvIMO6bHRpbW8gbsOtdmVsLCB0YW50byBkZSBmb3JtYSBwYXJjaWFsIGNvbW8gY29tcGxldGEuXHJcbiAqXHJcbiAqIE8gY29tcG9uZW50ZSB0YW1iw6ltIHBvc3N1aSBldmVudG9zIGRpc3BhcmFkb3MgYW8gbWFyY2FyL2Rlc21hcmNhciBlIGV4cGFuZGlyL2NvbGFwc2FyIG9zIGl0ZW5zLlxyXG4gKi9cclxuQERpcmVjdGl2ZSgpXHJcbmV4cG9ydCBjbGFzcyBQb1RyZWVWaWV3QmFzZUNvbXBvbmVudCB7XHJcbiAgLyoqXHJcbiAgICogQG9wdGlvbmFsXHJcbiAgICpcclxuICAgKiBAZGVzY3JpcHRpb25cclxuICAgKlxyXG4gICAqIEHDp8OjbyBxdWUgc2Vyw6EgZGlzcGFyYWRhIGFvIGNvbGFwc2FyIHVtIGl0ZW0uXHJcbiAgICpcclxuICAgKiA+IENvbW8gcGFyw6JtZXRybyBvIGNvbXBvbmVudGUgZW52aWEgbyBpdGVtIGNvbGFwc2Fkby5cclxuICAgKi9cclxuICBAT3V0cHV0KCdwLWNvbGxhcHNlZCcpIGNvbGxhcHNlZCA9IG5ldyBFdmVudEVtaXR0ZXI8UG9UcmVlVmlld0l0ZW0+KCk7XHJcblxyXG4gIC8qKlxyXG4gICAqIEBvcHRpb25hbFxyXG4gICAqXHJcbiAgICogQGRlc2NyaXB0aW9uXHJcbiAgICpcclxuICAgKiBBw6fDo28gcXVlIHNlcsOhIGRpc3BhcmFkYSBhbyBleHBhbmRpciB1bSBpdGVtLlxyXG4gICAqXHJcbiAgICogPiBDb21vIHBhcsOibWV0cm8gbyBjb21wb25lbnRlIGVudmlhIG8gaXRlbSBleHBhbmRpZG8uXHJcbiAgICovXHJcbiAgQE91dHB1dCgncC1leHBhbmRlZCcpIGV4cGFuZGVkID0gbmV3IEV2ZW50RW1pdHRlcjxQb1RyZWVWaWV3SXRlbT4oKTtcclxuXHJcbiAgLyoqXHJcbiAgICogQG9wdGlvbmFsXHJcbiAgICpcclxuICAgKiBAZGVzY3JpcHRpb25cclxuICAgKlxyXG4gICAqIEHDp8OjbyBxdWUgc2Vyw6EgZGlzcGFyYWRhIGFvIHNlbGVjaW9uYXIgdW0gaXRlbS5cclxuICAgKlxyXG4gICAqID4gQ29tbyBwYXLDom1ldHJvIG8gY29tcG9uZW50ZSBlbnZpYSBvIGl0ZW0gc2VsZWNpb25hZG8uXHJcbiAgICovXHJcbiAgQE91dHB1dCgncC1zZWxlY3RlZCcpIHNlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxQb1RyZWVWaWV3SXRlbT4oKTtcclxuXHJcbiAgLyoqXHJcbiAgICogQG9wdGlvbmFsXHJcbiAgICpcclxuICAgKiBAZGVzY3JpcHRpb25cclxuICAgKlxyXG4gICAqIEHDp8OjbyBxdWUgc2Vyw6EgZGlzcGFyYWRhIGFvIGRlc2ZhemVyIGEgc2VsZcOnw6NvIGRlIHVtIGl0ZW0uXHJcbiAgICpcclxuICAgKiA+IENvbW8gcGFyw6JtZXRybyBvIGNvbXBvbmVudGUgZW52aWEgbyBpdGVtIHF1ZSBmb2kgZGVzbWFyY2Fkby5cclxuICAgKi9cclxuICBAT3V0cHV0KCdwLXVuc2VsZWN0ZWQnKSB1bnNlbGVjdGVkID0gbmV3IEV2ZW50RW1pdHRlcjxQb1RyZWVWaWV3SXRlbT4oKTtcclxuXHJcbiAgcHJpdmF0ZSBfaXRlbXM6IEFycmF5PFBvVHJlZVZpZXdJdGVtPiA9IFtdO1xyXG4gIHByaXZhdGUgX3NlbGVjdGFibGU6IGJvb2xlYW4gPSBmYWxzZTtcclxuXHJcbiAgLyoqXHJcbiAgICogTGlzdGEgZGUgaXRlbnMgZG8gdGlwbyBgUG9UcmVlVmlld0l0ZW1gIHF1ZSBzZXLDoSByZW5kZXJpemFkYSBwZWxvIGNvbXBvbmVudGUuXHJcbiAgICovXHJcbiAgQElucHV0KCdwLWl0ZW1zJykgc2V0IGl0ZW1zKHZhbHVlOiBBcnJheTxQb1RyZWVWaWV3SXRlbT4pIHtcclxuICAgIHRoaXMuX2l0ZW1zID0gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyB0aGlzLmdldEl0ZW1zQnlNYXhMZXZlbCh2YWx1ZSkgOiBbXTtcclxuICB9XHJcblxyXG4gIGdldCBpdGVtcygpIHtcclxuICAgIHJldHVybiB0aGlzLl9pdGVtcztcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEBvcHRpb25hbFxyXG4gICAqXHJcbiAgICogQGRlc2NyaXB0aW9uXHJcbiAgICpcclxuICAgKiBIYWJpbGl0YSB1bWEgY2FpeGEgZGUgc2VsZcOnw6NvIHBhcmEgc2VsZWNpb25hciBlL291IGRlc21hcmNhciB1bSBpdGVtIGRhIGxpc3RhLlxyXG4gICAqXHJcbiAgICogQGRlZmF1bHQgZmFsc2VcclxuICAgKi9cclxuICBASW5wdXQoJ3Atc2VsZWN0YWJsZScpIHNldCBzZWxlY3RhYmxlKHZhbHVlOiBib29sZWFuKSB7XHJcbiAgICB0aGlzLl9zZWxlY3RhYmxlID0gY29udmVydFRvQm9vbGVhbih2YWx1ZSk7XHJcbiAgfVxyXG5cclxuICBnZXQgc2VsZWN0YWJsZSgpIHtcclxuICAgIHJldHVybiB0aGlzLl9zZWxlY3RhYmxlO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGVtaXRFeHBhbmRlZCh0cmVlVmlld0l0ZW06IFBvVHJlZVZpZXdJdGVtKSB7XHJcbiAgICBjb25zdCBldmVudCA9IHRyZWVWaWV3SXRlbS5leHBhbmRlZCA/ICdleHBhbmRlZCcgOiAnY29sbGFwc2VkJztcclxuXHJcbiAgICB0aGlzW2V2ZW50XS5lbWl0KHsgLi4udHJlZVZpZXdJdGVtIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGVtaXRTZWxlY3RlZCh0cmVlVmlld0l0ZW06IFBvVHJlZVZpZXdJdGVtKSB7XHJcbiAgICBjb25zdCBldmVudCA9IHRyZWVWaWV3SXRlbS5zZWxlY3RlZCA/ICdzZWxlY3RlZCcgOiAndW5zZWxlY3RlZCc7XHJcblxyXG4gICAgdGhpcy51cGRhdGVJdGVtc09uU2VsZWN0KHRyZWVWaWV3SXRlbSk7XHJcblxyXG4gICAgdGhpc1tldmVudF0uZW1pdCh7IC4uLnRyZWVWaWV3SXRlbSB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYWRkQ2hpbGRJdGVtSW5QYXJlbnQoY2hpbGRJdGVtOiBQb1RyZWVWaWV3SXRlbSwgcGFyZW50SXRlbTogUG9UcmVlVmlld0l0ZW0pIHtcclxuICAgIGlmICghcGFyZW50SXRlbS5zdWJJdGVtcykge1xyXG4gICAgICBwYXJlbnRJdGVtLnN1Ykl0ZW1zID0gW107XHJcbiAgICB9XHJcblxyXG4gICAgcGFyZW50SXRlbS5zdWJJdGVtcy5wdXNoKGNoaWxkSXRlbSk7XHJcbiAgfVxyXG5cclxuICAvLyBjYXNvIGhvdXZlciBwYXJlbnRJdGVtOlxyXG4gIC8vICAtIGV4cGFuZGUgbyBwYXJlbnRJdGVtIGNhc28gbyBmaWxobyBlc3RpdmVyIGV4cGFuZGlkbztcclxuICAvLyAgLSBhZGljaW9uYSBvIGNoaWxkSXRlbSBubyBwYXJlbnRJdGVtO1xyXG4gIC8vICAtIG1hcmNhIG8gcGFyZW50SXRlbSBjYXNvIGNvbnRlciBzdWJJdGVtcyBtYXJjb2RvcyBvdSBudWxvcztcclxuICAvLyBTZSBuw6NvIGNvbnRlciBwYXJlbnRJdGVtLCBhZGljaW9uYSBvIGNoaWxkSXRlbSBubyBpdGVtcy5cclxuICBwcml2YXRlIGFkZEl0ZW0oaXRlbXM6IEFycmF5PFBvVHJlZVZpZXdJdGVtPiwgY2hpbGRJdGVtOiBQb1RyZWVWaWV3SXRlbSwgcGFyZW50SXRlbT86IFBvVHJlZVZpZXdJdGVtKSB7XHJcbiAgICBpZiAocGFyZW50SXRlbSkge1xyXG4gICAgICB0aGlzLmV4cGFuZFBhcmVudEl0ZW0oY2hpbGRJdGVtLCBwYXJlbnRJdGVtKTtcclxuICAgICAgdGhpcy5hZGRDaGlsZEl0ZW1JblBhcmVudChjaGlsZEl0ZW0sIHBhcmVudEl0ZW0pO1xyXG4gICAgICB0aGlzLnNlbGVjdEl0ZW1CeVN1Ykl0ZW1zKHBhcmVudEl0ZW0pO1xyXG5cclxuICAgICAgaXRlbXMucHVzaChwYXJlbnRJdGVtKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGl0ZW1zLnB1c2goY2hpbGRJdGVtKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgc2VsZWN0QWxsSXRlbXMoaXRlbXM6IEFycmF5PFBvVHJlZVZpZXdJdGVtPiwgaXNTZWxlY3RlZDogYm9vbGVhbikge1xyXG4gICAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgaWYgKGl0ZW0uc3ViSXRlbXMpIHtcclxuICAgICAgICB0aGlzLnNlbGVjdEFsbEl0ZW1zKGl0ZW0uc3ViSXRlbXMsIGlzU2VsZWN0ZWQpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpdGVtLnNlbGVjdGVkID0gaXNTZWxlY3RlZDtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZWxlY3RJdGVtQnlTdWJJdGVtcyhpdGVtOiBQb1RyZWVWaWV3SXRlbSkge1xyXG4gICAgaXRlbS5zZWxlY3RlZCA9IHRoaXMuZXZlcnlJdGVtU2VsZWN0ZWQoaXRlbS5zdWJJdGVtcyk7XHJcbiAgfVxyXG5cclxuICAvLyByZXRvcm5hcsOhOlxyXG4gIC8vICAtIHRydWU6IHNlIHRvZG9zIG9zIGl0ZW1zIGVzdGl2ZXJlbSBtYXJjYWRvcztcclxuICAvLyAgLSBudWxsOiBzZSBubyBtaW5pbW8gdW0gaXRlbSBlc3RlamEgbWFyY2FkbyBvdSBudWxsbyAoaW5kZXRlcm1pbmF0ZSlcclxuICAvLyAgLSBmYWxzZTogY2FzbyBuw6NvIGNvcnJlc3BvbmRhIGVtIG5lbmh1bWEgZGFzIG9ww6fDtWVzIGFjaW1hLCBubyBjYXNvLCBuZW5odW0gbWFyY2FkbyBvdSBudWxvO1xyXG4gIHByaXZhdGUgZXZlcnlJdGVtU2VsZWN0ZWQoaXRlbXM6IEFycmF5PFBvVHJlZVZpZXdJdGVtPiA9IFtdKTogYm9vbGVhbiB8IG51bGwge1xyXG4gICAgY29uc3QgaXRlbXNMZW5ndGggPSBpdGVtcy5sZW5ndGg7XHJcblxyXG4gICAgY29uc3QgbGVuZ3RoQ2hlY2tlZEl0ZW1zID0gaXRlbXMuZmlsdGVyKGl0ZW0gPT4gaXRlbS5zZWxlY3RlZCkubGVuZ3RoO1xyXG5cclxuICAgIGlmIChpdGVtc0xlbmd0aCAmJiBpdGVtc0xlbmd0aCA9PT0gbGVuZ3RoQ2hlY2tlZEl0ZW1zKSB7XHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGhhc0luZGV0ZXJtaW5hdGVJdGVtcyA9IGl0ZW1zLmZpbHRlcihpdGVtID0+IGl0ZW0uc2VsZWN0ZWQgfHwgaXRlbS5zZWxlY3RlZCA9PT0gbnVsbCkubGVuZ3RoO1xyXG5cclxuICAgIGlmIChoYXNJbmRldGVybWluYXRlSXRlbXMpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgLy8gZXhwYW5kZSBvIGl0ZW0gcGFpIGNhc28gbyBmaWxobyBlc3RpdmVyIGV4cGFuZGlkby5cclxuICBwcml2YXRlIGV4cGFuZFBhcmVudEl0ZW0oY2hpbGRJdGVtOiBQb1RyZWVWaWV3SXRlbSwgcGFyZW50SXRlbTogUG9UcmVlVmlld0l0ZW0pIHtcclxuICAgIGlmIChjaGlsZEl0ZW0uZXhwYW5kZWQpIHtcclxuICAgICAgcGFyZW50SXRlbS5leHBhbmRlZCA9IHRydWU7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEl0ZW1zQnlNYXhMZXZlbChcclxuICAgIGl0ZW1zOiBBcnJheTxQb1RyZWVWaWV3SXRlbT4gPSBbXSxcclxuICAgIGxldmVsOiBudW1iZXIgPSAwLFxyXG4gICAgcGFyZW50SXRlbT86IFBvVHJlZVZpZXdJdGVtLFxyXG4gICAgbmV3SXRlbXMgPSBbXVxyXG4gICkge1xyXG4gICAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgY29uc3QgeyBzdWJJdGVtcywgLi4uY3VycmVudEl0ZW0gfSA9IGl0ZW07XHJcblxyXG4gICAgICBpZiAobGV2ZWwgPT09IHBvVHJlZVZpZXdNYXhMZXZlbCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc3ViSXRlbXMpKSB7XHJcbiAgICAgICAgLy8gY2FzbyB1bSBpdGVtIHBhaSBpbmljaWFyIHNlbGVjaW9uYWRvLCBkZXZlIHNlbGVjaW9uYXIgb3MgZmlsaG9zLlxyXG4gICAgICAgIGlmIChjdXJyZW50SXRlbS5zZWxlY3RlZCkge1xyXG4gICAgICAgICAgdGhpcy5zZWxlY3RBbGxJdGVtcyhzdWJJdGVtcywgY3VycmVudEl0ZW0uc2VsZWN0ZWQpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5nZXRJdGVtc0J5TWF4TGV2ZWwoc3ViSXRlbXMsICsrbGV2ZWwsIGN1cnJlbnRJdGVtKTtcclxuICAgICAgICAtLWxldmVsO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmFkZEl0ZW0obmV3SXRlbXMsIGN1cnJlbnRJdGVtLCBwYXJlbnRJdGVtKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBuZXdJdGVtcztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZ2V0SXRlbXNXaXRoUGFyZW50U2VsZWN0ZWQoaXRlbXM6IEFycmF5PFBvVHJlZVZpZXdJdGVtPiA9IFtdLCBwYXJlbnRJdGVtPzogUG9UcmVlVmlld0l0ZW0sIG5ld0l0ZW1zID0gW10pIHtcclxuICAgIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgIGNvbnN0IHsgc3ViSXRlbXMsIC4uLmN1cnJlbnRJdGVtIH0gPSBpdGVtO1xyXG5cclxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkoc3ViSXRlbXMpKSB7XHJcbiAgICAgICAgdGhpcy5nZXRJdGVtc1dpdGhQYXJlbnRTZWxlY3RlZChzdWJJdGVtcywgY3VycmVudEl0ZW0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICB0aGlzLmFkZEl0ZW0obmV3SXRlbXMsIGN1cnJlbnRJdGVtLCBwYXJlbnRJdGVtKTtcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBuZXdJdGVtcztcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdXBkYXRlSXRlbXNPblNlbGVjdChzZWxlY3RlZEl0ZW06IFBvVHJlZVZpZXdJdGVtKSB7XHJcbiAgICBpZiAoc2VsZWN0ZWRJdGVtLnN1Ykl0ZW1zKSB7XHJcbiAgICAgIHRoaXMuc2VsZWN0QWxsSXRlbXMoc2VsZWN0ZWRJdGVtLnN1Ykl0ZW1zLCBzZWxlY3RlZEl0ZW0uc2VsZWN0ZWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX2l0ZW1zID0gdGhpcy5nZXRJdGVtc1dpdGhQYXJlbnRTZWxlY3RlZCh0aGlzLml0ZW1zKTtcclxuICB9XHJcbn1cclxuIl19
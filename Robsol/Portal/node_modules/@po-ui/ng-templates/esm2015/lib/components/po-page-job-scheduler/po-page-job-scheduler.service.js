import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { map } from 'rxjs/operators';
import { addZero, convertDateToISOExtended } from '../../utils/util';
export class PoPageJobSchedulerService {
    constructor(http) {
        this.http = http;
        this.headers = new HttpHeaders({
            'X-PO-SCREEN-LOCK': 'true'
        });
        this.endpoint = '/';
    }
    configServiceApi(config = {}) {
        this.endpoint = config.endpoint;
    }
    // Cria um recurso
    createResource(resource) {
        const newResouce = this.convertToJobScheduler(resource);
        return this.http.post(`${this.endpoint}`, newResouce, { headers: this.headers });
    }
    getHeadProcesses() {
        const headers = { 'X-PO-No-Error': 'true' };
        return this.http.head(`${this.endpoint}/processes`, { headers });
    }
    // Busca parametros pelo processo id
    getParametersByProcess(processId) {
        return this.http
            .get(`${this.endpoint}/processes/${processId}/parameters`, { headers: this.headers })
            .pipe(map((resource) => resource.items));
    }
    // Busca um único recurso
    getProcess(id) {
        return this.http.get(`${this.endpoint}/processes/${id}`, { headers: this.headers });
    }
    // Busca uma lista de processos
    getProcesses(params = {}) {
        return this.http.get(`${this.endpoint}/processes`, { params });
    }
    // Busca um único recurso
    getResource(id) {
        return this.http
            .get(`${this.endpoint}/${id}`, { headers: this.headers })
            .pipe(map(resource => this.convertToJobSchedulerInternal(resource)));
    }
    // Atualiza um recurso
    updateResource(id, resource) {
        const newResouce = this.convertToJobScheduler(resource);
        return this.http.put(`${this.endpoint}/${id}`, newResouce, { headers: this.headers });
    }
    convertToJobScheduler(jobSchedulerInternal) {
        const jobScheduler = Object.assign({}, jobSchedulerInternal);
        if (jobSchedulerInternal.periodicity) {
            if (jobSchedulerInternal.periodicity === 'single') {
                jobScheduler.recurrent = false;
            }
            else {
                Object.assign(jobScheduler, this.convertToPeriodicity(jobSchedulerInternal));
            }
        }
        if (jobSchedulerInternal.firstExecutionHour) {
            jobScheduler.firstExecution = this.replaceHourFirstExecution(jobSchedulerInternal.firstExecution, jobSchedulerInternal.firstExecutionHour);
        }
        if (jobSchedulerInternal.frequency && jobSchedulerInternal.frequency.type) {
            jobScheduler.rangeExecutions = {
                frequency: Object.assign({}, jobSchedulerInternal.frequency)
            };
            if (jobSchedulerInternal.rangeLimitHour) {
                const splitRangeLimitHour = jobSchedulerInternal.rangeLimitHour.split(':');
                jobScheduler.rangeExecutions.rangeLimit = {
                    hour: parseInt(splitRangeLimitHour[0], 10),
                    minute: parseInt(splitRangeLimitHour[1], 10)
                };
            }
            if (jobSchedulerInternal.rangeLimitDay) {
                jobScheduler.rangeExecutions.rangeLimit = Object.assign(Object.assign({}, jobScheduler.rangeExecutions.rangeLimit), { day: jobSchedulerInternal.rangeLimitDay });
            }
        }
        if (!Object.keys(this.returnValidExecutionParameter(jobScheduler.executionParameter)).length) {
            delete jobScheduler.executionParameter;
        }
        this.removeInvalidKeys(jobScheduler);
        return jobScheduler;
    }
    convertToJobSchedulerInternal(jobScheduler = {}) {
        const jobSchedulerInternal = Object.assign({}, jobScheduler);
        if (jobScheduler.firstExecution) {
            jobSchedulerInternal.firstExecutionHour = this.getHourFirstExecution(jobScheduler.firstExecution);
        }
        Object.assign(jobSchedulerInternal, this.convertToPeriodicityInternal(jobScheduler));
        if (jobScheduler.rangeExecutions) {
            jobSchedulerInternal.rangeLimitHour = `${jobScheduler.rangeExecutions.rangeLimit.hour < 10
                ? '0' + jobScheduler.rangeExecutions.rangeLimit.hour
                : jobScheduler.rangeExecutions.rangeLimit.hour}:${jobScheduler.rangeExecutions.rangeLimit.minute < 10
                ? '0' + jobScheduler.rangeExecutions.rangeLimit.minute
                : jobScheduler.rangeExecutions.rangeLimit.minute}`;
            jobSchedulerInternal.rangeLimitDay = jobScheduler.rangeExecutions.rangeLimit.day;
            jobSchedulerInternal.frequency = {
                type: jobScheduler.rangeExecutions.frequency.type,
                value: jobScheduler.rangeExecutions.frequency.value
            };
        }
        this.removeInvalidKeys(jobSchedulerInternal, ['weekly', 'monthly', 'daily']);
        return jobSchedulerInternal;
    }
    convertToPeriodicity(value) {
        const newValue = {};
        const valuePeriodicity = value.periodicity;
        if (valuePeriodicity) {
            newValue[valuePeriodicity] = {};
            if (valuePeriodicity === 'monthly') {
                newValue[valuePeriodicity].day = value.dayOfMonth ? parseInt(value.dayOfMonth, 10) : 0;
            }
            else if (valuePeriodicity === 'weekly') {
                newValue[valuePeriodicity].daysOfWeek = value.daysOfWeek;
            }
            newValue[valuePeriodicity].hour = value.hour ? parseInt(value.hour.split(':')[0], 10) : 0;
            newValue[valuePeriodicity].minute = value.hour ? parseInt(value.hour.split(':')[1], 10) : 0;
        }
        return newValue;
    }
    convertToPeriodicityInternal(value = {}) {
        if (value.monthly) {
            return {
                periodicity: 'monthly',
                hour: `${addZero(value.monthly.hour)}:${addZero(value.monthly.minute)}`,
                dayOfMonth: value.monthly.day
            };
        }
        else if (value.daily) {
            return {
                periodicity: 'daily',
                hour: `${addZero(value.daily.hour)}:${addZero(value.daily.minute)}`
            };
        }
        else if (value.weekly) {
            return {
                periodicity: 'weekly',
                hour: `${addZero(value.weekly.hour)}:${addZero(value.weekly.minute)}`,
                daysOfWeek: [...value.weekly.daysOfWeek]
            };
        }
        else {
            return {
                periodicity: 'single'
            };
        }
    }
    getCurrentHour(date) {
        const hours = addZero(date.getHours());
        const minutes = addZero(date.getMinutes());
        return `${hours}:${minutes}`;
    }
    getHourFirstExecution(firstExecutionDate) {
        return this.getCurrentHour(new Date(firstExecutionDate));
    }
    removeInvalidKeys(value, keys) {
        const invalidKeys = keys || [
            'periodicity',
            'hour',
            'minute',
            'day',
            'daysOfWeek',
            'dayOfMonth',
            'firstExecutionHour',
            'frequency',
            'rangeLimitHour',
            'rangeLimitDay'
        ];
        Object.keys(value).forEach(key => {
            if (invalidKeys.includes(key)) {
                delete value[key];
            }
            else if (key === 'rangeExecutions' && value['periodicity'] === 'single') {
                delete value[key];
            }
        });
    }
    replaceHourFirstExecution(date, time) {
        const firstExecutionDate = new Date(date);
        const timeSplited = time.split(':');
        const hours = parseInt(timeSplited[0], 10);
        const minutes = parseInt(timeSplited[1], 10);
        firstExecutionDate.setHours(hours, minutes);
        return convertDateToISOExtended(firstExecutionDate);
    }
    returnValidExecutionParameter(parameter) {
        const newParameter = Object.assign({}, parameter);
        for (const key in newParameter) {
            if (newParameter.hasOwnProperty(key) && newParameter[key] === undefined) {
                delete newParameter[key];
            }
        }
        return newParameter;
    }
}
PoPageJobSchedulerService.decorators = [
    { type: Injectable }
];
PoPageJobSchedulerService.ctorParameters = () => [
    { type: HttpClient }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcGFnZS1qb2Itc2NoZWR1bGVyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy90ZW1wbGF0ZXMvc3JjL2xpYi9jb21wb25lbnRzL3BvLXBhZ2Utam9iLXNjaGVkdWxlci9wby1wYWdlLWpvYi1zY2hlZHVsZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHM0MsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXJDLE9BQU8sRUFBRSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQU9yRSxNQUFNLE9BQU8seUJBQXlCO0lBT3BDLFlBQW9CLElBQWdCO1FBQWhCLFNBQUksR0FBSixJQUFJLENBQVk7UUFOM0IsWUFBTyxHQUFnQixJQUFJLFdBQVcsQ0FBQztZQUM5QyxrQkFBa0IsRUFBRSxNQUFNO1NBQzNCLENBQUMsQ0FBQztRQUVLLGFBQVEsR0FBRyxHQUFHLENBQUM7SUFFZ0IsQ0FBQztJQUV4QyxnQkFBZ0IsQ0FBQyxTQUFnQyxFQUFFO1FBQ2pELElBQUksQ0FBQyxRQUFRLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQztJQUNsQyxDQUFDO0lBRUQsa0JBQWtCO0lBQ2xCLGNBQWMsQ0FBQyxRQUFRO1FBQ3JCLE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUV4RCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLFVBQVUsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztJQUNuRixDQUFDO0lB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QUksWUFBWSxDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxZQUFZLENBQUMsR0FBRyxDQUFDLEtBQUssU0FBUyxFQUFFO2dCQUN2RSxPQUFPLFlBQVksQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUMxQjtTQUNGO1FBRUQsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQzs7O1lBcFBGLFVBQVU7OztZQVpGLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5cclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBhZGRaZXJvLCBjb252ZXJ0RGF0ZVRvSVNPRXh0ZW5kZWQgfSBmcm9tICcuLi8uLi91dGlscy91dGlsJztcclxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUZpZWxkIH0gZnJvbSAnQHBvLXVpL25nLWNvbXBvbmVudHMnO1xyXG5cclxuaW1wb3J0IHsgUG9Kb2JTY2hlZHVsZXIgfSBmcm9tICcuL2ludGVyZmFjZXMvcG8tam9iLXNjaGVkdWxlci5pbnRlcmZhY2UnO1xyXG5pbXBvcnQgeyBQb0pvYlNjaGVkdWxlckludGVybmFsIH0gZnJvbSAnLi9pbnRlcmZhY2VzL3BvLWpvYi1zY2hlZHVsZXItaW50ZXJuYWwuaW50ZXJmYWNlJztcclxuXHJcbkBJbmplY3RhYmxlKClcclxuZXhwb3J0IGNsYXNzIFBvUGFnZUpvYlNjaGVkdWxlclNlcnZpY2Uge1xyXG4gIHJlYWRvbmx5IGhlYWRlcnM6IEh0dHBIZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHtcclxuICAgICdYLVBPLVNDUkVFTi1MT0NLJzogJ3RydWUnXHJcbiAgfSk7XHJcblxyXG4gIHByaXZhdGUgZW5kcG9pbnQgPSAnLyc7XHJcblxyXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCkge31cclxuXHJcbiAgY29uZmlnU2VydmljZUFwaShjb25maWc6IHsgZW5kcG9pbnQ/OiBzdHJpbmcgfSA9IHt9KSB7XHJcbiAgICB0aGlzLmVuZHBvaW50ID0gY29uZmlnLmVuZHBvaW50O1xyXG4gIH1cclxuXHJcbiAgLy8gQ3JpYSB1bSByZWN1cnNvXHJcbiAgY3JlYXRlUmVzb3VyY2UocmVzb3VyY2UpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgY29uc3QgbmV3UmVzb3VjZSA9IHRoaXMuY29udmVydFRvSm9iU2NoZWR1bGVyKHJlc291cmNlKTtcclxuXHJcbiAgICByZXR1cm4gdGhpcy5odHRwLnBvc3QoYCR7dGhpcy5lbmRwb2ludH1gLCBuZXdSZXNvdWNlLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KTtcclxuICB9XHJcblxyXG4gIGdldEhlYWRQcm9jZXNzZXMoKSB7XHJcbiAgICBjb25zdCBoZWFkZXJzID0geyAnWC1QTy1Oby1FcnJvcic6ICd0cnVlJyB9O1xyXG5cclxuICAgIHJldHVybiB0aGlzLmh0dHAuaGVhZChgJHt0aGlzLmVuZHBvaW50fS9wcm9jZXNzZXNgLCB7IGhlYWRlcnMgfSk7XHJcbiAgfVxyXG5cclxuICAvLyBCdXNjYSBwYXJhbWV0cm9zIHBlbG8gcHJvY2Vzc28gaWRcclxuICBnZXRQYXJhbWV0ZXJzQnlQcm9jZXNzKHByb2Nlc3NJZDogc3RyaW5nIHwgbnVtYmVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLmh0dHBcclxuICAgICAgLmdldChgJHt0aGlzLmVuZHBvaW50fS9wcm9jZXNzZXMvJHtwcm9jZXNzSWR9L3BhcmFtZXRlcnNgLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KVxyXG4gICAgICAucGlwZShtYXAoKHJlc291cmNlOiB7IGl0ZW1zOiBBcnJheTxQb0R5bmFtaWNGb3JtRmllbGQ+IH0pID0+IHJlc291cmNlLml0ZW1zKSk7XHJcbiAgfVxyXG5cclxuICAvLyBCdXNjYSB1bSDDum5pY28gcmVjdXJzb1xyXG4gIGdldFByb2Nlc3MoaWQ6IHN0cmluZyB8IG51bWJlcik6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICByZXR1cm4gdGhpcy5odHRwLmdldChgJHt0aGlzLmVuZHBvaW50fS9wcm9jZXNzZXMvJHtpZH1gLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KTtcclxuICB9XHJcblxyXG4gIC8vIEJ1c2NhIHVtYSBsaXN0YSBkZSBwcm9jZXNzb3NcclxuICBnZXRQcm9jZXNzZXMocGFyYW1zOiB7fSA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KGAke3RoaXMuZW5kcG9pbnR9L3Byb2Nlc3Nlc2AsIHsgcGFyYW1zIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gQnVzY2EgdW0gw7puaWNvIHJlY3Vyc29cclxuICBnZXRSZXNvdXJjZShpZDogc3RyaW5nIHwgbnVtYmVyKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiB0aGlzLmh0dHBcclxuICAgICAgLmdldChgJHt0aGlzLmVuZHBvaW50fS8ke2lkfWAsIHsgaGVhZGVyczogdGhpcy5oZWFkZXJzIH0pXHJcbiAgICAgIC5waXBlKG1hcChyZXNvdXJjZSA9PiB0aGlzLmNvbnZlcnRUb0pvYlNjaGVkdWxlckludGVybmFsKHJlc291cmNlKSkpO1xyXG4gIH1cclxuXHJcbiAgLy8gQXR1YWxpemEgdW0gcmVjdXJzb1xyXG4gIHVwZGF0ZVJlc291cmNlKGlkLCByZXNvdXJjZSk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICBjb25zdCBuZXdSZXNvdWNlID0gdGhpcy5jb252ZXJ0VG9Kb2JTY2hlZHVsZXIocmVzb3VyY2UpO1xyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wdXQoYCR7dGhpcy5lbmRwb2ludH0vJHtpZH1gLCBuZXdSZXNvdWNlLCB7IGhlYWRlcnM6IHRoaXMuaGVhZGVycyB9KTtcclxuICB9XHJcblxyXG4gIGNvbnZlcnRUb0pvYlNjaGVkdWxlcihqb2JTY2hlZHVsZXJJbnRlcm5hbCk6IFBvSm9iU2NoZWR1bGVyIHtcclxuICAgIGNvbnN0IGpvYlNjaGVkdWxlciA9IHsgLi4uam9iU2NoZWR1bGVySW50ZXJuYWwgfTtcclxuXHJcbiAgICBpZiAoam9iU2NoZWR1bGVySW50ZXJuYWwucGVyaW9kaWNpdHkpIHtcclxuICAgICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLnBlcmlvZGljaXR5ID09PSAnc2luZ2xlJykge1xyXG4gICAgICAgIGpvYlNjaGVkdWxlci5yZWN1cnJlbnQgPSBmYWxzZTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBPYmplY3QuYXNzaWduKGpvYlNjaGVkdWxlciwgdGhpcy5jb252ZXJ0VG9QZXJpb2RpY2l0eShqb2JTY2hlZHVsZXJJbnRlcm5hbCkpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLmZpcnN0RXhlY3V0aW9uSG91cikge1xyXG4gICAgICBqb2JTY2hlZHVsZXIuZmlyc3RFeGVjdXRpb24gPSB0aGlzLnJlcGxhY2VIb3VyRmlyc3RFeGVjdXRpb24oXHJcbiAgICAgICAgam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb24sXHJcbiAgICAgICAgam9iU2NoZWR1bGVySW50ZXJuYWwuZmlyc3RFeGVjdXRpb25Ib3VyXHJcbiAgICAgICk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLmZyZXF1ZW5jeSAmJiBqb2JTY2hlZHVsZXJJbnRlcm5hbC5mcmVxdWVuY3kudHlwZSkge1xyXG4gICAgICBqb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zID0ge1xyXG4gICAgICAgIGZyZXF1ZW5jeTogeyAuLi5qb2JTY2hlZHVsZXJJbnRlcm5hbC5mcmVxdWVuY3kgfVxyXG4gICAgICB9O1xyXG5cclxuICAgICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLnJhbmdlTGltaXRIb3VyKSB7XHJcbiAgICAgICAgY29uc3Qgc3BsaXRSYW5nZUxpbWl0SG91ciA9IGpvYlNjaGVkdWxlckludGVybmFsLnJhbmdlTGltaXRIb3VyLnNwbGl0KCc6Jyk7XHJcblxyXG4gICAgICAgIGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdCA9IHtcclxuICAgICAgICAgIGhvdXI6IHBhcnNlSW50KHNwbGl0UmFuZ2VMaW1pdEhvdXJbMF0sIDEwKSxcclxuICAgICAgICAgIG1pbnV0ZTogcGFyc2VJbnQoc3BsaXRSYW5nZUxpbWl0SG91clsxXSwgMTApXHJcbiAgICAgICAgfTtcclxuICAgICAgfVxyXG5cclxuICAgICAgaWYgKGpvYlNjaGVkdWxlckludGVybmFsLnJhbmdlTGltaXREYXkpIHtcclxuICAgICAgICBqb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zLnJhbmdlTGltaXQgPSB7XHJcbiAgICAgICAgICAuLi5qb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zLnJhbmdlTGltaXQsXHJcbiAgICAgICAgICBkYXk6IGpvYlNjaGVkdWxlckludGVybmFsLnJhbmdlTGltaXREYXlcclxuICAgICAgICB9O1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKCFPYmplY3Qua2V5cyh0aGlzLnJldHVyblZhbGlkRXhlY3V0aW9uUGFyYW1ldGVyKGpvYlNjaGVkdWxlci5leGVjdXRpb25QYXJhbWV0ZXIpKS5sZW5ndGgpIHtcclxuICAgICAgZGVsZXRlIGpvYlNjaGVkdWxlci5leGVjdXRpb25QYXJhbWV0ZXI7XHJcbiAgICB9XHJcblxyXG4gICAgdGhpcy5yZW1vdmVJbnZhbGlkS2V5cyhqb2JTY2hlZHVsZXIpO1xyXG5cclxuICAgIHJldHVybiBqb2JTY2hlZHVsZXI7XHJcbiAgfVxyXG5cclxuICBjb252ZXJ0VG9Kb2JTY2hlZHVsZXJJbnRlcm5hbChqb2JTY2hlZHVsZXIgPSA8YW55Pnt9KTogUG9Kb2JTY2hlZHVsZXJJbnRlcm5hbCB7XHJcbiAgICBjb25zdCBqb2JTY2hlZHVsZXJJbnRlcm5hbCA9IHsgLi4uam9iU2NoZWR1bGVyIH07XHJcblxyXG4gICAgaWYgKGpvYlNjaGVkdWxlci5maXJzdEV4ZWN1dGlvbikge1xyXG4gICAgICBqb2JTY2hlZHVsZXJJbnRlcm5hbC5maXJzdEV4ZWN1dGlvbkhvdXIgPSB0aGlzLmdldEhvdXJGaXJzdEV4ZWN1dGlvbihqb2JTY2hlZHVsZXIuZmlyc3RFeGVjdXRpb24pO1xyXG4gICAgfVxyXG5cclxuICAgIE9iamVjdC5hc3NpZ24oam9iU2NoZWR1bGVySW50ZXJuYWwsIHRoaXMuY29udmVydFRvUGVyaW9kaWNpdHlJbnRlcm5hbChqb2JTY2hlZHVsZXIpKTtcclxuXHJcbiAgICBpZiAoam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucykge1xyXG4gICAgICBqb2JTY2hlZHVsZXJJbnRlcm5hbC5yYW5nZUxpbWl0SG91ciA9IGAke1xyXG4gICAgICAgIGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdC5ob3VyIDwgMTBcclxuICAgICAgICAgID8gJzAnICsgam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5yYW5nZUxpbWl0LmhvdXJcclxuICAgICAgICAgIDogam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5yYW5nZUxpbWl0LmhvdXJcclxuICAgICAgfToke1xyXG4gICAgICAgIGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdC5taW51dGUgPCAxMFxyXG4gICAgICAgICAgPyAnMCcgKyBqb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zLnJhbmdlTGltaXQubWludXRlXHJcbiAgICAgICAgICA6IGpvYlNjaGVkdWxlci5yYW5nZUV4ZWN1dGlvbnMucmFuZ2VMaW1pdC5taW51dGVcclxuICAgICAgfWA7XHJcbiAgICAgIGpvYlNjaGVkdWxlckludGVybmFsLnJhbmdlTGltaXREYXkgPSBqb2JTY2hlZHVsZXIucmFuZ2VFeGVjdXRpb25zLnJhbmdlTGltaXQuZGF5O1xyXG4gICAgICBqb2JTY2hlZHVsZXJJbnRlcm5hbC5mcmVxdWVuY3kgPSB7XHJcbiAgICAgICAgdHlwZTogam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5mcmVxdWVuY3kudHlwZSxcclxuICAgICAgICB2YWx1ZTogam9iU2NoZWR1bGVyLnJhbmdlRXhlY3V0aW9ucy5mcmVxdWVuY3kudmFsdWVcclxuICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICB0aGlzLnJlbW92ZUludmFsaWRLZXlzKGpvYlNjaGVkdWxlckludGVybmFsLCBbJ3dlZWtseScsICdtb250aGx5JywgJ2RhaWx5J10pO1xyXG5cclxuICAgIHJldHVybiBqb2JTY2hlZHVsZXJJbnRlcm5hbDtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY29udmVydFRvUGVyaW9kaWNpdHkodmFsdWU6IHtcclxuICAgIHBlcmlvZGljaXR5OiBzdHJpbmc7XHJcbiAgICBkYXlPZk1vbnRoPzogc3RyaW5nO1xyXG4gICAgZGF5c09mV2Vlaz86IG51bWJlcjtcclxuICAgIGhvdXI/OiBzdHJpbmc7XHJcbiAgfSkge1xyXG4gICAgY29uc3QgbmV3VmFsdWUgPSB7fTtcclxuICAgIGNvbnN0IHZhbHVlUGVyaW9kaWNpdHkgPSB2YWx1ZS5wZXJpb2RpY2l0eTtcclxuXHJcbiAgICBpZiAodmFsdWVQZXJpb2RpY2l0eSkge1xyXG4gICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XSA9IHt9O1xyXG5cclxuICAgICAgaWYgKHZhbHVlUGVyaW9kaWNpdHkgPT09ICdtb250aGx5Jykge1xyXG4gICAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLmRheSA9IHZhbHVlLmRheU9mTW9udGggPyBwYXJzZUludCh2YWx1ZS5kYXlPZk1vbnRoLCAxMCkgOiAwO1xyXG4gICAgICB9IGVsc2UgaWYgKHZhbHVlUGVyaW9kaWNpdHkgPT09ICd3ZWVrbHknKSB7XHJcbiAgICAgICAgbmV3VmFsdWVbdmFsdWVQZXJpb2RpY2l0eV0uZGF5c09mV2VlayA9IHZhbHVlLmRheXNPZldlZWs7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIG5ld1ZhbHVlW3ZhbHVlUGVyaW9kaWNpdHldLmhvdXIgPSB2YWx1ZS5ob3VyID8gcGFyc2VJbnQodmFsdWUuaG91ci5zcGxpdCgnOicpWzBdLCAxMCkgOiAwO1xyXG4gICAgICBuZXdWYWx1ZVt2YWx1ZVBlcmlvZGljaXR5XS5taW51dGUgPSB2YWx1ZS5ob3VyID8gcGFyc2VJbnQodmFsdWUuaG91ci5zcGxpdCgnOicpWzFdLCAxMCkgOiAwO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBuZXdWYWx1ZTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY29udmVydFRvUGVyaW9kaWNpdHlJbnRlcm5hbCh2YWx1ZSA9IDxhbnk+e30pIHtcclxuICAgIGlmICh2YWx1ZS5tb250aGx5KSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgcGVyaW9kaWNpdHk6ICdtb250aGx5JyxcclxuICAgICAgICBob3VyOiBgJHthZGRaZXJvKHZhbHVlLm1vbnRobHkuaG91cil9OiR7YWRkWmVybyh2YWx1ZS5tb250aGx5Lm1pbnV0ZSl9YCxcclxuICAgICAgICBkYXlPZk1vbnRoOiB2YWx1ZS5tb250aGx5LmRheVxyXG4gICAgICB9O1xyXG4gICAgfSBlbHNlIGlmICh2YWx1ZS5kYWlseSkge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHBlcmlvZGljaXR5OiAnZGFpbHknLFxyXG4gICAgICAgIGhvdXI6IGAke2FkZFplcm8odmFsdWUuZGFpbHkuaG91cil9OiR7YWRkWmVybyh2YWx1ZS5kYWlseS5taW51dGUpfWBcclxuICAgICAgfTtcclxuICAgIH0gZWxzZSBpZiAodmFsdWUud2Vla2x5KSB7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgcGVyaW9kaWNpdHk6ICd3ZWVrbHknLFxyXG4gICAgICAgIGhvdXI6IGAke2FkZFplcm8odmFsdWUud2Vla2x5LmhvdXIpfToke2FkZFplcm8odmFsdWUud2Vla2x5Lm1pbnV0ZSl9YCxcclxuICAgICAgICBkYXlzT2ZXZWVrOiBbLi4udmFsdWUud2Vla2x5LmRheXNPZldlZWtdXHJcbiAgICAgIH07XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIHBlcmlvZGljaXR5OiAnc2luZ2xlJ1xyXG4gICAgICB9O1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRDdXJyZW50SG91cihkYXRlOiBEYXRlKTogc3RyaW5nIHtcclxuICAgIGNvbnN0IGhvdXJzID0gYWRkWmVybyhkYXRlLmdldEhvdXJzKCkpO1xyXG4gICAgY29uc3QgbWludXRlcyA9IGFkZFplcm8oZGF0ZS5nZXRNaW51dGVzKCkpO1xyXG5cclxuICAgIHJldHVybiBgJHtob3Vyc306JHttaW51dGVzfWA7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGdldEhvdXJGaXJzdEV4ZWN1dGlvbihmaXJzdEV4ZWN1dGlvbkRhdGU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICByZXR1cm4gdGhpcy5nZXRDdXJyZW50SG91cihuZXcgRGF0ZShmaXJzdEV4ZWN1dGlvbkRhdGUpKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVtb3ZlSW52YWxpZEtleXModmFsdWU6IG9iamVjdCwga2V5cz86IEFycmF5PHN0cmluZz4pIHtcclxuICAgIGNvbnN0IGludmFsaWRLZXlzID0ga2V5cyB8fCBbXHJcbiAgICAgICdwZXJpb2RpY2l0eScsXHJcbiAgICAgICdob3VyJyxcclxuICAgICAgJ21pbnV0ZScsXHJcbiAgICAgICdkYXknLFxyXG4gICAgICAnZGF5c09mV2VlaycsXHJcbiAgICAgICdkYXlPZk1vbnRoJyxcclxuICAgICAgJ2ZpcnN0RXhlY3V0aW9uSG91cicsXHJcbiAgICAgICdmcmVxdWVuY3knLFxyXG4gICAgICAncmFuZ2VMaW1pdEhvdXInLFxyXG4gICAgICAncmFuZ2VMaW1pdERheSdcclxuICAgIF07XHJcblxyXG4gICAgT2JqZWN0LmtleXModmFsdWUpLmZvckVhY2goa2V5ID0+IHtcclxuICAgICAgaWYgKGludmFsaWRLZXlzLmluY2x1ZGVzKGtleSkpIHtcclxuICAgICAgICBkZWxldGUgdmFsdWVba2V5XTtcclxuICAgICAgfSBlbHNlIGlmIChrZXkgPT09ICdyYW5nZUV4ZWN1dGlvbnMnICYmIHZhbHVlWydwZXJpb2RpY2l0eSddID09PSAnc2luZ2xlJykge1xyXG4gICAgICAgIGRlbGV0ZSB2YWx1ZVtrZXldO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmVwbGFjZUhvdXJGaXJzdEV4ZWN1dGlvbihkYXRlOiBzdHJpbmcsIHRpbWU6IHN0cmluZyk6IHN0cmluZyB7XHJcbiAgICBjb25zdCBmaXJzdEV4ZWN1dGlvbkRhdGUgPSBuZXcgRGF0ZShkYXRlKTtcclxuXHJcbiAgICBjb25zdCB0aW1lU3BsaXRlZCA9IHRpbWUuc3BsaXQoJzonKTtcclxuXHJcbiAgICBjb25zdCBob3VycyA9IHBhcnNlSW50KHRpbWVTcGxpdGVkWzBdLCAxMCk7XHJcbiAgICBjb25zdCBtaW51dGVzID0gcGFyc2VJbnQodGltZVNwbGl0ZWRbMV0sIDEwKTtcclxuXHJcbiAgICBmaXJzdEV4ZWN1dGlvbkRhdGUuc2V0SG91cnMoaG91cnMsIG1pbnV0ZXMpO1xyXG5cclxuICAgIHJldHVybiBjb252ZXJ0RGF0ZVRvSVNPRXh0ZW5kZWQoZmlyc3RFeGVjdXRpb25EYXRlKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgcmV0dXJuVmFsaWRFeGVjdXRpb25QYXJhbWV0ZXIocGFyYW1ldGVyOiBvYmplY3QpIHtcclxuICAgIGNvbnN0IG5ld1BhcmFtZXRlciA9IHsgLi4ucGFyYW1ldGVyIH07XHJcblxyXG4gICAgZm9yIChjb25zdCBrZXkgaW4gbmV3UGFyYW1ldGVyKSB7XHJcbiAgICAgIGlmIChuZXdQYXJhbWV0ZXIuaGFzT3duUHJvcGVydHkoa2V5KSAmJiBuZXdQYXJhbWV0ZXJba2V5XSA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgZGVsZXRlIG5ld1BhcmFtZXRlcltrZXldO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ld1BhcmFtZXRlcjtcclxuICB9XHJcbn1cclxuIl19